class w{constructor(t=0,o="Network Error"){this.status=t,this.text=o}}const U=()=>{if(!(typeof localStorage>"u"))return{get:e=>Promise.resolve(localStorage.getItem(e)),set:(e,t)=>Promise.resolve(localStorage.setItem(e,t)),remove:e=>Promise.resolve(localStorage.removeItem(e))}},s={origin:"https://api.emailjs.com",blockHeadless:!1,storageProvider:U()},L=e=>e?typeof e=="string"?{publicKey:e}:e.toString()==="[object Object]"?e:{}:{},J=(e,t="https://api.emailjs.com")=>{if(!e)return;const o=L(e);s.publicKey=o.publicKey,s.blockHeadless=o.blockHeadless,s.storageProvider=o.storageProvider,s.blockList=o.blockList,s.limitRate=o.limitRate,s.origin=o.origin||t},C=async(e,t,o={})=>{const r=await fetch(s.origin+e,{method:"POST",headers:o,body:t}),a=await r.text(),n=new w(r.status,a);if(r.ok)return n;throw n},D=(e,t,o)=>{if(!e||typeof e!="string")throw"The public key is required. Visit https://dashboard.emailjs.com/admin/account";if(!t||typeof t!="string")throw"The service ID is required. Visit https://dashboard.emailjs.com/admin";if(!o||typeof o!="string")throw"The template ID is required. Visit https://dashboard.emailjs.com/admin/templates"},z=e=>{if(e&&e.toString()!=="[object Object]")throw"The template params have to be the object. Visit https://www.emailjs.com/docs/sdk/send/"},F=e=>e.webdriver||!e.languages||e.languages.length===0,B=()=>new w(451,"Unavailable For Headless Browser"),$=(e,t)=>{if(!Array.isArray(e))throw"The BlockList list has to be an array";if(typeof t!="string")throw"The BlockList watchVariable has to be a string"},G=e=>{var t;return!((t=e.list)!=null&&t.length)||!e.watchVariable},W=(e,t)=>e instanceof FormData?e.get(t):e[t],q=(e,t)=>{if(G(e))return!1;$(e.list,e.watchVariable);const o=W(t,e.watchVariable);return typeof o!="string"?!1:e.list.includes(o)},O=()=>new w(403,"Forbidden"),X=(e,t)=>{if(typeof e!="number"||e<0)throw"The LimitRate throttle has to be a positive number";if(t&&typeof t!="string")throw"The LimitRate ID has to be a non-empty string"},Y=async(e,t,o)=>{const r=Number(await o.get(e)||0);return t-Date.now()+r},H=async(e,t,o)=>{if(!t.throttle||!o)return!1;X(t.throttle,t.id);const r=t.id||e;return await Y(r,t.throttle,o)>0?!0:(await o.set(r,Date.now().toString()),!1)},N=()=>new w(429,"Too Many Requests"),Q=async(e,t,o,r)=>{const a=L(r),n=a.publicKey||s.publicKey,i=a.blockHeadless||s.blockHeadless,l=a.storageProvider||s.storageProvider,m={...s.blockList,...a.blockList},u={...s.limitRate,...a.limitRate};return i&&F(navigator)?Promise.reject(B()):(D(n,e,t),z(o),o&&q(m,o)?Promise.reject(O()):await H(location.pathname,u,l)?Promise.reject(N()):C("/api/v1.0/email/send",JSON.stringify({lib_version:"4.4.1",user_id:n,service_id:e,template_id:t,template_params:o}),{"Content-type":"application/json"}))},Z=e=>{if(!e||e.nodeName!=="FORM")throw"The 3rd parameter is expected to be the HTML form element or the style selector of the form"},ee=e=>typeof e=="string"?document.querySelector(e):e,te=async(e,t,o,r)=>{const a=L(r),n=a.publicKey||s.publicKey,i=a.blockHeadless||s.blockHeadless,l=s.storageProvider||a.storageProvider,m={...s.blockList,...a.blockList},u={...s.limitRate,...a.limitRate};if(i&&F(navigator))return Promise.reject(B());const h=ee(o);D(n,e,t),Z(h);const c=new FormData(h);return q(m,c)?Promise.reject(O()):await H(location.pathname,u,l)?Promise.reject(N()):(c.append("lib_version","4.4.1"),c.append("service_id",e),c.append("template_id",t),c.append("user_id",n),C("/api/v1.0/email/send-form",c))},oe={init:J,send:Q,sendForm:te,EmailJSResponseStatus:w};async function re(e,t,o){var a,n,i,l;const r=`
You are an AI assistant helping identify qualified leads.
Rule: ${t}
Analyze the following two LinkedIn messages based on Rule : ${o}
Respond with only one word: "yes" or "no".
`;try{return((l=(i=(n=(a=(await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4",messages:[{role:"user",content:r}],temperature:0})})).json()).choices)==null?void 0:a[0])==null?void 0:n.message)==null?void 0:i.content)==null?void 0:l.trim().toLowerCase())==="yes"}catch(m){return console.error("❌ GPT-4 lead check failed:",m),!1}}async function ae(e,t,o){try{const r=await oe.send("service_bsl5hzq","template_d2yr0kr",{lead_name:e,conversation:t,email:o},"w6o_ed394nleoRcX8");console.log("✅ Email sent via EmailJS:",r.status,r.text)}catch(r){console.error("❌ Email send failed:",r)}}let y=!1,T=null;function A(e){return typeof e=="string"?e:e&&typeof e=="object"&&"message"in e?e.message:"Unknown error"}function d(e,t){chrome.storage.local.get(["botLog"],o=>{const r=o.botLog||[];r.unshift({time:Date.now(),type:e,detail:t}),chrome.storage.local.set({botLog:r.slice(0,50)})})}function f(e){return new Promise(t=>setTimeout(t,e))}function k(e,t){const o=Math.floor(Math.random()*(t-e+1))+e;return f(o)}async function ne(e,t){e.focus(),document.execCommand("selectAll",!1,""),document.execCommand("delete",!1,"");for(const o of t)document.execCommand("insertText",!1,o),await f(50+Math.random()*150)}async function P(){const e=document.querySelector(".msg-s-message-list-content");if(!e)return;const t=Math.random()*80+20;e.scrollBy(0,t),await f(300+Math.random()*500),e.scrollBy(0,-(Math.random()*50+10)),await f(300+Math.random()*500)}async function S(e=5){const t=document.querySelector(".msg-conversations-container--inbox-shortcuts");if(!t){console.warn("Conversation container not found");return}for(let o=0;o<e;o++){const r=Math.random()*200+100;t.scrollBy({top:r,behavior:"smooth"}),await f(500+Math.random()*800);const a=Math.random()*50;t.scrollBy({top:-a,behavior:"smooth"}),await f(400+Math.random()*500)}}async function se(){return new Promise(e=>{chrome.storage.local.get(["openaiApiKey","chatMinDelay","chatMaxDelay","loopMinDelay","loopMaxDelay","replyPrompt","leadPrompt","targetEmail"],t=>e({apiKey:t.openaiApiKey,chatMin:t.chatMinDelay||1e3,chatMax:t.chatMaxDelay||2500,loopMin:t.loopMinDelay||3e3,loopMax:t.loopMaxDelay||6e3,prompt:t.replyPrompt||"Reply briefly and professionally to this LinkedIn message:",leadPrompt:t.leadPrompt||"Does the user seem interested or did they share contact details?",targetEmail:t.targetEmail||""}))})}function K(){var t;const e=document.evaluate('//*[@id="thread-detail-jump-target"]/div/a/div/dl/dt/h2',document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||null}function I(e){var o,r;const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));for(let a=t.length-1;a>=0;a--){const n=t[a],i=n.querySelector("span.msg-s-message-group__name"),l=n.querySelector("p.msg-s-event-listitem__body");if(i&&l){const m=((o=i.textContent)==null?void 0:o.trim())||"",u=((r=l.textContent)==null?void 0:r.trim())||"";if(!u)continue;return{fromLead:m.includes(e),content:u}}}return null}function ie(){const e=document.querySelector("ul.msg-s-message-list-content");return e?Array.from(e.children).map(t=>{var o;return((o=t.textContent)==null?void 0:o.replace(/\s+/g," ").trim())||""}).filter(Boolean).join(`
`):""}async function ce(e,t,o,r){const a={model:"gpt-4",messages:[{role:"system",content:t.replace("{extracted_text}",o).replace("{user_name}",r)},{role:"user",content:o}],max_tokens:1e3},n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok)throw new Error("OpenAI API error");return(await n.json()).choices[0].message.content.trim()}function le(e){return e.split(`
`).map(t=>t.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF\uDC00-\uDFFF]|[\u2600-\u26FF])/g,"").replace(/\s+/g," ").trim()).filter(t=>t.length>0).join(`
`)}async function V(e){const t=e-1;d("started",{N:t});const{apiKey:o,chatMin:r,chatMax:a,loopMin:n,loopMax:i,prompt:l,leadPrompt:m,targetEmail:u}=await se();await S(5);let h=Array.from(document.querySelectorAll("ul.msg-conversations-container__conversations-list li")).slice(0,e).sort(()=>Math.random()-.2);await P(),await S(11);for(let c=0;c<h.length&&y;c++){await P(),await S(11),await k(r,a);const v=h[c].querySelector("a, .msg-conversation-listitem__link, [tabindex='0']");v==null||v.click(),await k(1500,2500);const g=K();if(!g)continue;const E=I(g);if(!E||!E.fromLead)continue;const _=ie();if(!_)continue;const x=Array.from(document.querySelectorAll("li.msg-s-message-list__event")).reverse().map(p=>{var b;return(b=p.textContent)==null?void 0:b.trim()}).filter(Boolean).slice(0,2);if(x.length===2&&u)try{if(await re(o,m,x)){const b=le(_);await ae(g,b,u),d("positive_lead_email_sent",{lead:g})}}catch(p){d("positive_lead_email_failed",{error:A(p)})}let M;try{M=await ce(o,l,_,g)}catch(p){d("error",{error:A(p)});continue}const j=document.querySelector("div.msg-form__contenteditable[role='textbox']"),R=document.querySelector("button.msg-form__send-button");j&&R?(await ne(j,M),await f(500+Math.random()*1e3),R.click(),d("replied",{reply:M})):d("error",{error:"Send UI not found"}),await k(r,a),c>0&&c%5===0&&await P()}d("finished iteration"),y&&(T=window.setTimeout(()=>V(e),Math.floor(Math.random()*(i-n+1))+n))}chrome.runtime.onMessage.addListener((e,t,o)=>{switch(e.type){case"PING_TEST":o("✅ Content script active!");return;case"START_BOT":y?o({status:"error",error:"Bot already running"}):(y=!0,V(e.n),o({status:"ok"}));return;case"STOP_BOT":y=!1,T!==null&&clearTimeout(T),d("stopped"),o({status:"stopped"});return;case"CHECK_UNREAD":{const r=K(),a=r?I(r):null;r&&(a!=null&&a.fromLead)&&chrome.runtime.sendMessage({type:"NEW_MESSAGE",payload:{chatId:r,messageText:a.content}}),o({status:"checked"});return}default:o({status:"error",error:"Unknown command"});return}});
