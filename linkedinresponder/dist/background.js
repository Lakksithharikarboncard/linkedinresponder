function b(e,t){return Math.floor(e+Math.random()*(t-e+1))}function A(e){return new Promise(t=>setTimeout(t,e))}let d="",m=300,u=900,o=!1,p="Reply briefly and professionally to this LinkedIn message:";chrome.storage.local.get(["openaiApiKey","minDelay","maxDelay","autoReplyEnabled","replyPrompt"],e=>{d=e.openaiApiKey||"",m=e.minDelay||m,u=e.maxDelay||u,o=e.autoReplyEnabled||!1,p=e.replyPrompt||p});chrome.storage.onChanged.addListener(e=>{e.openaiApiKey&&(d=e.openaiApiKey.newValue),e.minDelay&&(m=e.minDelay.newValue),e.maxDelay&&(u=e.maxDelay.newValue),e.autoReplyEnabled&&(o=e.autoReplyEnabled.newValue),e.replyPrompt&&(p=e.replyPrompt.newValue)});chrome.alarms.create("scan",{periodInMinutes:5});chrome.alarms.onAlarm.addListener(e=>{e.name==="scan"&&o&&g()});function g(){chrome.tabs.query({url:"https://www.linkedin.com/messaging/*"},e=>{e.forEach(t=>{t.id!==void 0&&chrome.tabs.sendMessage(t.id,{type:"CHECK_UNREAD"})})})}chrome.action.onClicked.addListener(()=>{chrome.windows.create({url:chrome.runtime.getURL("window.html"),type:"popup",width:600,height:400})});chrome.runtime.onMessage.addListener((e,t,a)=>{switch(e.type){case"RUN_SCAN_NOW":o&&g(),a({status:o?"running":"stopped"});break;case"START_BOT":o=!0,chrome.storage.local.set({autoReplyEnabled:!0}),a({status:"running"});break;case"STOP_BOT":o=!1,chrome.storage.local.set({autoReplyEnabled:!1}),a({status:"stopped"});break;case"PING_BOT":a({status:o?"running":"stopped"});break;case"NEW_MESSAGE":E(e.payload,t);break;case"GENERATE_AND_SEND":S(e,t);break}return!0});function E(e,t){const a=t.tab;if(!a||a.id===void 0)return;const{chatId:s,messageText:h}=e,y=a.id,i=new Date().toISOString().slice(0,10);chrome.storage.local.get(["repliedChats"],async f=>{const n=f.repliedChats||{},l=n[i]||[];if(!l.includes(s))try{const r=await I(h);chrome.tabs.sendMessage(y,{type:"SEND_REPLY",payload:{chatId:s,replyText:r}}),n[i]=[...l,s],chrome.storage.local.set({repliedChats:n}),await A(b(m,u))}catch(r){chrome.notifications.create({type:"basic",iconUrl:"i.png",title:"Auto-Reply Error",message:r.message||"Error calling OpenAI"})}})}function S(e,t){const a=t.tab;if(!a||a.id===void 0)return;const{chatId:s,chatHistory:h}=e;chrome.storage.local.get(["openaiApiKey","replyPrompt"],async y=>{var n,l,r;const i=y.openaiApiKey,f=y.replyPrompt||p;if(!i){console.warn("OpenAI API key not set.");return}try{const c=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:f},{role:"user",content:h}]})});if(!c.ok){console.error("OpenAI API error:",c.statusText);return}const w=((r=(l=(n=(await c.json()).choices)==null?void 0:n[0])==null?void 0:l.message)==null?void 0:r.content)||"Sorry, I couldn't generate a reply.";chrome.tabs.sendMessage(a.id,{type:"SEND_REPLY",chatId:s,replyText:w})}catch(c){console.error("OpenAI fetch failed:",c)}})}async function I(e){if(!d)throw new Error("Missing OpenAI API key in Settings.");const t=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4",messages:[{role:"system",content:p},{role:"user",content:e}]})});if(!t.ok)throw new Error("OpenAI error: "+t.statusText);const{choices:a}=await t.json();return a[0].message.content}
