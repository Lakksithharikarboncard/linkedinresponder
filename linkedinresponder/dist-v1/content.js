(function(){"use strict";const g={openaiApiKey:"openaiApiKey",groqApiKey:"groqApiKey",webhookUrl:"webhookUrl",replyPrompt:"replyPrompt",leadPrompt:"leadPrompt",chatMinDelay:"chatMinDelay",chatMaxDelay:"chatMaxDelay",loopMinDelay:"loopMinDelay",loopMaxDelay:"loopMaxDelay",startHour:"startHour",endHour:"endHour",replyProvider:"replyProvider",decisionProvider:"decisionProvider",leadDetectionProvider:"leadDetectionProvider"},w={openaiApiKey:"",groqApiKey:"",webhookUrl:"",replyPrompt:`You are {user_name}'s assistant. Reply to this lead based on context:
{extracted_text}
Reply briefly and professionally.`,leadPrompt:"Does this conversation indicate strong buying intent or interest? Reply YES or NO.",chatMinDelay:2e3,chatMaxDelay:5e3,loopMinDelay:1e4,loopMaxDelay:3e4,startHour:9,endHour:18,replyProvider:"groq",decisionProvider:"groq",leadDetectionProvider:"openai"},xe=["openai","groq"];function Se(e,t,n,o){const s=typeof e=="number"?e:Number(e);if(!Number.isFinite(s))return o;const r=Math.round(s);return Math.min(n,Math.max(t,r))}function X(e,t,n,o){const s=typeof e=="number"?e:Number(e);return Number.isFinite(s)?Math.min(n,Math.max(t,Math.floor(s))):o}function F(e,t){return typeof e!="string"?t:e}function se(e,t){return typeof e=="string"&&xe.includes(e)?e:t}function Bt(e){return e}function Oe(e){return e.trim()}async function be(){return new Promise(e=>{chrome.storage.local.get(Object.values(g),t=>{const n=X(t[g.chatMinDelay],250,6e4,w.chatMinDelay),o=X(t[g.chatMaxDelay],250,12e4,w.chatMaxDelay),s=X(t[g.loopMinDelay],500,6e5,w.loopMinDelay),r=X(t[g.loopMaxDelay],500,6e5,w.loopMaxDelay),a=Math.min(n,o),u=Math.max(n,o),m=Math.min(s,r),f=Math.max(s,r),S=Se(t[g.startHour],0,23,w.startHour),y=Se(t[g.endHour],0,23,w.endHour),b={openaiApiKey:F(t[g.openaiApiKey],w.openaiApiKey).trim(),groqApiKey:F(t[g.groqApiKey],w.groqApiKey).trim(),webhookUrl:Oe(F(t[g.webhookUrl],w.webhookUrl)),replyPrompt:F(t[g.replyPrompt],w.replyPrompt),leadPrompt:F(t[g.leadPrompt],w.leadPrompt),chatMinDelay:a,chatMaxDelay:u,loopMinDelay:m,loopMaxDelay:f,startHour:S,endHour:y,replyProvider:se(t[g.replyProvider],w.replyProvider),decisionProvider:se(t[g.decisionProvider],w.decisionProvider),leadDetectionProvider:se(t[g.leadDetectionProvider],w.leadDetectionProvider)};e(b)})})}const Re=["not interested","no thanks","no thank","not now","too busy","maybe later","not a fit","no overlap","policy","not allowed","stop","unsubscribe","no, thank you","no thank you","no thankyou","nope","nah"],Ie=["sure","ok","okay","k","thx","thanks"];function Te(e){return e==="groq"?"https://api.groq.com/openai/v1/chat/completions":"https://api.openai.com/v1/chat/completions"}function ve(e){return e==="groq"?"llama-3.3-70b-versatile":"gpt-4o-mini"}async function $e(e,t,n,o="openai"){var x,I,C,D,$;if(t.length===0)return{shouldReply:!1,reason:"Empty conversation"};const s=t[t.length-1],r=s.message.toLowerCase().trim(),a=t.filter(c=>c.speaker!==n),u=t.filter(c=>c.speaker===n);if(Re.some(c=>r.includes(c)))return{shouldReply:!1,reason:"Lead disengaged"};if(Ie.includes(r)&&a.length>0){const c=a[a.length-1].message.toLowerCase();if(c.includes("no overlap")||c.includes("reach out if")||c.includes("feel free to reach out")||c.includes("not a fit")||c.includes("no problem")||c.includes("thanks for letting me know"))return{shouldReply:!1,reason:"Ack after close"}}const m=a.length>0&&a[a.length-1].message.includes("?"),f=u[u.length-1]===s,S=a.length?t.findIndex(c=>c===a[a.length-1]):-1,y=t.length-1;if(m&&f&&y>S)return{shouldReply:!0,reason:"They answered my question"};const b=s.message.split(" ").length<20,M=a.length>0&&u.length>0;if(b&&M&&a.length>=2)return{shouldReply:!0,reason:"Short but engaged response"};if(["yes","yeah","sure","absolutely","definitely","interested","sounds good","tell me more","how does","what about","can you","could you","would love to","want to know","curious about","?"].some(c=>r.includes(c)))return{shouldReply:!0,reason:"Positive engagement detected"};const W=`You are analyzing a LinkedIn conversation to decide if a response is needed.

CONVERSATION (last 20 messages):
${t.slice(-20).map(c=>`${c.speaker}: ${c.message}`).join(`
`)}

CONTEXT: The lead just sent: "${s.message}"

Rules:
- REPLY if they asked a question, answered my question, or showed interest.
- SKIP if they rejected, said no, not interested, policy/no allowance, or gave a short acknowledgment after my closing message.
- Be biased to REPLY only when there's real engagement; otherwise SKIP.

Respond ONLY with:
REPLY: [one sentence reason]
OR
SKIP: [one sentence reason]`;try{const c=Te(o),O=ve(o),k=await fetch(c,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:O,messages:[{role:"user",content:W}],temperature:.2,max_tokens:60})});if(!k.ok)return console.error(`âŒ ${o.toUpperCase()} API error in shouldReplyToConversation: ${k.status}`),{shouldReply:!0,reason:"AI check failed - defaulting to reply"};const Y=((D=(C=(I=(x=(await k.json()).choices)==null?void 0:x[0])==null?void 0:I.message)==null?void 0:C.content)==null?void 0:D.trim())||"",V=Y.toUpperCase().startsWith("REPLY"),J=(($=Y.split(":")[1])==null?void 0:$.trim())||"AI decision";return{shouldReply:V,reason:J}}catch(c){return console.error("âŒ AI decision check failed:",c),{shouldReply:!0,reason:"AI error - defaulting to engage"}}}async function Le(e,t,n,o="openai"){var r,a,u,m;const s=`You are an AI assistant helping identify qualified leads.
Rule: ${t}
Analyze the following two LinkedIn messages: ${n.join(`
`)}
Respond with only one word: "yes" or "no".`;try{const f=Te(o),S=ve(o),y=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:S,messages:[{role:"user",content:s}],temperature:0,max_tokens:10})});return y.ok?((m=(u=(a=(r=(await y.json()).choices)==null?void 0:r[0])==null?void 0:a.message)==null?void 0:u.content)==null?void 0:m.trim().toLowerCase())==="yes":(console.error(`âŒ ${o.toUpperCase()} API error in checkPositiveLead: ${y.status}`),!1)}catch(f){return console.error("âŒ GPT lead check failed:",f),!1}}async function Ne(e){const{webhookUrl:t}=await be();if(!t||t.trim().length===0)throw new Error("Webhook URL is not configured. Please set it in Options.");const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok){const o=await n.text().catch(()=>"Unknown error");throw console.error("âŒ Webhook error:",o),new Error(`Webhook error: ${n.status}`)}console.log("âœ… Lead sent to webhook successfully")}const re="conversation_histories",Me=500,_e=6e4;function Ue(e,t){const n=`${e}_${t}`;return btoa(unescape(encodeURIComponent(n))).substring(0,32)}async function Ce(){return new Promise(e=>{chrome.storage.local.get([re],t=>{e(t[re]||{})})})}async function Fe(e){return(await Ce())[e]||null}async function ae(e){const t=await Ce();return e.messages.length>Me&&(e.messages=e.messages.slice(-Me)),t[e.leadId]=e,new Promise(n=>{chrome.storage.local.set({[re]:t},()=>{n()})})}function qe(e){return e?Date.now()-e.metadata.lastSyncedAt>_e:!0}const q={headline:[".pv-text-details__left-panel h2",".text-body-medium.break-words",'div[data-view-name="profile-headline"]',".pv-top-card--list-bullet .text-body-small"],jobTitle:[".pv-text-details__left-panel .text-body-small:first-of-type",".pv-top-card--list-bullet .text-body-small:first-child"],company:[".pv-text-details__left-panel .text-body-small.inline a",'a[data-field="experience_company_logo"]',".experience-item__company"],location:[".pv-text-details__left-panel .text-body-small:last-of-type","span.text-body-small.inline.t-black--light.break-words",".pv-top-card--list-bullet .text-body-small:last-child"],connectionDegree:[".dist-value","span.dist-value",".pv-top-card--list-bullet span.dist-value"]},je=/(status is (online|offline|reachable|active now))/i;function j(e){var t;for(const n of e){const o=document.querySelector(n);if((t=o==null?void 0:o.textContent)!=null&&t.trim())return o.textContent.trim()}return""}function Be(e){if(!e)return"";const t=e.split(`
`).map(o=>o.trim()).filter(o=>o&&!je.test(o.toLowerCase())).join(" ").replace(/\s+/g," ").trim();return t.split(" ").filter(Boolean).length<3?"Unknown":t}function He(){var t,n;let e=j(q.headline);if(!e){const o=(n=(t=document.querySelector(".msg-thread__link-to-profile"))==null?void 0:t.textContent)==null?void 0:n.trim();o&&(e=o)}return Be(e)}function Ke(){return j(q.jobTitle).replace(/^at\s+/i,"").trim()||"Unknown"}function Ge(){let e=j(q.company);return e=e.replace(/^at\s+/i,"").trim(),e||"Unknown"}function We(){return j(q.location)||"Unknown"}function Ye(){let e=j(q.connectionDegree);const t=e.match(/(\d+(?:st|nd|rd|th))/);return t?t[1]:e||"Unknown"}function Ve(){return{headline:He(),jobTitle:Ke(),company:Ge(),location:We(),connectionDegree:Ye(),lastScraped:Date.now()}}function B(e,t){if(!t)return e;const n=[];t.jobTitle&&t.jobTitle!=="Unknown"&&n.push(t.jobTitle),t.company&&t.company!=="Unknown"&&n.push(`@ ${t.company}`),t.location&&t.location!=="Unknown"&&n.push(t.location);const o=n.length>0?` (${n.join(", ")})`:"";return`${e}${o}`}function Je(e){if(!e)return"Profile: Not available";const t=[];return e.headline&&e.headline!=="Unknown"&&t.push(`Headline: ${e.headline}`),e.jobTitle&&e.jobTitle!=="Unknown"&&t.push(`Job Title: ${e.jobTitle}`),e.company&&e.company!=="Unknown"&&t.push(`Company: ${e.company}`),e.location&&e.location!=="Unknown"&&t.push(`Location: ${e.location}`),e.connectionDegree&&e.connectionDegree!=="Unknown"&&t.push(`Connection: ${e.connectionDegree}`),t.length?t.join(" | "):"Profile: Not available"}function Qe(e,t){const n=e.split(" ").length>40,o=t.lastMessageQuestions>0;return n||o}function ze(e,t){const n=[Xe,Ze,et,tt];for(const o of n){const s=o(e);if(s)return s}return null}function Xe(e){const t=e.split(/[.!?]/).filter(r=>r.trim());if(t.length<3)return null;const n=Math.floor(t.length/2),o=t.slice(0,n).join(". ").trim(),s=t.slice(n).join(". ").trim();return o.length<20||s.length<10?null:{firstMessage:o,secondMessage:s,delayMs:3e3+Math.random()*4e3,pattern:"price_breakdown"}}function Ze(e){const t=e.split(/[.!?]/).filter(a=>a.trim());if(t.length<2)return null;const n=t[0].trim(),o=t.slice(1).join(". ").trim(),s=["Quick note:","Also,","One more thing:"],r=s[Math.floor(Math.random()*s.length)];return{firstMessage:n,secondMessage:`${r} ${o.charAt(0).toLowerCase()}${o.slice(1)}`,delayMs:5e3+Math.random()*3e3,pattern:"afterthought"}}function et(e){if(!e.includes("?")||!e.trim().endsWith("?"))return null;const t=["No rushâ€”ballpark is fine.","Roughly is okay.","Just an estimate works."];return{firstMessage:e.trim(),secondMessage:t[Math.floor(Math.random()*t.length)],delayMs:1800+Math.random()*1200,pattern:"question_refinement"}}function tt(e){if(e.split(" ").length>15||/[.!?]$/.test(e.trim())||![/^(yeah|yes|yep|sure|sounds good|makes sense|got it|perfect)/i].some(s=>s.test(e)))return null;const o=["ðŸ‘","ðŸ‘Œ","âœ…"];return{firstMessage:e.trim(),secondMessage:o[Math.floor(Math.random()*o.length)],delayMs:1500+Math.random()*1500,pattern:"emoji_followup"}}function nt(e){const n={price_breakdown:3e3,afterthought:5e3,question_refinement:1800,emoji_followup:1500}[e]??3e3,o=n*.4;return n+(Math.random()-.5)*2*o}let v=!1,P=!1,Z=null,H={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:null,tokensUsed:0,currentModel:""},K=[],ie=!0,le="llama-3.3-70b-versatile",ce=!1,A=null,ue=[];const ot=["student","intern","seeking","open to work","looking for","hiring"],st=14*24*60*60*1e3,rt=["no overlap","not a fit","reach out if","feel free to reach out","thanks for letting me know","happy to stay connected","best of luck","good luck with","wishing you","take care","all the best","not what you're looking for","doesn't seem like a match","maybe in the future","keep in touch"],at=["schedule","reschedule","next week","after jan","after january","after the","let's","lets","call","meet","demo","walkthrough","chat soon","talk soon","talk then","sounds good","works for me","perfect","great","book","calendar","calendly","outlook"],it=["no problem","no worries","sure thing","of course","absolutely","definitely"],lt=["calendly.com","cal.com","outlook.office.com/book","hubspot.com/meetings","savvycal.com","tidycal.com","book a time","grab time","schedule a call","schedule a chat","book a call","here's a link","here is a link","whenever works","pick a time","find a time"],ct=["sounds good","sounds great","perfect","will do","see you then","looking forward","look forward","talk soon","talk then","catch you","thanks for sharing","thank you for sharing","i'll check","i will check","let me check","booked","scheduled","confirmed","done","great, thanks","awesome","cool","ok great","okay great","works for me"],ut=["hi","hey","hello","hii","hiii","heyy","heyyy","yo","sup","morning","good morning","good afternoon","good evening","gm"];function dt(e){return new Promise(t=>setTimeout(t,e))}function p(e){return new Promise(t=>setTimeout(t,e))}async function mt(e,t=3,n=1e3){let o=0;for(;;){const s=await e();if(s.ok)return s;if((s.status===429||s.status>=500)&&o<t){const r=n*2**o+Math.random()*400;await dt(r),o++;continue}return s}}function i(e,t,n){const o={time:Date.now(),type:e,message:t,actor:n};K.unshift(o),K.length>100&&K.pop(),chrome.storage.local.set({botLog:K.slice(0,50)})}function N(e,t){e==="startTime"?H.startTime=t:e==="currentModel"?H.currentModel=t:H[e]+=t}function de(e){return 2e3+e.split(" ").length*300+Math.random()*2e3}function pt(e=9,t=18){const n=new Date().getHours();return n>=e&&n<t}async function me(e,t){e.focus(),await p(50),document.execCommand("selectAll",!1,""),document.execCommand("delete",!1,"");for(const n of t){document.execCommand("insertText",!1,n);const o=Math.random()>.9?150:30+Math.random()*50;await p(o)}}async function ht(){const e=document.querySelector(".msg-s-message-list-content");if(!e)return;const t=Math.random()*80+20;e.scrollBy(0,t),await p(300+Math.random()*500),e.scrollBy(0,-(Math.random()*50+10)),await p(300+Math.random()*500)}async function ft(e=5){const t=document.querySelector(".msg-conversations-container--inbox-shortcuts");if(t)for(let n=0;n<e;n++)t.scrollBy({top:Math.random()*200+100,behavior:"smooth"}),await p(500+Math.random()*800),t.scrollBy({top:-(Math.random()*50),behavior:"smooth"}),await p(400+Math.random()*500)}function pe(e,t,n){return e==="groq"?n:t}async function gt(){const e=await be();return{apiKey:e.openaiApiKey,groqApiKey:e.groqApiKey,chatMin:e.chatMinDelay,chatMax:e.chatMaxDelay,loopMin:e.loopMinDelay,loopMax:e.loopMaxDelay,prompt:e.replyPrompt,leadPrompt:e.leadPrompt,webhookUrl:e.webhookUrl,startHour:e.startHour,endHour:e.endHour,replyProvider:e.replyProvider,decisionProvider:e.decisionProvider,leadDetectionProvider:e.leadDetectionProvider}}function yt(){var t;const e=document.evaluate('//*[@id="thread-detail-jump-target"]/div/a/div/dl/dt/h2',document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||null}function wt(){const e=document.querySelector('a[href*="/in/"]');return(e==null?void 0:e.href)||window.location.href}function kt(e){var n,o;const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));for(let s=t.length-1;s>=0;s--){const r=t[s],a=r.querySelector("span.msg-s-message-group__name"),u=r.querySelector("p.msg-s-event-listitem__body");if(a&&u){const m=((n=a.textContent)==null?void 0:n.trim())||"",f=((o=u.textContent)==null?void 0:o.trim())||"";if(!f)continue;return{fromLead:m.includes(e),content:f}}}return null}async function St(){const e=document.querySelector(".msg-s-message-list-content");if(!e)return;let t=0,n=e.scrollHeight,o=0;const s=50;for(i("INFO","Loading full conversation history...","System");n>t&&o<s;)t=n,e.scrollTo({top:0,behavior:"smooth"}),await p(800+Math.random()*400),n=e.scrollHeight,o++;i("INFO",`Loaded ${o} message batches`,"System")}async function bt(e){var o,s;await St();const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event")),n=[];for(const r of t){const a=r.querySelector("span.msg-s-message-group__name"),u=r.querySelector("p.msg-s-event-listitem__body"),m=r.querySelector("time");if(a&&u){const f=((o=a.textContent)==null?void 0:o.trim())||"Unknown",S=((s=u.textContent)==null?void 0:s.trim())||"";let y=Date.now();if(m){const M=m.getAttribute("datetime");M&&(y=new Date(M).getTime())}const b=f.includes(e)?"received":"sent";S&&n.push({speaker:f,content:S,timestamp:y,type:b})}}return n}async function Tt(e){var m;const t=wt(),n=Ue(e,t);let o=await Fe(n);if(o&&!qe(o))return i("INFO",`Using cached data for ${B(e,o.profile)} (${o.messages.length} msgs)`,"System"),o;i("INFO",`Scraping profile for ${e}...`,"System");const s=Ve();i("INFO",`Syncing full history for ${e}...`,"System");const r=await bt(e),a=r[r.length-1],u={leadId:n,leadName:e,profileUrl:t,profile:s,messages:r,metadata:{firstContact:((m=r[0])==null?void 0:m.timestamp)||Date.now(),lastActivity:(a==null?void 0:a.timestamp)||Date.now(),lastMessageFrom:(a==null?void 0:a.type)==="received"?"lead":"me",totalMessages:r.length,lastSyncedAt:Date.now()}};return await ae(u),i("SUCCESS",`Saved ${r.length} messages + profile for ${B(e,s)}`,"System"),u}function vt(e){const t=e.toLowerCase();return lt.some(n=>t.includes(n))}function Pe(e){const t=e.toLowerCase().trim();return t.split(/\s+/).length>10?!1:ct.some(o=>t.includes(o))}function he(e){const t=e.toLowerCase().trim();return t.split(/\s+/).length>3?!1:ut.some(o=>t===o||t.startsWith(o+" "))}function Ae(e){const t=e.toLowerCase();return at.some(n=>t.includes(n))}function Mt(e){const t=e.toLowerCase(),n=it.some(s=>t.includes(s)),o=Ae(e);return n&&o}function Ct(e){for(let t=e.length-1;t>=1;t--){const n=e[t],o=e[t-1];if(o.type==="sent"&&n.type==="received"&&vt(o.content)&&Pe(n.content))return n.timestamp;if(t>=2){const s=e[t-2];if(s.type==="received"&&o.type==="sent"&&n.type==="received"&&(s.content.toLowerCase().includes("schedule")||s.content.toLowerCase().includes("after")||s.content.toLowerCase().includes("next week")||s.content.toLowerCase().includes("vacation")||s.content.toLowerCase().includes("holiday"))&&Pe(n.content))return n.timestamp}}return null}function Pt(e){for(let t=e.length-1;t>=0;t--){const n=e[t];if(n.type==="sent"){const o=n.content.toLowerCase();if(Ae(n.content)||Mt(n.content))continue;if(rt.some(s=>o.includes(s)))return n.timestamp}}return null}function At(e){const t=Ct(e);if(t)return{isClosed:!0,closeType:"pending_meeting",closeTimestamp:t,reason:"Meeting scheduled and confirmed"};const n=Pt(e);return n?{isClosed:!0,closeType:"my_close",closeTimestamp:n,reason:"I closed the conversation"}:{isClosed:!1,closeType:"none",closeTimestamp:null,reason:""}}function Dt(e,t){if(!e.isClosed||!e.closeTimestamp)return{shouldSkip:!1,reason:""};const n=Date.now()-e.closeTimestamp,o=n<st,s=Math.round(n/(1e3*60*60*24));if(e.closeType==="pending_meeting"){if(he(t)&&s<=7)return{shouldSkip:!1,reason:"Short ping after recent scheduling - likely ready to book"};if(he(t)&&s>7)return{shouldSkip:!0,reason:`Short ping ${s} days after scheduled meeting`}}if(e.closeType==="my_close"&&he(t)&&o)return{shouldSkip:!0,reason:`Short ping during close cooldown (${s} days ago)`};if(o){const r=t.includes("?"),a=t.split(/\s+/).length;if(!r&&a<=5)return{shouldSkip:!0,reason:`Short acknowledgment during ${e.closeType==="pending_meeting"?"pending meeting":"close"} cooldown`}}return t.includes("?")||t.split(/\s+/).length>10?{shouldSkip:!1,reason:"Substantive message or question - engage"}:{shouldSkip:!1,reason:""}}function Et(e){if(e==="Unknown")return!0;const t=e.toLowerCase();return ot.some(n=>t.includes(n))}async function xt(e,t,n,o,s,r,a=!1,u="llama-3.3-70b-versatile"){var c,O;const m=n.slice(-30),f=m.map(k=>`${k.speaker}: ${k.content}`).join(`
`),S=Ot(),y=Rt(n),b=It(n),M=$t(r),R=r?`

LEAD PROFILE:
${Je(r)}
`:"",ee=t.replace("{extracted_text}",f).replace("{user_name}",o).replace("{lead_headline}",(r==null?void 0:r.headline)||"Unknown"),te=`You are a real professional messaging on LinkedIn (NOT an AI assistant).
${R}
TIME CONTEXT: ${S}
CONVERSATION AGE: ${y}
THEIR MESSAGING STYLE: ${b}
TONE ADJUSTMENT: ${M}

CONVERSATION (${n.length} total messages, showing last ${m.length}):
${f}

USER'S INSTRUCTIONS:
${ee}

CRITICAL REALISM RULES:
1. LENGTH: 15-30 words. Real people are busy.
2. TONE: Match their energy. If they write 5 words, you write 7-10.
3. NATURAL: Use contractions (I'm, we're, that's). Be conversational.
4. QUESTIONS: Max ONE follow-up question.
5. AVOID AI PATTERNS:
   - "Thank you for reaching out"
   - "I hope this finds you well"
   - "I'd be happy to..."
   - Corporate jargon
   - Over-enthusiasm (!!!)

Respond as ${s}. Type like you're between meetings.`,W=a?"https://api.groq.com/openai/v1/chat/completions":"https://api.openai.com/v1/chat/completions",x=a?u:"gpt-4o-mini";let I=150;a&&(u==="openai/gpt-oss-120b"?I=500:I=250);const C=await mt(()=>fetch(W,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:x,messages:[{role:"system",content:te},...m.map(k=>({role:k.type==="received"?"user":"assistant",content:k.content}))],max_tokens:I,temperature:.7})}),3,1e3);if(!C.ok){const k=await C.text();throw new Error(`${a?"Groq":"OpenAI"} API Error ${C.status}: ${k.slice(0,500)}`)}const D=await C.json(),$=(((c=D.usage)==null?void 0:c.prompt_tokens)||0)+(((O=D.usage)==null?void 0:O.completion_tokens)||0);return{reply:D.choices[0].message.content.trim(),tokensUsed:$}}function Ot(){const e=new Date().getHours(),t=new Date().getDay();return t===0||t===6?"Weekend - keep it casual and light":e<12?"Morning - people are busy, be concise":e<17?"Afternoon - normal business hours":"Evening - they might not respond until tomorrow"}function Rt(e){if(e.length<2)return"First exchange - establish rapport";const t=e[0].timestamp,n=Math.floor((Date.now()-t)/(1e3*60*60*24));return n===0?"New conversation today":n===1?"Ongoing conversation":n>7?"Old conversation - re-engage carefully":`${n}-day conversation`}function It(e){const t=e.filter(o=>o.type==="received");if(t.length===0)return"Unknown";const n=t.reduce((o,s)=>o+s.content.split(" ").length,0)/t.length;return n<10?"SHORT replies (5-10 words) - match that brevity":n<25?"MEDIUM replies (10-25 words) - similar length":"LONG replies (25+ words) - you can elaborate more"}function $t(e){if(!e||!e.jobTitle)return"Professional but friendly";const t=e.jobTitle.toLowerCase();return t.includes("ceo")||t.includes("founder")||t.includes("president")?"EXECUTIVE - Be direct, concise, value-focused. No fluff.":t.includes("director")||t.includes("vp")||t.includes("head")?"SENIOR LEADER - Professional, strategic. Focus on ROI.":t.includes("engineer")||t.includes("developer")?"TECHNICAL - Be specific, mention features. Avoid sales speak.":"PROFESSIONAL - Warm, helpful, consultative."}function Lt(){var t;const e=document.querySelector(".global-nav__me-content span");return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||"You"}function fe(e){return{"openai/gpt-oss-120b":"GPT-OSS-120B","llama-3.3-70b-versatile":"Llama-3.3-70B","meta-llama/llama-4-scout-17b-16e-instruct":"Llama-4-Scout","meta-llama/llama-4-maverick-17b-128e-instruct":"Llama-4-Maverick","moonshotai/kimi-k2-instruct-0905":"Kimi-K2","qwen/qwen3-32b":"Qwen-3-32B","gpt-4o-mini":"GPT-4o-mini","gpt-4o":"GPT-4o"}[e]||e}function G(e){return e==="groq"?"Groq":"OpenAI"}function Nt(e,t){var o,s;const n=[e.toLowerCase(),((o=t==null?void 0:t.company)==null?void 0:o.toLowerCase())||"",((s=t==null?void 0:t.jobTitle)==null?void 0:s.toLowerCase())||""];for(const r of ue){const a=r.toLowerCase();for(const u of n)if(u&&u.includes(a))return!0}return!1}async function _t(e,t){return new Promise(n=>{A=n,chrome.storage.local.set({pendingReply:{leadName:e,reply:t,timestamp:Date.now()}}),i("INFO",`Waiting for approval to reply to ${e}...`,"System"),setTimeout(()=>{A&&(i("WARNING",`Reply approval timed out for ${e}`,"System"),A({approved:!1,reply:""}),A=null,chrome.storage.local.remove(["pendingReply"]))},5*60*1e3)})}async function De(e,t=6,n=400){for(let o=0;o<t;o++){const s=document.querySelector(e);if(s)return s;await p(n)}return null}async function ge(e){var $,c,O,k,we,Y;i("INFO",`Starting batch of ${e} chats...`,"System");const{apiKey:t,groqApiKey:n,chatMin:o,chatMax:s,loopMin:r,loopMax:a,prompt:u,leadPrompt:m,webhookUrl:f,startHour:S,endHour:y,replyProvider:b,decisionProvider:M,leadDetectionProvider:R}=await gt(),ee=pe(b,t,n),te=pe(M,t,n),W=pe(R,t,n),x=b==="groq"?le:"gpt-4o-mini";if(N("currentModel",fe(x)),ue=(await chrome.storage.local.get(["blacklist"])).blacklist||[],ie&&!pt(S,y)){i("WARNING",`Outside working hours (${S}-${y}). Pausing.`,"System"),v&&!P&&(Z=window.setTimeout(()=>ge(e),15*60*1e3));return}const C=Lt();await ft(5);let D=Array.from(document.querySelectorAll("ul.msg-conversations-container__conversations-list li")).slice(0,e).sort(()=>Math.random()-.2);i("INFO",`Found ${D.length} conversations to check.`,"Bot");for(let V=0;V<D.length&&v;V++){for(;P&&v;)await p(1e3);if(!v)break;await ht(),await Ee(o,s);const J=D[V].querySelector("a, .msg-conversation-listitem__link, [tabindex='0']");J==null||J.click(),await p(2e3);const d=yt();if(!d)continue;const Q=kt(d);if(!Q||!Q.fromLead){i("INFO",`Skipping ${d}: Last message was from me.`,"Bot");continue}const l=await Tt(d),ke=At(l.messages);if(ke.isClosed){const h=Dt(ke,Q.content);if(h.shouldSkip){i("INFO",`Skipping ${d}: ${h.reason} [${ke.closeType}]`,"Bot");continue}h.reason&&i("INFO",`Engaging ${d}: ${h.reason}`,"Bot")}const Ut=(($=l.profile)==null?void 0:$.headline)||"Unknown";if(Et(Ut)&&!Q.content.includes("?")&&Q.content.split(" ").length<12){i("INFO",`Skipping ${d}: Irrelevant or unknown headline`,"Bot");continue}if(Nt(d,l.profile)){i("WARNING",`Skipping ${d}: Blacklisted`,"Bot");continue}if(i("INFO",`Checking chat with ${B(d,l.profile)}...`,"Bot"),N("chatsProcessed",1),l.messages.length===0){i("WARNING",`No messages found for ${d}`,"System");continue}const Ft=l.messages.slice(-8).map(h=>({speaker:h.speaker,message:h.content}));let ne;try{ne=await $e(te,Ft,d,M),i("ACTION",`AI Decision for ${d}: ${ne.shouldReply?"REPLY":"SKIP"} (${ne.reason}) [${G(M)}]`,"Bot")}catch(h){i("ERROR",`AI Decision Failed (${G(M)}): ${ye(h)}`,"System");continue}if(!ne.shouldReply)continue;if(f)try{const h=l.messages.slice(-2).map(T=>T.content);if(await Le(W,m,h,R)){const T=l.messages.map(L=>`${L.speaker}: ${L.content}`).join(`
`),U={leadName:d,profileUrl:l.profileUrl,company:((c=l.profile)==null?void 0:c.company)||"Unknown",jobTitle:((O=l.profile)==null?void 0:O.jobTitle)||"Unknown",headline:((k=l.profile)==null?void 0:k.headline)||"Unknown",conversationHistory:T,messageCount:l.messages.length,detectedAt:new Date().toISOString()};await Ne(U),N("leadsFound",1),i("SUCCESS",`ðŸ”¥ HOT LEAD: ${d} sent to webhook! [${G(R)}]`,"Bot")}}catch(h){i("ERROR",`Lead webhook failed (${G(R)}): ${ye(h)}`,"System")}let oe;try{oe=await xt(ee,u,l.messages,d,C,l.profile,b==="groq",le),N("tokensUsed",oe.tokensUsed)}catch(h){i("ERROR",`Reply Generation Failed (${G(b)}): ${ye(h)}`,"System");continue}let _=oe.reply;if(ce){const h=await _t(d,oe.reply);if(!h.approved){i("INFO",`Reply to ${d} was skipped by user`,"User");continue}_=h.reply}const z=await De("div.msg-form__contenteditable[role='textbox']",6,400),E=await De("button.msg-form__send-button",6,400);if(z&&E){const h={messageCount:l.messages.length,lastMessageQuestions:(((we=l.messages[l.messages.length-1])==null?void 0:we.content.match(/\?/g))||[]).length},T=Qe(_,h)?ze(_):null;if(T){i("ACTION",`Double-texting ${d} (${T.pattern})...`,"Bot");const U=de(T.firstMessage);if(await p(U),await me(z,T.firstMessage),await p(800),!E.hasAttribute("disabled")&&!E.classList.contains("disabled")){E.click(),await p(500);const L=nt(T.pattern);i("INFO",`Waiting ${Math.round(L/1e3)}s before second message...`,"Bot"),await p(L);const jt=de(T.secondMessage);await p(jt),await me(z,T.secondMessage),await p(800),!E.hasAttribute("disabled")&&!E.classList.contains("disabled")?(E.click(),await p(500),N("repliesSent",1),l.messages.push({speaker:C,content:T.firstMessage,timestamp:Date.now()-L,type:"sent"},{speaker:C,content:T.secondMessage,timestamp:Date.now(),type:"sent"}),l.metadata.lastActivity=Date.now(),l.metadata.lastMessageFrom="me",l.metadata.totalMessages+=2,l.metadata.lastSyncedAt=Date.now(),await ae(l),i("SUCCESS",`Double-texted ${B(d,l.profile)} (${fe(x)}) [History: ${l.messages.length} msgs]`,"Bot")):i("ERROR",`Send button disabled for second message to ${d}`,"System")}else i("ERROR",`Send button disabled for ${d}`,"System")}else{const U=de(_);i("ACTION",`Typing reply to ${d} (waiting ${Math.round(U/1e3)}s)...`,"Bot"),await p(U),await me(z,_),await p(800),E.hasAttribute("disabled")||E.classList.contains("disabled")?i("ERROR",`Send button disabled for ${d}`,"System"):(E.click(),await p(500),(((Y=z.textContent)==null?void 0:Y.trim())||"").length===0?(N("repliesSent",1),l.messages.push({speaker:C,content:_,timestamp:Date.now(),type:"sent"}),l.metadata.lastActivity=Date.now(),l.metadata.lastMessageFrom="me",l.metadata.totalMessages++,l.metadata.lastSyncedAt=Date.now(),await ae(l),i("SUCCESS",`Sent reply to ${B(d,l.profile)} (${fe(x)}) [History: ${l.messages.length} msgs]`,"Bot")):i("WARNING",`Message may not have sent to ${d}`,"System"))}}else i("ERROR","Could not find chat input or send button","System");await Ee(o,s)}i("INFO","Batch finished. Sleeping...","System"),v&&!P&&(Z=window.setTimeout(()=>ge(e),Math.floor(Math.random()*(a-r+1))+r))}function Ee(e,t){return p(Math.floor(Math.random()*(t-e+1))+e)}function ye(e){return typeof e=="string"?e:e&&typeof e=="object"&&"message"in e?e.message:"Unknown error"}chrome.runtime.onMessage.addListener((e,t,n)=>{var o,s,r,a,u,m;if(e.type==="PING_TEST"){n("âœ… Content script active!");return}if(e.type==="GET_STATUS"){n({running:v,paused:P,stats:H,logs:K});return}if(e.type==="START_BOT"){v?n({status:"error",error:"Already running"}):(v=!0,P=!1,H={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:Date.now(),tokensUsed:0,currentModel:""},ie=((o=e.config)==null?void 0:o.strictHours)??!0,(s=e.config)==null||s.useGroq,le=((r=e.config)==null?void 0:r.groqModel)??"llama-3.3-70b-versatile",ce=((a=e.config)==null?void 0:a.replyPreviewEnabled)??!1,ue=((u=e.config)==null?void 0:u.blacklist)??[],i("INFO",`Bot started (Strict Hours: ${ie?"ON":"OFF"}, Preview: ${ce?"ON":"OFF"})`,"User"),ge(((m=e.config)==null?void 0:m.nChats)??10),n({status:"ok"}));return}if(e.type==="STOP_BOT"){v=!1,P=!1,Z!==null&&clearTimeout(Z),i("INFO","Bot stopped by user","User"),n({status:"stopped"});return}if(e.type==="PAUSE_BOT"){v&&!P?(P=!0,i("INFO","Bot paused by user","User"),n({status:"paused"})):n({status:"error",error:"Not running or already paused"});return}if(e.type==="RESUME_BOT"){v&&P?(P=!1,i("INFO","Bot resumed by user","User"),n({status:"running"})):n({status:"error",error:"Not paused"});return}if(e.type==="APPROVE_REPLY"){A&&(i("SUCCESS",`Reply to ${e.leadName} approved`,"User"),A({approved:!0,reply:e.reply}),A=null,chrome.storage.local.remove(["pendingReply"])),n({status:"ok"});return}if(e.type==="REJECT_REPLY"){A&&(i("INFO",`Reply to ${e.leadName} rejected`,"User"),A({approved:!1,reply:""}),A=null,chrome.storage.local.remove(["pendingReply"])),n({status:"ok"});return}if(e.type==="CHECK_UNREAD"){v&&!P&&i("INFO","Check unread triggered by background","System"),n({status:"ok"});return}})})();
