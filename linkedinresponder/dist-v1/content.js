(function(){"use strict";const k={openaiApiKey:"openaiApiKey",groqApiKey:"groqApiKey",webhookUrl:"webhookUrl",replyPrompt:"replyPrompt",leadPrompt:"leadPrompt",chatMinDelay:"chatMinDelay",chatMaxDelay:"chatMaxDelay",loopMinDelay:"loopMinDelay",loopMaxDelay:"loopMaxDelay",startHour:"startHour",endHour:"endHour",replyProvider:"replyProvider",decisionProvider:"decisionProvider",leadDetectionProvider:"leadDetectionProvider",groqModel:"groqModel",openaiModel:"openaiModel"},S={openaiApiKey:"",groqApiKey:"",webhookUrl:"",replyPrompt:`You are {user_name}'s assistant. Reply to this lead based on context:
{extracted_text}
Reply briefly and professionally.`,leadPrompt:"Does this conversation indicate strong buying intent or interest? Reply YES or NO.",chatMinDelay:2e3,chatMaxDelay:5e3,loopMinDelay:1e4,loopMaxDelay:3e4,startHour:9,endHour:18,replyProvider:"groq",decisionProvider:"groq",leadDetectionProvider:"openai",groqModel:"openai/gpt-oss-120b",openaiModel:"gpt-5-mini"},Pe=["openai","groq"],De=["openai/gpt-oss-20b","openai/gpt-oss-120b","llama-3.3-70b-versatile","llama-3.1-8b-instant","moonshotai/kimi-k2-instruct-0905"],Ie=["gpt-5-mini","gpt-5-nano","gpt-4.1-nano","gpt-4.1-mini"];function fe(e,t,n,o){const s=typeof e=="number"?e:Number(e);if(!Number.isFinite(s))return o;const a=Math.round(s);return Math.min(n,Math.max(t,a))}function V(e,t,n,o){const s=typeof e=="number"?e:Number(e);return Number.isFinite(s)?Math.min(n,Math.max(t,Math.floor(s))):o}function B(e,t){return typeof e!="string"?t:e}function ee(e,t){return typeof e=="string"&&Pe.includes(e)?e:t}function _e(e,t){return typeof e=="string"&&De.includes(e)?e:t}function xe(e,t){return typeof e=="string"&&Ie.includes(e)?e:t}function Wt(e){return e}function Ne(e){return e.trim()}async function te(){return new Promise(e=>{chrome.storage.local.get(Object.values(k),t=>{const n=V(t[k.chatMinDelay],250,6e4,S.chatMinDelay),o=V(t[k.chatMaxDelay],250,12e4,S.chatMaxDelay),s=V(t[k.loopMinDelay],500,6e5,S.loopMinDelay),a=V(t[k.loopMaxDelay],500,6e5,S.loopMaxDelay),r=Math.min(n,o),i=Math.max(n,o),c=Math.min(s,a),u=Math.max(s,a),p=fe(t[k.startHour],0,23,S.startHour),h=fe(t[k.endHour],0,23,S.endHour),w={openaiApiKey:B(t[k.openaiApiKey],S.openaiApiKey).trim(),groqApiKey:B(t[k.groqApiKey],S.groqApiKey).trim(),webhookUrl:Ne(B(t[k.webhookUrl],S.webhookUrl)),replyPrompt:B(t[k.replyPrompt],S.replyPrompt),leadPrompt:B(t[k.leadPrompt],S.leadPrompt),chatMinDelay:r,chatMaxDelay:i,loopMinDelay:c,loopMaxDelay:u,startHour:p,endHour:h,replyProvider:ee(t[k.replyProvider],S.replyProvider),decisionProvider:ee(t[k.decisionProvider],S.decisionProvider),leadDetectionProvider:ee(t[k.leadDetectionProvider],S.leadDetectionProvider),groqModel:_e(t[k.groqModel],S.groqModel),openaiModel:xe(t[k.openaiModel],S.openaiModel)};e(w)})})}const Oe=["not interested","no thanks","no thank","not now","too busy","maybe later","not a fit","no overlap","policy","not allowed","stop","unsubscribe","no, thank you","no thank you","no thankyou","nope","nah"],Re=["sure","ok","okay","k","thx","thanks"];async function Le(e){const t=await te();return e==="groq"?t.groqModel:t.openaiModel}async function ne(e,t,n,o=60){var a,r,i,c;const s=await Le(n);if(n==="groq"){const u=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,messages:[{role:"user",content:t}],max_tokens:o,temperature:.2})});if(!u.ok)throw new Error(`Groq API error: ${u.status}`);return((c=(i=(r=(a=(await u.json()).choices)==null?void 0:a[0])==null?void 0:r.message)==null?void 0:i.content)==null?void 0:c.trim())||""}else{const u=await fetch("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,input:t})});if(!u.ok)throw new Error(`OpenAI API error: ${u.status}`);const p=await u.json();if(p.output_text)return p.output_text.trim();if(p.output&&Array.isArray(p.output)){for(const h of p.output)if(h.type==="message"&&h.content){for(const w of h.content)if(w.type==="output_text"&&w.text)return w.text.trim()}}return""}}async function $e(e,t,n,o="openai"){var O;if(t.length===0)return{shouldReply:!1,reason:"Empty conversation"};const s=t[t.length-1],a=s.message.toLowerCase().trim(),r=t.filter(m=>m.speaker!==n),i=t.filter(m=>m.speaker===n);if(Oe.some(m=>a.includes(m)))return{shouldReply:!1,reason:"Lead disengaged"};if(Re.includes(a)&&r.length>0){const m=r[r.length-1].message.toLowerCase();if(m.includes("no overlap")||m.includes("reach out if")||m.includes("feel free to reach out")||m.includes("not a fit")||m.includes("no problem")||m.includes("thanks for letting me know"))return{shouldReply:!1,reason:"Ack after close"}}const c=r.length>0&&r[r.length-1].message.includes("?"),u=i[i.length-1]===s,p=r.length?t.findIndex(m=>m===r[r.length-1]):-1,h=t.length-1;if(c&&u&&h>p)return{shouldReply:!0,reason:"They answered my question"};const w=s.message.split(" ").length<20,P=r.length>0&&i.length>0;if(w&&P&&r.length>=2)return{shouldReply:!0,reason:"Short but engaged response"};if(["yes","yeah","sure","absolutely","definitely","interested","sounds good","tell me more","how does","what about","can you","could you","would love to","want to know","curious about","?"].some(m=>a.includes(m)))return{shouldReply:!0,reason:"Positive engagement detected"};const N=`You are analyzing a LinkedIn conversation to decide if a response is needed.

CONVERSATION (last 20 messages):
${t.slice(-20).map(m=>`${m.speaker}: ${m.message}`).join(`
`)}

CONTEXT: The lead just sent: "${s.message}"

Rules:
- REPLY if they asked a question, answered my question, or showed interest.
- SKIP if they rejected, said no, not interested, policy/no allowance, or gave a short acknowledgment after my closing message.
- Be biased to REPLY only when there's real engagement; otherwise SKIP.

Respond ONLY with:
REPLY: [one sentence reason]
OR
SKIP: [one sentence reason]`;try{const m=await ne(e,N,o,60),$=m.toUpperCase().startsWith("REPLY"),b=((O=m.split(":")[1])==null?void 0:O.trim())||"AI decision";return{shouldReply:$,reason:b}}catch(m){return console.error("âŒ AI decision check failed:",m),{shouldReply:!0,reason:"AI error - defaulting to engage"}}}async function Ue(e,t,n,o,s="openai"){var r;if(t.length===0)return{shouldEngage:!1,reason:"No messages to evaluate"};const a=t.join(" ").toLowerCase();if(a.includes("?"))return{shouldEngage:!0,reason:"Message contains a question"};if(a.split(/\s+/).length>15)return{shouldEngage:!0,reason:"Substantial message content"};if(n==="pending_meeting"&&o<=7){const i=`You are analyzing LinkedIn messages to decide if we should RESPOND.

CONTEXT: 
- We sent a scheduling link previously
- They confirmed interest and we have a pending meeting
- It's been ${o} day(s) since they confirmed
- They just sent these messages:

${t.map((c,u)=>`${u+1}. "${c}"`).join(`
`)}

QUESTION: Are they following up to schedule, asking a question, or showing engagement?

Consider:
- Casual questions like "how about you?" or "and you?" = ENGAGE
- Greetings followed by "hope you're doing well" type messages = ENGAGE
- Simple "hi" or "hey" with nothing else = might be SKIP
- Any question, even casual = ENGAGE

Reply with ONLY:
ENGAGE: [brief reason]
OR
SKIP: [brief reason]`;try{const c=await ne(e,i,s,50),u=c.toUpperCase().startsWith("ENGAGE"),p=((r=c.split(":")[1])==null?void 0:r.trim())||"AI decision";return{shouldEngage:u,reason:p}}catch(c){return console.error("âŒ Engagement check failed:",c),{shouldEngage:!0,reason:"AI error - defaulting to engage"}}}return(n==="my_close"||o>7)&&a.split(/\s+/).length<=5?{shouldEngage:!1,reason:`Short message during cooldown (${o} days)`}:{shouldEngage:!0,reason:"Default to engage"}}async function qe(e,t,n,o="openai"){const s=`You are an AI assistant helping identify qualified leads.
Rule: ${t}
Analyze the following two LinkedIn messages: ${n.join(`
`)}
Respond with only one word: "yes" or "no".`;try{return(await ne(e,s,o,10)).toLowerCase()==="yes"}catch(a){return console.error("âŒ GPT lead check failed:",a),!1}}async function Fe(e){const{webhookUrl:t}=await te();if(!t||t.trim().length===0)throw new Error("Webhook URL is not configured. Please set it in Options.");const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok){const o=await n.text().catch(()=>"Unknown error");throw console.error("âŒ Webhook error:",o),new Error(`Webhook error: ${n.status}`)}console.log("âœ… Lead sent to webhook successfully")}const oe="conversation_histories",ge=500,Be=6e4;function je(e,t){const n=`${e}_${t}`;return btoa(unescape(encodeURIComponent(n))).substring(0,32)}async function ye(){return new Promise(e=>{chrome.storage.local.get([oe],t=>{e(t[oe]||{})})})}async function Ge(e){return(await ye())[e]||null}async function se(e){const t=await ye();return e.messages.length>ge&&(e.messages=e.messages.slice(-ge)),t[e.leadId]=e,new Promise(n=>{chrome.storage.local.set({[oe]:t},()=>{n()})})}function He(e){return e?Date.now()-e.metadata.lastSyncedAt>Be:!0}const j={headline:[".pv-text-details__left-panel h2",".text-body-medium.break-words",'div[data-view-name="profile-headline"]',".pv-top-card--list-bullet .text-body-small"],jobTitle:[".pv-text-details__left-panel .text-body-small:first-of-type",".pv-top-card--list-bullet .text-body-small:first-child"],company:[".pv-text-details__left-panel .text-body-small.inline a",'a[data-field="experience_company_logo"]',".experience-item__company"],location:[".pv-text-details__left-panel .text-body-small:last-of-type","span.text-body-small.inline.t-black--light.break-words",".pv-top-card--list-bullet .text-body-small:last-child"],connectionDegree:[".dist-value","span.dist-value",".pv-top-card--list-bullet span.dist-value"]},Ke=/(status is (online|offline|reachable|active now))/i;function G(e){var t;for(const n of e){const o=document.querySelector(n);if((t=o==null?void 0:o.textContent)!=null&&t.trim())return o.textContent.trim()}return""}function Ye(e){if(!e)return"";const t=e.split(`
`).map(o=>o.trim()).filter(o=>o&&!Ke.test(o.toLowerCase())).join(" ").replace(/\s+/g," ").trim();return t.split(" ").filter(Boolean).length<3?"Unknown":t}function We(){var t,n;let e=G(j.headline);if(!e){const o=(n=(t=document.querySelector(".msg-thread__link-to-profile"))==null?void 0:t.textContent)==null?void 0:n.trim();o&&(e=o)}return Ye(e)}function Ve(){return G(j.jobTitle).replace(/^at\s+/i,"").trim()||"Unknown"}function ze(){let e=G(j.company);return e=e.replace(/^at\s+/i,"").trim(),e||"Unknown"}function Je(){return G(j.location)||"Unknown"}function Qe(){let e=G(j.connectionDegree);const t=e.match(/(\d+(?:st|nd|rd|th))/);return t?t[1]:e||"Unknown"}function Xe(){return{headline:We(),jobTitle:Ve(),company:ze(),location:Je(),connectionDegree:Qe(),lastScraped:Date.now()}}function H(e,t){if(!t)return e;const n=[];t.jobTitle&&t.jobTitle!=="Unknown"&&n.push(t.jobTitle),t.company&&t.company!=="Unknown"&&n.push(`@ ${t.company}`),t.location&&t.location!=="Unknown"&&n.push(t.location);const o=n.length>0?` (${n.join(", ")})`:"";return`${e}${o}`}function Ze(e){if(!e)return"Profile: Not available";const t=[];return e.headline&&e.headline!=="Unknown"&&t.push(`Headline: ${e.headline}`),e.jobTitle&&e.jobTitle!=="Unknown"&&t.push(`Job Title: ${e.jobTitle}`),e.company&&e.company!=="Unknown"&&t.push(`Company: ${e.company}`),e.location&&e.location!=="Unknown"&&t.push(`Location: ${e.location}`),e.connectionDegree&&e.connectionDegree!=="Unknown"&&t.push(`Connection: ${e.connectionDegree}`),t.length?t.join(" | "):"Profile: Not available"}function et(e,t){const n=e.split(" ").length>40,o=t.lastMessageQuestions>0;return n||o}function tt(e,t){const n=[nt,ot,st,at];for(const o of n){const s=o(e);if(s)return s}return null}function nt(e){const t=e.split(/[.!?]/).filter(a=>a.trim());if(t.length<3)return null;const n=Math.floor(t.length/2),o=t.slice(0,n).join(". ").trim(),s=t.slice(n).join(". ").trim();return o.length<20||s.length<10?null:{firstMessage:o,secondMessage:s,delayMs:3e3+Math.random()*4e3,pattern:"price_breakdown"}}function ot(e){const t=e.split(/[.!?]/).filter(r=>r.trim());if(t.length<2)return null;const n=t[0].trim(),o=t.slice(1).join(". ").trim(),s=["Quick note:","Also,","One more thing:"],a=s[Math.floor(Math.random()*s.length)];return{firstMessage:n,secondMessage:`${a} ${o.charAt(0).toLowerCase()}${o.slice(1)}`,delayMs:5e3+Math.random()*3e3,pattern:"afterthought"}}function st(e){if(!e.includes("?")||!e.trim().endsWith("?"))return null;const t=["No rushâ€”ballpark is fine.","Roughly is okay.","Just an estimate works."];return{firstMessage:e.trim(),secondMessage:t[Math.floor(Math.random()*t.length)],delayMs:1800+Math.random()*1200,pattern:"question_refinement"}}function at(e){if(e.split(" ").length>15||/[.!?]$/.test(e.trim())||![/^(yeah|yes|yep|sure|sounds good|makes sense|got it|perfect)/i].some(s=>s.test(e)))return null;const o=["ðŸ‘","ðŸ‘Œ","âœ…"];return{firstMessage:e.trim(),secondMessage:o[Math.floor(Math.random()*o.length)],delayMs:1500+Math.random()*1500,pattern:"emoji_followup"}}function rt(e){const n={price_breakdown:3e3,afterthought:5e3,question_refinement:1800,emoji_followup:1500}[e]??3e3,o=n*.4;return n+(Math.random()-.5)*2*o}let T=!1,C=!1,z=null,K={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:null,tokensUsed:0,currentModel:""},Y=[],ae=!1,D=null,re=[];const it=["student","intern","seeking","open to work","looking for","hiring"],lt=["no overlap","not a fit","reach out if","feel free to reach out","thanks for letting me know","happy to stay connected","best of luck","good luck with","wishing you","take care","all the best","not what you're looking for","doesn't seem like a match","maybe in the future","keep in touch"],ct=["schedule","reschedule","next week","after jan","after january","after the","let's","lets","call","meet","demo","walkthrough","chat soon","talk soon","talk then","sounds good","works for me","perfect","great","book","calendar","calendly","outlook"],ut=["no problem","no worries","sure thing","of course","absolutely","definitely"],dt=["calendly.com","cal.com","outlook.office.com/book","hubspot.com/meetings","savvycal.com","tidycal.com","book a time","grab time","schedule a call","schedule a chat","book a call","here's a link","here is a link","whenever works","pick a time","find a time"],pt=["sounds good","sounds great","perfect","will do","see you then","looking forward","look forward","talk soon","talk then","catch you","thanks for sharing","thank you for sharing","i'll check","i will check","let me check","booked","scheduled","confirmed","done","great, thanks","awesome","cool","ok great","okay great","works for me"],mt=["hi","hey","hello","hii","hiii","heyy","heyyy","yo","sup","morning","good morning","good afternoon","good evening","gm"],ht=[{pattern:"vacation",reason:"vacation"},{pattern:"holiday",reason:"holiday"},{pattern:"traveling",reason:"traveling"},{pattern:"travel",reason:"travel"},{pattern:"out of office",reason:"out of office"},{pattern:"out of town",reason:"out of town"},{pattern:"busy",reason:"busy schedule"},{pattern:"swamped",reason:"busy schedule"},{pattern:"hectic",reason:"busy schedule"},{pattern:"next week",reason:"timing"},{pattern:"after the",reason:"timing"},{pattern:"after jan",reason:"new year"},{pattern:"after january",reason:"new year"},{pattern:"new year",reason:"new year"}],ft={"openai/gpt-oss-20b":"GPT-OSS 20B","openai/gpt-oss-120b":"GPT-OSS 120B","llama-3.3-70b-versatile":"Llama 3.3 70B","llama-3.1-8b-instant":"Llama 3.1 8B","moonshotai/kimi-k2-instruct-0905":"Kimi K2","gpt-5-mini":"GPT-5 mini","gpt-5-nano":"GPT-5 nano","gpt-4.1-nano":"GPT-4.1 nano","gpt-4.1-mini":"GPT-4.1 mini"};function g(e){return new Promise(t=>setTimeout(t,e))}async function we(e,t=3,n=1e3){let o=0;for(;;){const s=await e();if(s.ok)return s;if((s.status===429||s.status>=500)&&o<t){const a=n*2**o+Math.random()*400;await g(a),o++;continue}return s}}function l(e,t,n){const o={time:Date.now(),type:e,message:t,actor:n};Y.unshift(o),Y.length>100&&Y.pop(),chrome.storage.local.set({botLog:Y.slice(0,50)})}function L(e,t){e==="startTime"?K.startTime=t:e==="currentModel"?K.currentModel=t:K[e]+=t}function ie(e){return 2e3+e.split(" ").length*300+Math.random()*2e3}function gt(e=9,t=18){const n=new Date().getHours();return n>=e&&n<t}async function le(e,t){e.focus(),await g(50),document.execCommand("selectAll",!1,""),document.execCommand("delete",!1,"");for(const n of t)document.execCommand("insertText",!1,n),await g(Math.random()>.9?150:30+Math.random()*50)}async function yt(){const e=document.querySelector(".msg-s-message-list-content");e&&(e.scrollBy(0,Math.random()*80+20),await g(300+Math.random()*500),e.scrollBy(0,-(Math.random()*50+10)),await g(300+Math.random()*500))}async function wt(e=5){const t=document.querySelector(".msg-conversations-container--inbox-shortcuts");if(t)for(let n=0;n<e;n++)t.scrollBy({top:Math.random()*200+100,behavior:"smooth"}),await g(500+Math.random()*800),t.scrollBy({top:-(Math.random()*50),behavior:"smooth"}),await g(400+Math.random()*500)}function ce(e,t,n){return e==="groq"?n:t}function kt(e,t,n){return e==="groq"?t:n}async function St(){const e=await te();return{apiKey:e.openaiApiKey,groqApiKey:e.groqApiKey,chatMin:e.chatMinDelay,chatMax:e.chatMaxDelay,loopMin:e.loopMinDelay,loopMax:e.loopMaxDelay,prompt:e.replyPrompt,leadPrompt:e.leadPrompt,webhookUrl:e.webhookUrl,startHour:e.startHour,endHour:e.endHour,replyProvider:e.replyProvider,decisionProvider:e.decisionProvider,leadDetectionProvider:e.leadDetectionProvider,groqModel:e.groqModel,openaiModel:e.openaiModel}}function bt(){var t;const e=document.evaluate('//*[@id="thread-detail-jump-target"]/div/a/div/dl/dt/h2',document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||null}function Mt(){const e=document.querySelector('a[href*="/in/"]');return(e==null?void 0:e.href)||window.location.href}function vt(e){var a,r;const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));let n=null;const o=[];for(const i of t){const c=i.querySelector("span.msg-s-message-group__name"),u=i.querySelector("p.msg-s-event-listitem__body");if(c&&(n=((a=c.textContent)==null?void 0:a.trim())||null),u&&n){const p=((r=u.textContent)==null?void 0:r.trim())||"";p&&o.push({sender:n,content:p})}}if(o.length===0)return null;const s=o[o.length-1];return{fromLead:s.sender.includes(e),content:s.content}}function Tt(e,t=5){var a,r;const n=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));let o=null;const s=[];for(const i of n){const c=i.querySelector("span.msg-s-message-group__name"),u=i.querySelector("p.msg-s-event-listitem__body");if(c&&(o=((a=c.textContent)==null?void 0:a.trim())||null),u&&o&&o.includes(e)){const p=((r=u.textContent)==null?void 0:r.trim())||"";p&&s.push(p)}}return s.slice(-t)}async function At(){const e=document.querySelector(".msg-s-message-list-content");if(!e)return;let t=0,n=e.scrollHeight,o=0;for(l("INFO","Loading full conversation history...","System");n>t&&o<50;)t=n,e.scrollTo({top:0,behavior:"smooth"}),await g(800+Math.random()*400),n=e.scrollHeight,o++;l("INFO",`Loaded ${o} message batches`,"System")}async function Et(e){var s,a;await At();const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event")),n=[];let o=null;for(const r of t){const i=r.querySelector("span.msg-s-message-group__name"),c=r.querySelector("p.msg-s-event-listitem__body"),u=r.querySelector("time");if(i&&(o=((s=i.textContent)==null?void 0:s.trim())||null),c&&o){const p=((a=c.textContent)==null?void 0:a.trim())||"";let h=Date.now();if(u){const w=u.getAttribute("datetime");w&&(h=new Date(w).getTime())}p&&n.push({speaker:o,content:p,timestamp:h,type:o.includes(e)?"received":"sent"})}}return n}async function Ct(e){var c;const t=Mt(),n=je(e,t);let o=await Ge(n);if(o&&!He(o))return l("INFO",`Using cached data for ${H(e,o.profile)} (${o.messages.length} msgs)`,"System"),o;l("INFO",`Scraping profile for ${e}...`,"System");const s=Xe();l("INFO",`Syncing full history for ${e}...`,"System");const a=await Et(e),r=a[a.length-1],i={leadId:n,leadName:e,profileUrl:t,profile:s,messages:a,metadata:{firstContact:((c=a[0])==null?void 0:c.timestamp)||Date.now(),lastActivity:(r==null?void 0:r.timestamp)||Date.now(),lastMessageFrom:(r==null?void 0:r.type)==="received"?"lead":"me",totalMessages:a.length,lastSyncedAt:Date.now()}};return await se(i),l("SUCCESS",`Saved ${a.length} messages + profile for ${H(e,s)}`,"System"),i}function ke(e){const t=e.toLowerCase();return dt.some(n=>t.includes(n))}function ue(e){const t=e.toLowerCase().trim();return t.split(/\s+/).length>10?!1:pt.some(n=>t.includes(n))}function Pt(e){const t=e.toLowerCase().trim();return t.split(/\s+/).length>3?!1:mt.some(n=>t===n||t.startsWith(n+" "))}function Se(e){return ct.some(t=>e.toLowerCase().includes(t))}function Dt(e){const t=e.toLowerCase();return ut.some(n=>t.includes(n))&&Se(e)}function It(e){for(let t=e.length-1;t>=1;t--){const n=e[t],o=e[t-1];if(o.type==="sent"&&n.type==="received"&&ke(o.content)&&ue(n.content))return n.timestamp;if(t>=2){const s=e[t-2];if(s.type==="received"&&o.type==="sent"&&n.type==="received"){const a=s.content.toLowerCase();if((a.includes("schedule")||a.includes("after")||a.includes("next week")||a.includes("vacation")||a.includes("holiday"))&&ue(n.content))return n.timestamp}}}return null}function _t(e){for(let t=e.length-1;t>=0;t--){const n=e[t];if(n.type==="sent"){const o=n.content.toLowerCase();if(Se(n.content)||Dt(n.content))continue;if(lt.some(s=>o.includes(s)))return n.timestamp}}return null}function xt(e){const t=It(e);if(t)return{isClosed:!0,closeType:"pending_meeting",closeTimestamp:t,reason:"Meeting scheduled"};const n=_t(e);return n?{isClosed:!0,closeType:"my_close",closeTimestamp:n,reason:"I closed the conversation"}:{isClosed:!1,closeType:"none",closeTimestamp:null,reason:""}}async function Nt(e,t,n,o){if(!e.isClosed||!e.closeTimestamp)return{shouldSkip:!1,reason:""};const s=Date.now()-e.closeTimestamp,a=Math.round(s/(1e3*60*60*24));l("INFO",`Checking engagement with AI (${a} days since close)...`,"System");const r=await Ue(n,t,e.closeType,a,o);return{shouldSkip:!r.shouldEngage,reason:r.reason}}function Ot(e){return e==="Unknown"?!0:it.some(t=>e.toLowerCase().includes(t))}function Rt(e){const t=Date.now(),n=e[e.length-1],o=(n==null?void 0:n.timestamp)||t,s=Math.floor((t-o)/(1e3*60*60*24));let a=!1,r=null,i=!1,c=!1,u=null,p=!1;for(const h of e){const w=h.content.toLowerCase();if(h.type==="sent"&&ke(h.content)&&(a=!0,r=h.timestamp),h.type==="received"){ue(h.content)&&(i=!0),["tell me more","interested","sounds interesting","would be great","please","yes please","walkthrough","demo","show me"].some(P=>w.includes(P))&&(p=!0);for(const{pattern:P,reason:I}of ht)if(w.includes(P)){c=!0,u=I;break}}}return{schedulingLinkSent:a,schedulingLinkTimestamp:r,leadConfirmedInterest:i,reschedulingRequested:c,reschedulingReason:u,daysSinceLastActivity:s,lastMessageIsShortPing:n?Pt(n.content):!1,iSentLastMessage:(n==null?void 0:n.type)==="sent",leadShowedStrongInterest:p}}function Lt(e,t,n){const o=Rt(e),s=e.length;let a="active",r="",i="",c="";return s<4?(a="new",r="New conversation - still building rapport",i="This is a fresh conversation.",c="Be friendly and conversational. Don't push too hard - build rapport first."):t.closeType==="pending_meeting"?(a="pending_meeting",o.reschedulingRequested&&o.reschedulingReason?(r=`Pending meeting - they asked to reschedule due to ${o.reschedulingReason}`,i="You sent a scheduling link. They asked to reschedule. Now they're back.",c=o.lastMessageIsShortPing?"Be warm and welcoming. Reference their break. Ask if they're ready to schedule.":"Answer their questions and offer to schedule."):(r="Pending meeting - scheduling link sent",i="You already sent a scheduling link and they showed interest.",c="Be helpful. Acknowledge warmly and offer to help schedule.")):t.closeType==="my_close"?(a="closed",r="Conversation was closed/declined",i="You previously closed this conversation politely.",c="Be polite but brief. Don't re-pitch aggressively."):o.daysSinceLastActivity>14?(a="re_engaging",r=`Re-engaging after ${o.daysSinceLastActivity} days`,i=`It's been ${o.daysSinceLastActivity} days since the last message.`,c="Acknowledge the time gap briefly. Don't be pushy."):(a="active",r=o.leadShowedStrongInterest?"Active - lead has shown strong interest":"Active conversation",i="Ongoing conversation.",c="Be helpful and natural. Match their energy."),o.lastMessageIsShortPing&&a!=="pending_meeting"&&(c+=" Their last message was a short greeting - respond warmly first."),{state:a,stateDescription:r,keyContextSummary:i,responseGuidance:c}}async function $t(e,t,n,o,s,a,r,i,c){var N,O,m,$;const u=n.slice(-30),p=u.map(b=>`${b.speaker}: ${b.content}`).join(`
`),h=Lt(n,c||{closeType:"none"}),w=a?`
LEAD PROFILE:
${Ze(a)}
`:"",P=t.replace("{extracted_text}",p).replace("{user_name}",o).replace("{lead_headline}",(a==null?void 0:a.headline)||"Unknown"),I=`You are a real professional messaging on LinkedIn (NOT an AI assistant).
${w}
=== CONVERSATION STATE ===
STATE: ${h.stateDescription}
CONTEXT: ${h.keyContextSummary}

=== RESPONSE GUIDANCE ===
${h.responseGuidance}

=== CONVERSATION HISTORY ===
${p}

USER'S INSTRUCTIONS:
${P}

CRITICAL RULES:
1. LENGTH: 15-30 words. Be concise.
2. TONE: Match their energy.
3. NATURAL: Use contractions. Be conversational.
4. If they say "hi" or "how are you", respond warmly FIRST, then ask how you can help.
5. Don't immediately send links after a greeting.
6. Reference shared context naturally.

Respond as ${s}.`;if(r==="groq"){const b=await we(()=>fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:i,messages:[{role:"system",content:I},...u.map(M=>({role:M.type==="received"?"user":"assistant",content:M.content}))],max_tokens:250,temperature:.7})}),3,1e3);if(!b.ok){const M=await b.text();throw new Error(`Groq API Error ${b.status}: ${M.slice(0,500)}`)}const _=await b.json(),A=(((N=_.usage)==null?void 0:N.prompt_tokens)||0)+(((O=_.usage)==null?void 0:O.completion_tokens)||0);return{reply:_.choices[0].message.content.trim(),tokensUsed:A}}else{const b=[{role:"developer",content:I},...u.map(E=>({role:E.type==="received"?"user":"assistant",content:E.content}))],_=await we(()=>fetch("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:i,input:b})}),3,1e3);if(!_.ok){const E=await _.text();throw new Error(`OpenAI API Error ${_.status}: ${E.slice(0,500)}`)}const A=await _.json();let M="";const U=(((m=A.usage)==null?void 0:m.input_tokens)||0)+((($=A.usage)==null?void 0:$.output_tokens)||0);if(A.output_text)M=A.output_text;else if(A.output&&Array.isArray(A.output))for(const E of A.output){if(E.type==="message"&&E.content){for(const q of E.content)if(q.type==="output_text"&&q.text){M=q.text;break}}if(M)break}if(!M)throw new Error("OpenAI returned empty response - no text content found");return{reply:M.trim(),tokensUsed:U}}}function Ut(){var t;const e=document.querySelector(".global-nav__me-content span");return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||"You"}function qt(e){return ft[e]||e}function Ft(e){return e==="groq"?"Groq":"OpenAI"}function Bt(e,t){var o,s;const n=[e.toLowerCase(),((o=t==null?void 0:t.company)==null?void 0:o.toLowerCase())||"",((s=t==null?void 0:t.jobTitle)==null?void 0:s.toLowerCase())||""];for(const a of re){const r=a.toLowerCase();for(const i of n)if(i&&i.includes(r))return!0}return!1}async function jt(e,t){return new Promise(n=>{D=n,chrome.storage.local.set({pendingReply:{leadName:e,reply:t,timestamp:Date.now()}}),l("INFO",`Waiting for approval to reply to ${e}...`,"System"),setTimeout(()=>{D&&(l("WARNING",`Reply approval timed out for ${e}`,"System"),D({approved:!1,reply:""}),D=null,chrome.storage.local.remove(["pendingReply"]))},5*60*1e3)})}async function be(e,t=6,n=400){for(let o=0;o<t;o++){const s=document.querySelector(e);if(s)return s;await g(n)}return null}function Me(e,t){return g(Math.floor(Math.random()*(t-e+1))+e)}function de(e){return typeof e=="string"?e:e&&typeof e=="object"&&"message"in e?e.message:"Unknown error"}async function pe(e){var q,ve,Te,Ae,Ee,Ce;l("INFO",`Starting batch of ${e} chats...`,"System");const t=await St(),{apiKey:n,groqApiKey:o,chatMin:s,chatMax:a,loopMin:r,loopMax:i,prompt:c,leadPrompt:u,webhookUrl:p,startHour:h,endHour:w,replyProvider:P,decisionProvider:I,leadDetectionProvider:N,groqModel:O,openaiModel:m}=t,$=ce(P,n,o),b=ce(I,n,o),_=ce(N,n,o),A=kt(P,O,m),M=qt(A);if(L("currentModel",M),re=(await chrome.storage.local.get(["blacklist"])).blacklist||[],!gt(h,w)){l("WARNING",`Outside working hours (${h}-${w}). Pausing.`,"System"),T&&!C&&(z=window.setTimeout(()=>pe(e),15*60*1e3));return}const U=Ut();await wt(5);let E=Array.from(document.querySelectorAll("ul.msg-conversations-container__conversations-list li")).slice(0,e).sort(()=>Math.random()-.2);l("INFO",`Found ${E.length} conversations to check.`,"Bot");for(let me=0;me<E.length&&T;me++){for(;C&&T;)await g(1e3);if(!T)break;await yt(),await Me(s,a);const he=E[me].querySelector("a, .msg-conversation-listitem__link, [tabindex='0']");he==null||he.click(),await g(2e3);const f=bt();if(!f)continue;const J=vt(f);if(!J||!J.fromLead){l("INFO",`Skipping ${f}: Last message was from me.`,"Bot");continue}const Gt=Tt(f,5),d=await Ct(f),Q=xt(d.messages);if(Q.isClosed){const y=await Nt(Q,Gt,b,I);if(y.shouldSkip){l("INFO",`Skipping ${f}: ${y.reason} [AI/${Q.closeType}]`,"Bot");continue}l("INFO",`Engaging ${f}: ${y.reason} [AI]`,"Bot")}const Ht=((q=d.profile)==null?void 0:q.headline)||"Unknown";if(Ot(Ht)&&!J.content.includes("?")&&J.content.split(" ").length<12){l("INFO",`Skipping ${f}: Irrelevant headline`,"Bot");continue}if(Bt(f,d.profile)){l("WARNING",`Skipping ${f}: Blacklisted`,"Bot");continue}if(l("INFO",`Checking chat with ${H(f,d.profile)}...`,"Bot"),L("chatsProcessed",1),d.messages.length===0){l("WARNING",`No messages found for ${f}`,"System");continue}const Kt=d.messages.slice(-8).map(y=>({speaker:y.speaker,message:y.content}));let X;try{X=await $e(b,Kt,f,I),l("ACTION",`AI Decision: ${X.shouldReply?"REPLY":"SKIP"} (${X.reason}) [${Ft(I)}]`,"Bot")}catch(y){l("ERROR",`AI Decision Failed: ${de(y)}`,"System");continue}if(!X.shouldReply)continue;if(p)try{const y=d.messages.slice(-2).map(v=>v.content);if(await qe(_,u,y,N)){const v={leadName:f,profileUrl:d.profileUrl,company:((ve=d.profile)==null?void 0:ve.company)||"Unknown",jobTitle:((Te=d.profile)==null?void 0:Te.jobTitle)||"Unknown",headline:((Ae=d.profile)==null?void 0:Ae.headline)||"Unknown",conversationHistory:d.messages.map(x=>`${x.speaker}: ${x.content}`).join(`
`),messageCount:d.messages.length,detectedAt:new Date().toISOString()};await Fe(v),L("leadsFound",1),l("SUCCESS",`ðŸ”¥ HOT LEAD: ${f} sent to webhook!`,"Bot")}}catch(y){l("ERROR",`Lead webhook failed: ${de(y)}`,"System")}let Z;try{Z=await $t($,c,d.messages,f,U,d.profile,P,A,Q),L("tokensUsed",Z.tokensUsed)}catch(y){l("ERROR",`Reply Generation Failed: ${de(y)}`,"System");continue}let F=Z.reply;if(ae){const y=await jt(f,Z.reply);if(!y.approved){l("INFO",`Reply to ${f} skipped by user`,"User");continue}F=y.reply}const W=await be("div.msg-form__contenteditable[role='textbox']",6,400),R=await be("button.msg-form__send-button",6,400);if(W&&R){const y={messageCount:d.messages.length,lastMessageQuestions:(((Ee=d.messages[d.messages.length-1])==null?void 0:Ee.content.match(/\?/g))||[]).length},v=et(F,y)?tt(F):null;if(v){if(l("ACTION",`Double-texting ${f} (${v.pattern})...`,"Bot"),await g(ie(v.firstMessage)),await le(W,v.firstMessage),await g(800),!R.hasAttribute("disabled")){R.click(),await g(500);const x=rt(v.pattern);l("INFO",`Waiting ${Math.round(x/1e3)}s before second message...`,"Bot"),await g(x),await g(ie(v.secondMessage)),await le(W,v.secondMessage),await g(800),R.hasAttribute("disabled")||(R.click(),await g(500),L("repliesSent",1),d.messages.push({speaker:U,content:v.firstMessage,timestamp:Date.now()-x,type:"sent"},{speaker:U,content:v.secondMessage,timestamp:Date.now(),type:"sent"}),d.metadata.lastActivity=Date.now(),d.metadata.lastMessageFrom="me",d.metadata.totalMessages+=2,d.metadata.lastSyncedAt=Date.now(),await se(d),l("SUCCESS",`Double-texted ${H(f,d.profile)} (${M})`,"Bot"))}}else{const x=ie(F);l("ACTION",`Typing reply to ${f} (waiting ${Math.round(x/1e3)}s)...`,"Bot"),await g(x),await le(W,F),await g(800),R.hasAttribute("disabled")?l("ERROR",`Send button disabled for ${f}`,"System"):(R.click(),await g(500),(((Ce=W.textContent)==null?void 0:Ce.trim())||"").length===0?(L("repliesSent",1),d.messages.push({speaker:U,content:F,timestamp:Date.now(),type:"sent"}),d.metadata.lastActivity=Date.now(),d.metadata.lastMessageFrom="me",d.metadata.totalMessages++,d.metadata.lastSyncedAt=Date.now(),await se(d),l("SUCCESS",`Sent reply to ${H(f,d.profile)} (${M})`,"Bot")):l("WARNING",`Message may not have sent to ${f}`,"System"))}}else l("ERROR","Could not find chat input or send button","System");await Me(s,a)}l("INFO","Batch finished. Sleeping...","System"),T&&!C&&(z=window.setTimeout(()=>pe(e),Math.floor(Math.random()*(i-r+1))+r))}chrome.runtime.onMessage.addListener((e,t,n)=>{var o,s,a;if(e.type==="PING_TEST"){n("âœ… Content script active!");return}if(e.type==="GET_STATUS"){n({running:T,paused:C,stats:K,logs:Y});return}if(e.type==="START_BOT"){if(T)n({status:"error",error:"Already running"});else{T=!0,C=!1,K={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:Date.now(),tokensUsed:0,currentModel:""},ae=((o=e.config)==null?void 0:o.replyPreviewEnabled)??!1,re=((s=e.config)==null?void 0:s.blacklist)??[];const r=((a=e.config)==null?void 0:a.nChats)??10;l("INFO",`Bot started (Preview: ${ae?"ON":"OFF"})`,"User"),pe(r),n({status:"ok"})}return}if(e.type==="STOP_BOT"){T=!1,C=!1,z!==null&&clearTimeout(z),l("INFO","Bot stopped by user","User"),n({status:"stopped"});return}if(e.type==="PAUSE_BOT"){T&&!C?(C=!0,l("INFO","Bot paused by user","User"),n({status:"paused"})):n({status:"error",error:"Not running or already paused"});return}if(e.type==="RESUME_BOT"){T&&C?(C=!1,l("INFO","Bot resumed by user","User"),n({status:"running"})):n({status:"error",error:"Not paused"});return}if(e.type==="APPROVE_REPLY"){D&&(l("SUCCESS",`Reply to ${e.leadName} approved`,"User"),D({approved:!0,reply:e.reply}),D=null,chrome.storage.local.remove(["pendingReply"])),n({status:"ok"});return}if(e.type==="REJECT_REPLY"){D&&(l("INFO",`Reply to ${e.leadName} rejected`,"User"),D({approved:!1,reply:""}),D=null,chrome.storage.local.remove(["pendingReply"])),n({status:"ok"});return}if(e.type==="CHECK_UNREAD"){T&&!C&&l("INFO","Check unread triggered by background","System"),n({status:"ok"});return}})})();
