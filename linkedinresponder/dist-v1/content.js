(function(){"use strict";const h={openaiApiKey:"openaiApiKey",groqApiKey:"groqApiKey",webhookUrl:"webhookUrl",replyPrompt:"replyPrompt",leadPrompt:"leadPrompt",chatMinDelay:"chatMinDelay",chatMaxDelay:"chatMaxDelay",loopMinDelay:"loopMinDelay",loopMaxDelay:"loopMaxDelay",startHour:"startHour",endHour:"endHour",replyProvider:"replyProvider",decisionProvider:"decisionProvider",leadDetectionProvider:"leadDetectionProvider"},w={openaiApiKey:"",groqApiKey:"",webhookUrl:"",replyPrompt:`You are {user_name}'s assistant. Reply to this lead based on context:
{extracted_text}
Reply briefly and professionally.`,leadPrompt:"Does this conversation indicate strong buying intent or interest? Reply YES or NO.",chatMinDelay:2e3,chatMaxDelay:5e3,loopMinDelay:1e4,loopMaxDelay:3e4,startHour:9,endHour:18,replyProvider:"groq",decisionProvider:"groq",leadDetectionProvider:"openai"},Pe=["openai","groq"];function we(e,t,n,o){const s=typeof e=="number"?e:Number(e);if(!Number.isFinite(s))return o;const a=Math.round(s);return Math.min(n,Math.max(t,a))}function X(e,t,n,o){const s=typeof e=="number"?e:Number(e);return Number.isFinite(s)?Math.min(n,Math.max(t,Math.floor(s))):o}function F(e,t){return typeof e!="string"?t:e}function se(e,t){return typeof e=="string"&&Pe.includes(e)?e:t}function xt(e){return e}function Ee(e){return e.trim()}async function be(){return new Promise(e=>{chrome.storage.local.get(Object.values(h),t=>{const n=X(t[h.chatMinDelay],250,6e4,w.chatMinDelay),o=X(t[h.chatMaxDelay],250,12e4,w.chatMaxDelay),s=X(t[h.loopMinDelay],500,6e5,w.loopMinDelay),a=X(t[h.loopMaxDelay],500,6e5,w.loopMaxDelay),r=Math.min(n,o),u=Math.max(n,o),p=Math.min(s,a),f=Math.max(s,a),S=we(t[h.startHour],0,23,w.startHour),y=we(t[h.endHour],0,23,w.endHour),M={openaiApiKey:F(t[h.openaiApiKey],w.openaiApiKey).trim(),groqApiKey:F(t[h.groqApiKey],w.groqApiKey).trim(),webhookUrl:Ee(F(t[h.webhookUrl],w.webhookUrl)),replyPrompt:F(t[h.replyPrompt],w.replyPrompt),leadPrompt:F(t[h.leadPrompt],w.leadPrompt),chatMinDelay:r,chatMaxDelay:u,loopMinDelay:p,loopMaxDelay:f,startHour:S,endHour:y,replyProvider:se(t[h.replyProvider],w.replyProvider),decisionProvider:se(t[h.decisionProvider],w.decisionProvider),leadDetectionProvider:se(t[h.leadDetectionProvider],w.leadDetectionProvider)};e(M)})})}const Ce=["not interested","no thanks","no thank","not now","too busy","maybe later","not a fit","no overlap","policy","not allowed","stop","unsubscribe","no, thank you","no thank you","no thankyou","nope","nah"],xe=["sure","ok","okay","k","thx","thanks"];function Se(e){return e==="groq"?"https://api.groq.com/openai/v1/chat/completions":"https://api.openai.com/v1/chat/completions"}function Me(e){return e==="groq"?"llama-3.3-70b-versatile":"gpt-4o-mini"}async function Oe(e,t,n,o="openai"){var x,$,A,E,I;if(t.length===0)return{shouldReply:!1,reason:"Empty conversation"};const s=t[t.length-1],a=s.message.toLowerCase().trim(),r=t.filter(c=>c.speaker!==n),u=t.filter(c=>c.speaker===n);if(Ce.some(c=>a.includes(c)))return{shouldReply:!1,reason:"Lead disengaged"};if(xe.includes(a)&&r.length>0){const c=r[r.length-1].message.toLowerCase();if(c.includes("no overlap")||c.includes("reach out if")||c.includes("feel free to reach out")||c.includes("not a fit")||c.includes("no problem")||c.includes("thanks for letting me know"))return{shouldReply:!1,reason:"Ack after close"}}const p=r.length>0&&r[r.length-1].message.includes("?"),f=u[u.length-1]===s,S=r.length?t.findIndex(c=>c===r[r.length-1]):-1,y=t.length-1;if(p&&f&&y>S)return{shouldReply:!0,reason:"They answered my question"};const M=s.message.split(" ").length<20,T=r.length>0&&u.length>0;if(M&&T&&r.length>=2)return{shouldReply:!0,reason:"Short but engaged response"};if(["yes","yeah","sure","absolutely","definitely","interested","sounds good","tell me more","how does","what about","can you","could you","would love to","want to know","curious about","?"].some(c=>a.includes(c)))return{shouldReply:!0,reason:"Positive engagement detected"};const W=`You are analyzing a LinkedIn conversation to decide if a response is needed.

CONVERSATION (last 20 messages):
${t.slice(-20).map(c=>`${c.speaker}: ${c.message}`).join(`
`)}

CONTEXT: The lead just sent: "${s.message}"

Rules:
- REPLY if they asked a question, answered my question, or showed interest.
- SKIP if they rejected, said no, not interested, policy/no allowance, or gave a short acknowledgment after my closing message.
- Be biased to REPLY only when there's real engagement; otherwise SKIP.

Respond ONLY with:
REPLY: [one sentence reason]
OR
SKIP: [one sentence reason]`;try{const c=Se(o),O=Me(o),b=await fetch(c,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:O,messages:[{role:"user",content:W}],temperature:.2,max_tokens:60})});if(!b.ok)return console.error(`âŒ ${o.toUpperCase()} API error in shouldReplyToConversation: ${b.status}`),{shouldReply:!0,reason:"AI check failed - defaulting to reply"};const Y=((E=(A=($=(x=(await b.json()).choices)==null?void 0:x[0])==null?void 0:$.message)==null?void 0:A.content)==null?void 0:E.trim())||"",V=Y.toUpperCase().startsWith("REPLY"),J=((I=Y.split(":")[1])==null?void 0:I.trim())||"AI decision";return{shouldReply:V,reason:J}}catch(c){return console.error("âŒ AI decision check failed:",c),{shouldReply:!0,reason:"AI error - defaulting to engage"}}}async function Re(e,t,n,o="openai"){var a,r,u,p;const s=`You are an AI assistant helping identify qualified leads.
Rule: ${t}
Analyze the following two LinkedIn messages: ${n.join(`
`)}
Respond with only one word: "yes" or "no".`;try{const f=Se(o),S=Me(o),y=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:S,messages:[{role:"user",content:s}],temperature:0,max_tokens:10})});return y.ok?((p=(u=(r=(a=(await y.json()).choices)==null?void 0:a[0])==null?void 0:r.message)==null?void 0:u.content)==null?void 0:p.trim().toLowerCase())==="yes":(console.error(`âŒ ${o.toUpperCase()} API error in checkPositiveLead: ${y.status}`),!1)}catch(f){return console.error("âŒ GPT lead check failed:",f),!1}}async function $e(e){const{webhookUrl:t}=await be();if(!t||t.trim().length===0)throw new Error("Webhook URL is not configured. Please set it in Options.");const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok){const o=await n.text().catch(()=>"Unknown error");throw console.error("âŒ Webhook error:",o),new Error(`Webhook error: ${n.status}`)}console.log("âœ… Lead sent to webhook successfully")}const ae="conversation_histories",ke=500,Ie=6e4;function Ne(e,t){const n=`${e}_${t}`;return btoa(unescape(encodeURIComponent(n))).substring(0,32)}async function ve(){return new Promise(e=>{chrome.storage.local.get([ae],t=>{e(t[ae]||{})})})}async function Le(e){return(await ve())[e]||null}async function re(e){const t=await ve();return e.messages.length>ke&&(e.messages=e.messages.slice(-ke)),t[e.leadId]=e,new Promise(n=>{chrome.storage.local.set({[ae]:t},()=>{n()})})}function _e(e){return e?Date.now()-e.metadata.lastSyncedAt>Ie:!0}const q={headline:[".pv-text-details__left-panel h2",".text-body-medium.break-words",'div[data-view-name="profile-headline"]',".pv-top-card--list-bullet .text-body-small"],jobTitle:[".pv-text-details__left-panel .text-body-small:first-of-type",".pv-top-card--list-bullet .text-body-small:first-child"],company:[".pv-text-details__left-panel .text-body-small.inline a",'a[data-field="experience_company_logo"]',".experience-item__company"],location:[".pv-text-details__left-panel .text-body-small:last-of-type","span.text-body-small.inline.t-black--light.break-words",".pv-top-card--list-bullet .text-body-small:last-child"],connectionDegree:[".dist-value","span.dist-value",".pv-top-card--list-bullet span.dist-value"]},Ue=/(status is (online|offline|reachable|active now))/i;function j(e){var t;for(const n of e){const o=document.querySelector(n);if((t=o==null?void 0:o.textContent)!=null&&t.trim())return o.textContent.trim()}return""}function Fe(e){if(!e)return"";const t=e.split(`
`).map(o=>o.trim()).filter(o=>o&&!Ue.test(o.toLowerCase())).join(" ").replace(/\s+/g," ").trim();return t.split(" ").filter(Boolean).length<3?"Unknown":t}function qe(){var t,n;let e=j(q.headline);if(!e){const o=(n=(t=document.querySelector(".msg-thread__link-to-profile"))==null?void 0:t.textContent)==null?void 0:n.trim();o&&(e=o)}return Fe(e)}function je(){return j(q.jobTitle).replace(/^at\s+/i,"").trim()||"Unknown"}function Be(){let e=j(q.company);return e=e.replace(/^at\s+/i,"").trim(),e||"Unknown"}function He(){return j(q.location)||"Unknown"}function Ke(){let e=j(q.connectionDegree);const t=e.match(/(\d+(?:st|nd|rd|th))/);return t?t[1]:e||"Unknown"}function Ge(){return{headline:qe(),jobTitle:je(),company:Be(),location:He(),connectionDegree:Ke(),lastScraped:Date.now()}}function B(e,t){if(!t)return e;const n=[];t.jobTitle&&t.jobTitle!=="Unknown"&&n.push(t.jobTitle),t.company&&t.company!=="Unknown"&&n.push(`@ ${t.company}`),t.location&&t.location!=="Unknown"&&n.push(t.location);const o=n.length>0?` (${n.join(", ")})`:"";return`${e}${o}`}function We(e){if(!e)return"Profile: Not available";const t=[];return e.headline&&e.headline!=="Unknown"&&t.push(`Headline: ${e.headline}`),e.jobTitle&&e.jobTitle!=="Unknown"&&t.push(`Job Title: ${e.jobTitle}`),e.company&&e.company!=="Unknown"&&t.push(`Company: ${e.company}`),e.location&&e.location!=="Unknown"&&t.push(`Location: ${e.location}`),e.connectionDegree&&e.connectionDegree!=="Unknown"&&t.push(`Connection: ${e.connectionDegree}`),t.length?t.join(" | "):"Profile: Not available"}function Ye(e,t){const n=e.split(" ").length>40,o=t.lastMessageQuestions>0;return n||o}function Ve(e,t){const n=[Je,Qe,ze,Xe];for(const o of n){const s=o(e);if(s)return s}return null}function Je(e){const t=e.split(/[.!?]/).filter(a=>a.trim());if(t.length<3)return null;const n=Math.floor(t.length/2),o=t.slice(0,n).join(". ").trim(),s=t.slice(n).join(". ").trim();return o.length<20||s.length<10?null:{firstMessage:o,secondMessage:s,delayMs:3e3+Math.random()*4e3,pattern:"price_breakdown"}}function Qe(e){const t=e.split(/[.!?]/).filter(r=>r.trim());if(t.length<2)return null;const n=t[0].trim(),o=t.slice(1).join(". ").trim(),s=["Quick note:","Also,","One more thing:"],a=s[Math.floor(Math.random()*s.length)];return{firstMessage:n,secondMessage:`${a} ${o.charAt(0).toLowerCase()}${o.slice(1)}`,delayMs:5e3+Math.random()*3e3,pattern:"afterthought"}}function ze(e){if(!e.includes("?")||!e.trim().endsWith("?"))return null;const t=["No rushâ€”ballpark is fine.","Roughly is okay.","Just an estimate works."];return{firstMessage:e.trim(),secondMessage:t[Math.floor(Math.random()*t.length)],delayMs:1800+Math.random()*1200,pattern:"question_refinement"}}function Xe(e){if(e.split(" ").length>15||/[.!?]$/.test(e.trim())||![/^(yeah|yes|yep|sure|sounds good|makes sense|got it|perfect)/i].some(s=>s.test(e)))return null;const o=["ðŸ‘","ðŸ‘Œ","âœ…"];return{firstMessage:e.trim(),secondMessage:o[Math.floor(Math.random()*o.length)],delayMs:1500+Math.random()*1500,pattern:"emoji_followup"}}function Ze(e){const n={price_breakdown:3e3,afterthought:5e3,question_refinement:1800,emoji_followup:1500}[e]??3e3,o=n*.4;return n+(Math.random()-.5)*2*o}let v=!1,D=!1,Z=null,H={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:null,tokensUsed:0,currentModel:""},K=[],ie=!0,le="llama-3.3-70b-versatile",ce=!1,P=null,ue=[];const et=["student","intern","seeking","open to work","looking for","hiring"],tt=14*24*60*60*1e3,nt=["no overlap","not a fit","reach out if","feel free to reach out","thanks for letting me know","no problem","happy to stay connected"];function ot(e){return new Promise(t=>setTimeout(t,e))}function m(e){return new Promise(t=>setTimeout(t,e))}async function st(e,t=3,n=1e3){let o=0;for(;;){const s=await e();if(s.ok)return s;if((s.status===429||s.status>=500)&&o<t){const a=n*2**o+Math.random()*400;await ot(a),o++;continue}return s}}function i(e,t,n){const o={time:Date.now(),type:e,message:t,actor:n};K.unshift(o),K.length>100&&K.pop(),chrome.storage.local.set({botLog:K.slice(0,50)})}function L(e,t){e==="startTime"?H.startTime=t:e==="currentModel"?H.currentModel=t:H[e]+=t}function de(e){return 2e3+e.split(" ").length*300+Math.random()*2e3}function at(e=9,t=18){const n=new Date().getHours();return n>=e&&n<t}async function pe(e,t){e.focus(),await m(50),document.execCommand("selectAll",!1,""),document.execCommand("delete",!1,"");for(const n of t){document.execCommand("insertText",!1,n);const o=Math.random()>.9?150:30+Math.random()*50;await m(o)}}async function rt(){const e=document.querySelector(".msg-s-message-list-content");if(!e)return;const t=Math.random()*80+20;e.scrollBy(0,t),await m(300+Math.random()*500),e.scrollBy(0,-(Math.random()*50+10)),await m(300+Math.random()*500)}async function it(e=5){const t=document.querySelector(".msg-conversations-container--inbox-shortcuts");if(t)for(let n=0;n<e;n++)t.scrollBy({top:Math.random()*200+100,behavior:"smooth"}),await m(500+Math.random()*800),t.scrollBy({top:-(Math.random()*50),behavior:"smooth"}),await m(400+Math.random()*500)}function me(e,t,n){return e==="groq"?n:t}async function lt(){const e=await be();return{apiKey:e.openaiApiKey,groqApiKey:e.groqApiKey,chatMin:e.chatMinDelay,chatMax:e.chatMaxDelay,loopMin:e.loopMinDelay,loopMax:e.loopMaxDelay,prompt:e.replyPrompt,leadPrompt:e.leadPrompt,webhookUrl:e.webhookUrl,startHour:e.startHour,endHour:e.endHour,replyProvider:e.replyProvider,decisionProvider:e.decisionProvider,leadDetectionProvider:e.leadDetectionProvider}}function ct(){var t;const e=document.evaluate('//*[@id="thread-detail-jump-target"]/div/a/div/dl/dt/h2',document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||null}function ut(){const e=document.querySelector('a[href*="/in/"]');return(e==null?void 0:e.href)||window.location.href}function dt(e){var n,o;const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));for(let s=t.length-1;s>=0;s--){const a=t[s],r=a.querySelector("span.msg-s-message-group__name"),u=a.querySelector("p.msg-s-event-listitem__body");if(r&&u){const p=((n=r.textContent)==null?void 0:n.trim())||"",f=((o=u.textContent)==null?void 0:o.trim())||"";if(!f)continue;return{fromLead:p.includes(e),content:f}}}return null}async function pt(){const e=document.querySelector(".msg-s-message-list-content");if(!e)return;let t=0,n=e.scrollHeight,o=0;const s=50;for(i("INFO","Loading full conversation history...","System");n>t&&o<s;)t=n,e.scrollTo({top:0,behavior:"smooth"}),await m(800+Math.random()*400),n=e.scrollHeight,o++;i("INFO",`Loaded ${o} message batches`,"System")}async function mt(e){var o,s;await pt();const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event")),n=[];for(const a of t){const r=a.querySelector("span.msg-s-message-group__name"),u=a.querySelector("p.msg-s-event-listitem__body"),p=a.querySelector("time");if(r&&u){const f=((o=r.textContent)==null?void 0:o.trim())||"Unknown",S=((s=u.textContent)==null?void 0:s.trim())||"";let y=Date.now();if(p){const T=p.getAttribute("datetime");T&&(y=new Date(T).getTime())}const M=f.includes(e)?"received":"sent";S&&n.push({speaker:f,content:S,timestamp:y,type:M})}}return n}async function ft(e){var p;const t=ut(),n=Ne(e,t);let o=await Le(n);if(o&&!_e(o))return i("INFO",`Using cached data for ${B(e,o.profile)} (${o.messages.length} msgs)`,"System"),o;i("INFO",`Scraping profile for ${e}...`,"System");const s=Ge();i("INFO",`Syncing full history for ${e}...`,"System");const a=await mt(e),r=a[a.length-1],u={leadId:n,leadName:e,profileUrl:t,profile:s,messages:a,metadata:{firstContact:((p=a[0])==null?void 0:p.timestamp)||Date.now(),lastActivity:(r==null?void 0:r.timestamp)||Date.now(),lastMessageFrom:(r==null?void 0:r.type)==="received"?"lead":"me",totalMessages:a.length,lastSyncedAt:Date.now()}};return await re(u),i("SUCCESS",`Saved ${a.length} messages + profile for ${B(e,s)}`,"System"),u}async function ht(e,t,n,o,s,a,r=!1,u="llama-3.3-70b-versatile"){var c,O;const p=n.slice(-30),f=p.map(b=>`${b.speaker}: ${b.content}`).join(`
`),S=yt(),y=gt(n),M=wt(n),T=bt(a),R=a?`

LEAD PROFILE:
${We(a)}
`:"",ee=t.replace("{extracted_text}",f).replace("{user_name}",o).replace("{lead_headline}",(a==null?void 0:a.headline)||"Unknown"),te=`You are a real professional messaging on LinkedIn (NOT an AI assistant).
${R}
TIME CONTEXT: ${S}
CONVERSATION AGE: ${y}
THEIR MESSAGING STYLE: ${M}
TONE ADJUSTMENT: ${T}

CONVERSATION (${n.length} total messages, showing last ${p.length}):
${f}

USER'S INSTRUCTIONS:
${ee}

CRITICAL REALISM RULES:
1. LENGTH: 15-30 words. Real people are busy.
2. TONE: Match their energy. If they write 5 words, you write 7-10.
3. NATURAL: Use contractions (I'm, we're, that's). Be conversational.
4. QUESTIONS: Max ONE follow-up question.
5. AVOID AI PATTERNS:
   - "Thank you for reaching out"
   - "I hope this finds you well"
   - "I'd be happy to..."
   - Corporate jargon
   - Over-enthusiasm (!!!)

Respond as ${s}. Type like you're between meetings.`,W=r?"https://api.groq.com/openai/v1/chat/completions":"https://api.openai.com/v1/chat/completions",x=r?u:"gpt-4o-mini";let $=150;r&&(u==="openai/gpt-oss-120b"?$=500:$=250);const A=await st(()=>fetch(W,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:x,messages:[{role:"system",content:te},...p.map(b=>({role:b.type==="received"?"user":"assistant",content:b.content}))],max_tokens:$,temperature:.7})}),3,1e3);if(!A.ok){const b=await A.text();throw new Error(`${r?"Groq":"OpenAI"} API Error ${A.status}: ${b.slice(0,500)}`)}const E=await A.json(),I=(((c=E.usage)==null?void 0:c.prompt_tokens)||0)+(((O=E.usage)==null?void 0:O.completion_tokens)||0);return{reply:E.choices[0].message.content.trim(),tokensUsed:I}}function yt(){const e=new Date().getHours(),t=new Date().getDay();return t===0||t===6?"Weekend - keep it casual and light":e<12?"Morning - people are busy, be concise":e<17?"Afternoon - normal business hours":"Evening - they might not respond until tomorrow"}function gt(e){if(e.length<2)return"First exchange - establish rapport";const t=e[0].timestamp,n=Math.floor((Date.now()-t)/(1e3*60*60*24));return n===0?"New conversation today":n===1?"Ongoing conversation":n>7?"Old conversation - re-engage carefully":`${n}-day conversation`}function wt(e){const t=e.filter(o=>o.type==="received");if(t.length===0)return"Unknown";const n=t.reduce((o,s)=>o+s.content.split(" ").length,0)/t.length;return n<10?"SHORT replies (5-10 words) - match that brevity":n<25?"MEDIUM replies (10-25 words) - similar length":"LONG replies (25+ words) - you can elaborate more"}function bt(e){if(!e||!e.jobTitle)return"Professional but friendly";const t=e.jobTitle.toLowerCase();return t.includes("ceo")||t.includes("founder")||t.includes("president")?"EXECUTIVE - Be direct, concise, value-focused. No fluff.":t.includes("director")||t.includes("vp")||t.includes("head")?"SENIOR LEADER - Professional, strategic. Focus on ROI.":t.includes("engineer")||t.includes("developer")?"TECHNICAL - Be specific, mention features. Avoid sales speak.":"PROFESSIONAL - Warm, helpful, consultative."}function St(){var t;const e=document.querySelector(".global-nav__me-content span");return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||"You"}function fe(e){return{"openai/gpt-oss-120b":"GPT-OSS-120B","llama-3.3-70b-versatile":"Llama-3.3-70B","meta-llama/llama-4-scout-17b-16e-instruct":"Llama-4-Scout","meta-llama/llama-4-maverick-17b-128e-instruct":"Llama-4-Maverick","moonshotai/kimi-k2-instruct-0905":"Kimi-K2","qwen/qwen3-32b":"Qwen-3-32B","gpt-4o-mini":"GPT-4o-mini","gpt-4o":"GPT-4o"}[e]||e}function G(e){return e==="groq"?"Groq":"OpenAI"}function Mt(e,t){var o,s;const n=[e.toLowerCase(),((o=t==null?void 0:t.company)==null?void 0:o.toLowerCase())||"",((s=t==null?void 0:t.jobTitle)==null?void 0:s.toLowerCase())||""];for(const a of ue){const r=a.toLowerCase();for(const u of n)if(u&&u.includes(r))return!0}return!1}async function kt(e,t){return new Promise(n=>{P=n,chrome.storage.local.set({pendingReply:{leadName:e,reply:t,timestamp:Date.now()}}),i("INFO",`Waiting for approval to reply to ${e}...`,"System"),setTimeout(()=>{P&&(i("WARNING",`Reply approval timed out for ${e}`,"System"),P({approved:!1,reply:""}),P=null,chrome.storage.local.remove(["pendingReply"]))},5*60*1e3)})}async function Te(e,t=6,n=400){for(let o=0;o<t;o++){const s=document.querySelector(e);if(s)return s;await m(n)}return null}function vt(e){for(let t=e.length-1;t>=0;t--){const n=e[t];if(n.type==="sent"){const o=n.content.toLowerCase();if(nt.some(s=>o.includes(s)))return n.timestamp}}return null}function Tt(e){const t=e.toLowerCase().trim();return t.includes("?")?!1:t.split(" ").length<=3}function At(e){if(e==="Unknown")return!0;const t=e.toLowerCase();return et.some(n=>t.includes(n))}async function he(e){var I,c,O,b,ge,Y;i("INFO",`Starting batch of ${e} chats...`,"System");const{apiKey:t,groqApiKey:n,chatMin:o,chatMax:s,loopMin:a,loopMax:r,prompt:u,leadPrompt:p,webhookUrl:f,startHour:S,endHour:y,replyProvider:M,decisionProvider:T,leadDetectionProvider:R}=await lt(),ee=me(M,t,n),te=me(T,t,n),W=me(R,t,n),x=M==="groq"?le:"gpt-4o-mini";if(L("currentModel",fe(x)),ue=(await chrome.storage.local.get(["blacklist"])).blacklist||[],ie&&!at(S,y)){i("WARNING",`Outside working hours (${S}-${y}). Pausing.`,"System"),v&&!D&&(Z=window.setTimeout(()=>he(e),15*60*1e3));return}const A=St();await it(5);let E=Array.from(document.querySelectorAll("ul.msg-conversations-container__conversations-list li")).slice(0,e).sort(()=>Math.random()-.2);i("INFO",`Found ${E.length} conversations to check.`,"Bot");for(let V=0;V<E.length&&v;V++){for(;D&&v;)await m(1e3);if(!v)break;await rt(),await Ae(o,s);const J=E[V].querySelector("a, .msg-conversation-listitem__link, [tabindex='0']");J==null||J.click(),await m(2e3);const d=ct();if(!d)continue;const Q=dt(d);if(!Q||!Q.fromLead){i("INFO",`Skipping ${d}: Last message was from me.`,"Bot");continue}const l=await ft(d),Dt=((I=l.profile)==null?void 0:I.headline)||"Unknown";if(At(Dt)&&!Q.content.includes("?")&&Q.content.split(" ").length<12){i("INFO",`Skipping ${d}: Irrelevant or unknown headline`,"Bot");continue}const De=vt(l.messages);if(De&&Date.now()-De<tt&&Tt(Q.content)){i("INFO",`Skipping ${d}: Recent close cooldown active`,"Bot");continue}if(Mt(d,l.profile)){i("WARNING",`Skipping ${d}: Blacklisted`,"Bot");continue}if(i("INFO",`Checking chat with ${B(d,l.profile)}...`,"Bot"),L("chatsProcessed",1),l.messages.length===0){i("WARNING",`No messages found for ${d}`,"System");continue}const Pt=l.messages.slice(-8).map(g=>({speaker:g.speaker,message:g.content}));let ne;try{ne=await Oe(te,Pt,d,T),i("ACTION",`AI Decision for ${d}: ${ne.shouldReply?"REPLY":"SKIP"} (${ne.reason}) [${G(T)}]`,"Bot")}catch(g){i("ERROR",`AI Decision Failed (${G(T)}): ${ye(g)}`,"System");continue}if(!ne.shouldReply)continue;if(f)try{const g=l.messages.slice(-2).map(k=>k.content);if(await Re(W,p,g,R)){const k=l.messages.map(N=>`${N.speaker}: ${N.content}`).join(`
`),U={leadName:d,profileUrl:l.profileUrl,company:((c=l.profile)==null?void 0:c.company)||"Unknown",jobTitle:((O=l.profile)==null?void 0:O.jobTitle)||"Unknown",headline:((b=l.profile)==null?void 0:b.headline)||"Unknown",conversationHistory:k,messageCount:l.messages.length,detectedAt:new Date().toISOString()};await $e(U),L("leadsFound",1),i("SUCCESS",`ðŸ”¥ HOT LEAD: ${d} sent to webhook! [${G(R)}]`,"Bot")}}catch(g){i("ERROR",`Lead webhook failed (${G(R)}): ${ye(g)}`,"System")}let oe;try{oe=await ht(ee,u,l.messages,d,A,l.profile,M==="groq",le),L("tokensUsed",oe.tokensUsed)}catch(g){i("ERROR",`Reply Generation Failed (${G(M)}): ${ye(g)}`,"System");continue}let _=oe.reply;if(ce){const g=await kt(d,oe.reply);if(!g.approved){i("INFO",`Reply to ${d} was skipped by user`,"User");continue}_=g.reply}const z=await Te("div.msg-form__contenteditable[role='textbox']",6,400),C=await Te("button.msg-form__send-button",6,400);if(z&&C){const g={messageCount:l.messages.length,lastMessageQuestions:(((ge=l.messages[l.messages.length-1])==null?void 0:ge.content.match(/\?/g))||[]).length},k=Ye(_,g)?Ve(_):null;if(k){i("ACTION",`Double-texting ${d} (${k.pattern})...`,"Bot");const U=de(k.firstMessage);if(await m(U),await pe(z,k.firstMessage),await m(800),!C.hasAttribute("disabled")&&!C.classList.contains("disabled")){C.click(),await m(500);const N=Ze(k.pattern);i("INFO",`Waiting ${Math.round(N/1e3)}s before second message...`,"Bot"),await m(N);const Ct=de(k.secondMessage);await m(Ct),await pe(z,k.secondMessage),await m(800),!C.hasAttribute("disabled")&&!C.classList.contains("disabled")?(C.click(),await m(500),L("repliesSent",1),l.messages.push({speaker:A,content:k.firstMessage,timestamp:Date.now()-N,type:"sent"},{speaker:A,content:k.secondMessage,timestamp:Date.now(),type:"sent"}),l.metadata.lastActivity=Date.now(),l.metadata.lastMessageFrom="me",l.metadata.totalMessages+=2,l.metadata.lastSyncedAt=Date.now(),await re(l),i("SUCCESS",`Double-texted ${B(d,l.profile)} (${fe(x)}) [History: ${l.messages.length} msgs]`,"Bot")):i("ERROR",`Send button disabled for second message to ${d}`,"System")}else i("ERROR",`Send button disabled for ${d}`,"System")}else{const U=de(_);i("ACTION",`Typing reply to ${d} (waiting ${Math.round(U/1e3)}s)...`,"Bot"),await m(U),await pe(z,_),await m(800),C.hasAttribute("disabled")||C.classList.contains("disabled")?i("ERROR",`Send button disabled for ${d}`,"System"):(C.click(),await m(500),(((Y=z.textContent)==null?void 0:Y.trim())||"").length===0?(L("repliesSent",1),l.messages.push({speaker:A,content:_,timestamp:Date.now(),type:"sent"}),l.metadata.lastActivity=Date.now(),l.metadata.lastMessageFrom="me",l.metadata.totalMessages++,l.metadata.lastSyncedAt=Date.now(),await re(l),i("SUCCESS",`Sent reply to ${B(d,l.profile)} (${fe(x)}) [History: ${l.messages.length} msgs]`,"Bot")):i("WARNING",`Message may not have sent to ${d}`,"System"))}}else i("ERROR","Could not find chat input or send button","System");await Ae(o,s)}i("INFO","Batch finished. Sleeping...","System"),v&&!D&&(Z=window.setTimeout(()=>he(e),Math.floor(Math.random()*(r-a+1))+a))}function Ae(e,t){return m(Math.floor(Math.random()*(t-e+1))+e)}function ye(e){return typeof e=="string"?e:e&&typeof e=="object"&&"message"in e?e.message:"Unknown error"}chrome.runtime.onMessage.addListener((e,t,n)=>{var o,s,a,r,u,p;if(e.type==="PING_TEST"){n("âœ… Content script active!");return}if(e.type==="GET_STATUS"){n({running:v,paused:D,stats:H,logs:K});return}if(e.type==="START_BOT"){v?n({status:"error",error:"Already running"}):(v=!0,D=!1,H={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:Date.now(),tokensUsed:0,currentModel:""},ie=((o=e.config)==null?void 0:o.strictHours)??!0,(s=e.config)==null||s.useGroq,le=((a=e.config)==null?void 0:a.groqModel)??"llama-3.3-70b-versatile",ce=((r=e.config)==null?void 0:r.replyPreviewEnabled)??!1,ue=((u=e.config)==null?void 0:u.blacklist)??[],i("INFO",`Bot started (Strict Hours: ${ie?"ON":"OFF"}, Preview: ${ce?"ON":"OFF"})`,"User"),he(((p=e.config)==null?void 0:p.nChats)??10),n({status:"ok"}));return}if(e.type==="STOP_BOT"){v=!1,D=!1,Z!==null&&clearTimeout(Z),i("INFO","Bot stopped by user","User"),n({status:"stopped"});return}if(e.type==="PAUSE_BOT"){v&&!D?(D=!0,i("INFO","Bot paused by user","User"),n({status:"paused"})):n({status:"error",error:"Not running or already paused"});return}if(e.type==="RESUME_BOT"){v&&D?(D=!1,i("INFO","Bot resumed by user","User"),n({status:"running"})):n({status:"error",error:"Not paused"});return}if(e.type==="APPROVE_REPLY"){P&&(i("SUCCESS",`Reply to ${e.leadName} approved`,"User"),P({approved:!0,reply:e.reply}),P=null,chrome.storage.local.remove(["pendingReply"])),n({status:"ok"});return}if(e.type==="REJECT_REPLY"){P&&(i("INFO",`Reply to ${e.leadName} rejected`,"User"),P({approved:!1,reply:""}),P=null,chrome.storage.local.remove(["pendingReply"])),n({status:"ok"});return}if(e.type==="CHECK_UNREAD"){v&&!D&&i("INFO","Check unread triggered by background","System"),n({status:"ok"});return}})})();
