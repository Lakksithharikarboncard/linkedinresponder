(function(){"use strict";const S={openaiApiKey:"openaiApiKey",groqApiKey:"groqApiKey",webhookUrl:"webhookUrl",replyPrompt:"replyPrompt",leadPrompt:"leadPrompt",chatMinDelay:"chatMinDelay",chatMaxDelay:"chatMaxDelay",loopMinDelay:"loopMinDelay",loopMaxDelay:"loopMaxDelay",startHour:"startHour",endHour:"endHour",replyProvider:"replyProvider",decisionProvider:"decisionProvider",leadDetectionProvider:"leadDetectionProvider"},b={openaiApiKey:"",groqApiKey:"",webhookUrl:"",replyPrompt:`You are {user_name}'s assistant. Reply to this lead based on context:
{extracted_text}
Reply briefly and professionally.`,leadPrompt:"Does this conversation indicate strong buying intent or interest? Reply YES or NO.",chatMinDelay:2e3,chatMaxDelay:5e3,loopMinDelay:1e4,loopMaxDelay:3e4,startHour:9,endHour:18,replyProvider:"groq",decisionProvider:"groq",leadDetectionProvider:"openai"},Ee=["openai","groq"];function ke(e,t,n,o){const s=typeof e=="number"?e:Number(e);if(!Number.isFinite(s))return o;const a=Math.round(s);return Math.min(n,Math.max(t,a))}function V(e,t,n,o){const s=typeof e=="number"?e:Number(e);return Number.isFinite(s)?Math.min(n,Math.max(t,Math.floor(s))):o}function q(e,t){return typeof e!="string"?t:e}function te(e,t){return typeof e=="string"&&Ee.includes(e)?e:t}function Ft(e){return e}function Pe(e){return e.trim()}async function Se(){return new Promise(e=>{chrome.storage.local.get(Object.values(S),t=>{const n=V(t[S.chatMinDelay],250,6e4,b.chatMinDelay),o=V(t[S.chatMaxDelay],250,12e4,b.chatMaxDelay),s=V(t[S.loopMinDelay],500,6e5,b.loopMinDelay),a=V(t[S.loopMaxDelay],500,6e5,b.loopMaxDelay),r=Math.min(n,o),i=Math.max(n,o),c=Math.min(s,a),p=Math.max(s,a),h=ke(t[S.startHour],0,23,b.startHour),m=ke(t[S.endHour],0,23,b.endHour),g={openaiApiKey:q(t[S.openaiApiKey],b.openaiApiKey).trim(),groqApiKey:q(t[S.groqApiKey],b.groqApiKey).trim(),webhookUrl:Pe(q(t[S.webhookUrl],b.webhookUrl)),replyPrompt:q(t[S.replyPrompt],b.replyPrompt),leadPrompt:q(t[S.leadPrompt],b.leadPrompt),chatMinDelay:r,chatMaxDelay:i,loopMinDelay:c,loopMaxDelay:p,startHour:h,endHour:m,replyProvider:te(t[S.replyProvider],b.replyProvider),decisionProvider:te(t[S.decisionProvider],b.decisionProvider),leadDetectionProvider:te(t[S.leadDetectionProvider],b.leadDetectionProvider)};e(g)})})}const De=["not interested","no thanks","no thank","not now","too busy","maybe later","not a fit","no overlap","policy","not allowed","stop","unsubscribe","no, thank you","no thank you","no thankyou","nope","nah"],Ie=["sure","ok","okay","k","thx","thanks"];function ne(e){return e==="groq"?"https://api.groq.com/openai/v1/chat/completions":"https://api.openai.com/v1/chat/completions"}function oe(e){return e==="groq"?"llama-3.3-70b-versatile":"gpt-4o-mini"}async function Re(e,t,n,o="openai"){var I,N,T,P,_;if(t.length===0)return{shouldReply:!1,reason:"Empty conversation"};const s=t[t.length-1],a=s.message.toLowerCase().trim(),r=t.filter(d=>d.speaker!==n),i=t.filter(d=>d.speaker===n);if(De.some(d=>a.includes(d)))return{shouldReply:!1,reason:"Lead disengaged"};if(Ie.includes(a)&&r.length>0){const d=r[r.length-1].message.toLowerCase();if(d.includes("no overlap")||d.includes("reach out if")||d.includes("feel free to reach out")||d.includes("not a fit")||d.includes("no problem")||d.includes("thanks for letting me know"))return{shouldReply:!1,reason:"Ack after close"}}const c=r.length>0&&r[r.length-1].message.includes("?"),p=i[i.length-1]===s,h=r.length?t.findIndex(d=>d===r[r.length-1]):-1,m=t.length-1;if(c&&p&&m>h)return{shouldReply:!0,reason:"They answered my question"};const g=s.message.split(" ").length<20,k=r.length>0&&i.length>0;if(g&&k&&r.length>=2)return{shouldReply:!0,reason:"Short but engaged response"};if(["yes","yeah","sure","absolutely","definitely","interested","sounds good","tell me more","how does","what about","can you","could you","would love to","want to know","curious about","?"].some(d=>a.includes(d)))return{shouldReply:!0,reason:"Positive engagement detected"};const L=`You are analyzing a LinkedIn conversation to decide if a response is needed.

CONVERSATION (last 20 messages):
${t.slice(-20).map(d=>`${d.speaker}: ${d.message}`).join(`
`)}

CONTEXT: The lead just sent: "${s.message}"

Rules:
- REPLY if they asked a question, answered my question, or showed interest.
- SKIP if they rejected, said no, not interested, policy/no allowance, or gave a short acknowledgment after my closing message.
- Be biased to REPLY only when there's real engagement; otherwise SKIP.

Respond ONLY with:
REPLY: [one sentence reason]
OR
SKIP: [one sentence reason]`;try{const d=ne(o),x=oe(o),v=await fetch(d,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:x,messages:[{role:"user",content:L}],temperature:.2,max_tokens:60})});if(!v.ok)return console.error(`âŒ ${o.toUpperCase()} API error in shouldReplyToConversation: ${v.status}`),{shouldReply:!0,reason:"AI check failed - defaulting to reply"};const K=((P=(T=(N=(I=(await v.json()).choices)==null?void 0:I[0])==null?void 0:N.message)==null?void 0:T.content)==null?void 0:P.trim())||"",J=K.toUpperCase().startsWith("REPLY"),Y=((_=K.split(":")[1])==null?void 0:_.trim())||"AI decision";return{shouldReply:J,reason:Y}}catch(d){return console.error("âŒ AI decision check failed:",d),{shouldReply:!0,reason:"AI error - defaulting to engage"}}}async function Ne(e,t,n,o,s="openai"){var r,i,c,p,h;if(t.length===0)return{shouldEngage:!1,reason:"No messages to evaluate"};const a=t.join(" ").toLowerCase();if(a.includes("?"))return{shouldEngage:!0,reason:"Message contains a question"};if(a.split(/\s+/).length>15)return{shouldEngage:!0,reason:"Substantial message content"};if(n==="pending_meeting"&&o<=7){const m=`You are analyzing LinkedIn messages to decide if we should RESPOND.

CONTEXT: 
- We sent a scheduling link previously
- They confirmed interest and we have a pending meeting
- It's been ${o} day(s) since they confirmed
- They just sent these messages:

${t.map((g,k)=>`${k+1}. "${g}"`).join(`
`)}

QUESTION: Are they following up to schedule, asking a question, or showing engagement?

Consider:
- Casual questions like "how about you?" or "and you?" = ENGAGE
- Greetings followed by "hope you're doing well" type messages = ENGAGE
- Simple "hi" or "hey" with nothing else = might be SKIP
- Any question, even casual = ENGAGE

Reply with ONLY:
ENGAGE: [brief reason]
OR
SKIP: [brief reason]`;try{const g=ne(s),k=oe(s),E=await fetch(g,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:k,messages:[{role:"user",content:m}],temperature:.2,max_tokens:50})});if(!E.ok)return console.error(`âŒ ${s.toUpperCase()} API error: ${E.status}`),{shouldEngage:!0,reason:"AI check failed - defaulting to engage"};const I=((p=(c=(i=(r=(await E.json()).choices)==null?void 0:r[0])==null?void 0:i.message)==null?void 0:c.content)==null?void 0:p.trim())||"",N=I.toUpperCase().startsWith("ENGAGE"),T=((h=I.split(":")[1])==null?void 0:h.trim())||"AI decision";return{shouldEngage:N,reason:T}}catch(g){return console.error("âŒ Engagement check failed:",g),{shouldEngage:!0,reason:"AI error - defaulting to engage"}}}return(n==="my_close"||o>7)&&a.split(/\s+/).length<=5?{shouldEngage:!1,reason:`Short message during cooldown (${o} days)`}:{shouldEngage:!0,reason:"Default to engage"}}async function _e(e,t,n,o="openai"){var a,r,i,c;const s=`You are an AI assistant helping identify qualified leads.
Rule: ${t}
Analyze the following two LinkedIn messages: ${n.join(`
`)}
Respond with only one word: "yes" or "no".`;try{const p=ne(o),h=oe(o),m=await fetch(p,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:h,messages:[{role:"user",content:s}],temperature:0,max_tokens:10})});return m.ok?((c=(i=(r=(a=(await m.json()).choices)==null?void 0:a[0])==null?void 0:r.message)==null?void 0:i.content)==null?void 0:c.trim().toLowerCase())==="yes":(console.error(`âŒ ${o.toUpperCase()} API error in checkPositiveLead: ${m.status}`),!1)}catch(p){return console.error("âŒ GPT lead check failed:",p),!1}}async function xe(e){const{webhookUrl:t}=await Se();if(!t||t.trim().length===0)throw new Error("Webhook URL is not configured. Please set it in Options.");const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok){const o=await n.text().catch(()=>"Unknown error");throw console.error("âŒ Webhook error:",o),new Error(`Webhook error: ${n.status}`)}console.log("âœ… Lead sent to webhook successfully")}const se="conversation_histories",be=500,Oe=6e4;function $e(e,t){const n=`${e}_${t}`;return btoa(unescape(encodeURIComponent(n))).substring(0,32)}async function ve(){return new Promise(e=>{chrome.storage.local.get([se],t=>{e(t[se]||{})})})}async function Le(e){return(await ve())[e]||null}async function ae(e){const t=await ve();return e.messages.length>be&&(e.messages=e.messages.slice(-be)),t[e.leadId]=e,new Promise(n=>{chrome.storage.local.set({[se]:t},()=>{n()})})}function Ue(e){return e?Date.now()-e.metadata.lastSyncedAt>Oe:!0}const F={headline:[".pv-text-details__left-panel h2",".text-body-medium.break-words",'div[data-view-name="profile-headline"]',".pv-top-card--list-bullet .text-body-small"],jobTitle:[".pv-text-details__left-panel .text-body-small:first-of-type",".pv-top-card--list-bullet .text-body-small:first-child"],company:[".pv-text-details__left-panel .text-body-small.inline a",'a[data-field="experience_company_logo"]',".experience-item__company"],location:[".pv-text-details__left-panel .text-body-small:last-of-type","span.text-body-small.inline.t-black--light.break-words",".pv-top-card--list-bullet .text-body-small:last-child"],connectionDegree:[".dist-value","span.dist-value",".pv-top-card--list-bullet span.dist-value"]},qe=/(status is (online|offline|reachable|active now))/i;function j(e){var t;for(const n of e){const o=document.querySelector(n);if((t=o==null?void 0:o.textContent)!=null&&t.trim())return o.textContent.trim()}return""}function Fe(e){if(!e)return"";const t=e.split(`
`).map(o=>o.trim()).filter(o=>o&&!qe.test(o.toLowerCase())).join(" ").replace(/\s+/g," ").trim();return t.split(" ").filter(Boolean).length<3?"Unknown":t}function je(){var t,n;let e=j(F.headline);if(!e){const o=(n=(t=document.querySelector(".msg-thread__link-to-profile"))==null?void 0:t.textContent)==null?void 0:n.trim();o&&(e=o)}return Fe(e)}function Be(){return j(F.jobTitle).replace(/^at\s+/i,"").trim()||"Unknown"}function He(){let e=j(F.company);return e=e.replace(/^at\s+/i,"").trim(),e||"Unknown"}function Ge(){return j(F.location)||"Unknown"}function Ke(){let e=j(F.connectionDegree);const t=e.match(/(\d+(?:st|nd|rd|th))/);return t?t[1]:e||"Unknown"}function Ye(){return{headline:je(),jobTitle:Be(),company:He(),location:Ge(),connectionDegree:Ke(),lastScraped:Date.now()}}function B(e,t){if(!t)return e;const n=[];t.jobTitle&&t.jobTitle!=="Unknown"&&n.push(t.jobTitle),t.company&&t.company!=="Unknown"&&n.push(`@ ${t.company}`),t.location&&t.location!=="Unknown"&&n.push(t.location);const o=n.length>0?` (${n.join(", ")})`:"";return`${e}${o}`}function We(e){if(!e)return"Profile: Not available";const t=[];return e.headline&&e.headline!=="Unknown"&&t.push(`Headline: ${e.headline}`),e.jobTitle&&e.jobTitle!=="Unknown"&&t.push(`Job Title: ${e.jobTitle}`),e.company&&e.company!=="Unknown"&&t.push(`Company: ${e.company}`),e.location&&e.location!=="Unknown"&&t.push(`Location: ${e.location}`),e.connectionDegree&&e.connectionDegree!=="Unknown"&&t.push(`Connection: ${e.connectionDegree}`),t.length?t.join(" | "):"Profile: Not available"}function Ve(e,t){const n=e.split(" ").length>40,o=t.lastMessageQuestions>0;return n||o}function ze(e,t){const n=[Je,Qe,Xe,Ze];for(const o of n){const s=o(e);if(s)return s}return null}function Je(e){const t=e.split(/[.!?]/).filter(a=>a.trim());if(t.length<3)return null;const n=Math.floor(t.length/2),o=t.slice(0,n).join(". ").trim(),s=t.slice(n).join(". ").trim();return o.length<20||s.length<10?null:{firstMessage:o,secondMessage:s,delayMs:3e3+Math.random()*4e3,pattern:"price_breakdown"}}function Qe(e){const t=e.split(/[.!?]/).filter(r=>r.trim());if(t.length<2)return null;const n=t[0].trim(),o=t.slice(1).join(". ").trim(),s=["Quick note:","Also,","One more thing:"],a=s[Math.floor(Math.random()*s.length)];return{firstMessage:n,secondMessage:`${a} ${o.charAt(0).toLowerCase()}${o.slice(1)}`,delayMs:5e3+Math.random()*3e3,pattern:"afterthought"}}function Xe(e){if(!e.includes("?")||!e.trim().endsWith("?"))return null;const t=["No rushâ€”ballpark is fine.","Roughly is okay.","Just an estimate works."];return{firstMessage:e.trim(),secondMessage:t[Math.floor(Math.random()*t.length)],delayMs:1800+Math.random()*1200,pattern:"question_refinement"}}function Ze(e){if(e.split(" ").length>15||/[.!?]$/.test(e.trim())||![/^(yeah|yes|yep|sure|sounds good|makes sense|got it|perfect)/i].some(s=>s.test(e)))return null;const o=["ðŸ‘","ðŸ‘Œ","âœ…"];return{firstMessage:e.trim(),secondMessage:o[Math.floor(Math.random()*o.length)],delayMs:1500+Math.random()*1500,pattern:"emoji_followup"}}function et(e){const n={price_breakdown:3e3,afterthought:5e3,question_refinement:1800,emoji_followup:1500}[e]??3e3,o=n*.4;return n+(Math.random()-.5)*2*o}let A=!1,C=!1,z=null,H={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:null,tokensUsed:0,currentModel:""},G=[],re=!0,ie="llama-3.3-70b-versatile",le=!1,D=null,ce=[];const tt=["student","intern","seeking","open to work","looking for","hiring"],nt=["no overlap","not a fit","reach out if","feel free to reach out","thanks for letting me know","happy to stay connected","best of luck","good luck with","wishing you","take care","all the best","not what you're looking for","doesn't seem like a match","maybe in the future","keep in touch"],ot=["schedule","reschedule","next week","after jan","after january","after the","let's","lets","call","meet","demo","walkthrough","chat soon","talk soon","talk then","sounds good","works for me","perfect","great","book","calendar","calendly","outlook"],st=["no problem","no worries","sure thing","of course","absolutely","definitely"],at=["calendly.com","cal.com","outlook.office.com/book","hubspot.com/meetings","savvycal.com","tidycal.com","book a time","grab time","schedule a call","schedule a chat","book a call","here's a link","here is a link","whenever works","pick a time","find a time"],rt=["sounds good","sounds great","perfect","will do","see you then","looking forward","look forward","talk soon","talk then","catch you","thanks for sharing","thank you for sharing","i'll check","i will check","let me check","booked","scheduled","confirmed","done","great, thanks","awesome","cool","ok great","okay great","works for me"],it=["hi","hey","hello","hii","hiii","heyy","heyyy","yo","sup","morning","good morning","good afternoon","good evening","gm"],lt=[{pattern:"vacation",reason:"vacation"},{pattern:"holiday",reason:"holiday"},{pattern:"traveling",reason:"traveling"},{pattern:"travel",reason:"travel"},{pattern:"out of office",reason:"out of office"},{pattern:"out of town",reason:"out of town"},{pattern:"busy",reason:"busy schedule"},{pattern:"swamped",reason:"busy schedule"},{pattern:"hectic",reason:"busy schedule"},{pattern:"next week",reason:"timing"},{pattern:"after the",reason:"timing"},{pattern:"after jan",reason:"new year"},{pattern:"after january",reason:"new year"},{pattern:"new year",reason:"new year"}];function ct(e){return new Promise(t=>setTimeout(t,e))}function y(e){return new Promise(t=>setTimeout(t,e))}async function ut(e,t=3,n=1e3){let o=0;for(;;){const s=await e();if(s.ok)return s;if((s.status===429||s.status>=500)&&o<t){const a=n*2**o+Math.random()*400;await ct(a),o++;continue}return s}}function l(e,t,n){const o={time:Date.now(),type:e,message:t,actor:n};G.unshift(o),G.length>100&&G.pop(),chrome.storage.local.set({botLog:G.slice(0,50)})}function $(e,t){e==="startTime"?H.startTime=t:e==="currentModel"?H.currentModel=t:H[e]+=t}function ue(e){return 2e3+e.split(" ").length*300+Math.random()*2e3}function dt(e=9,t=18){const n=new Date().getHours();return n>=e&&n<t}async function de(e,t){e.focus(),await y(50),document.execCommand("selectAll",!1,""),document.execCommand("delete",!1,"");for(const n of t)document.execCommand("insertText",!1,n),await y(Math.random()>.9?150:30+Math.random()*50)}async function pt(){const e=document.querySelector(".msg-s-message-list-content");e&&(e.scrollBy(0,Math.random()*80+20),await y(300+Math.random()*500),e.scrollBy(0,-(Math.random()*50+10)),await y(300+Math.random()*500))}async function mt(e=5){const t=document.querySelector(".msg-conversations-container--inbox-shortcuts");if(t)for(let n=0;n<e;n++)t.scrollBy({top:Math.random()*200+100,behavior:"smooth"}),await y(500+Math.random()*800),t.scrollBy({top:-(Math.random()*50),behavior:"smooth"}),await y(400+Math.random()*500)}function pe(e,t,n){return e==="groq"?n:t}async function ht(){const e=await Se();return{apiKey:e.openaiApiKey,groqApiKey:e.groqApiKey,chatMin:e.chatMinDelay,chatMax:e.chatMaxDelay,loopMin:e.loopMinDelay,loopMax:e.loopMaxDelay,prompt:e.replyPrompt,leadPrompt:e.leadPrompt,webhookUrl:e.webhookUrl,startHour:e.startHour,endHour:e.endHour,replyProvider:e.replyProvider,decisionProvider:e.decisionProvider,leadDetectionProvider:e.leadDetectionProvider}}function ft(){var t;const e=document.evaluate('//*[@id="thread-detail-jump-target"]/div/a/div/dl/dt/h2',document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||null}function gt(){const e=document.querySelector('a[href*="/in/"]');return(e==null?void 0:e.href)||window.location.href}function yt(e){var a,r;const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));let n=null;const o=[];for(const i of t){const c=i.querySelector("span.msg-s-message-group__name"),p=i.querySelector("p.msg-s-event-listitem__body");if(c&&(n=((a=c.textContent)==null?void 0:a.trim())||null),p&&n){const h=((r=p.textContent)==null?void 0:r.trim())||"";h&&o.push({sender:n,content:h})}}if(o.length===0)return null;const s=o[o.length-1];return{fromLead:s.sender.includes(e),content:s.content}}function wt(e,t=5){var a,r;const n=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));let o=null;const s=[];for(const i of n){const c=i.querySelector("span.msg-s-message-group__name"),p=i.querySelector("p.msg-s-event-listitem__body");if(c&&(o=((a=c.textContent)==null?void 0:a.trim())||null),p&&o&&o.includes(e)){const h=((r=p.textContent)==null?void 0:r.trim())||"";h&&s.push(h)}}return s.slice(-t)}async function kt(){const e=document.querySelector(".msg-s-message-list-content");if(!e)return;let t=0,n=e.scrollHeight,o=0;for(l("INFO","Loading full conversation history...","System");n>t&&o<50;)t=n,e.scrollTo({top:0,behavior:"smooth"}),await y(800+Math.random()*400),n=e.scrollHeight,o++;l("INFO",`Loaded ${o} message batches`,"System")}async function St(e){var s,a;await kt();const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event")),n=[];let o=null;for(const r of t){const i=r.querySelector("span.msg-s-message-group__name"),c=r.querySelector("p.msg-s-event-listitem__body"),p=r.querySelector("time");if(i&&(o=((s=i.textContent)==null?void 0:s.trim())||null),c&&o){const h=((a=c.textContent)==null?void 0:a.trim())||"";let m=Date.now();if(p){const g=p.getAttribute("datetime");g&&(m=new Date(g).getTime())}h&&n.push({speaker:o,content:h,timestamp:m,type:o.includes(e)?"received":"sent"})}}return n}async function bt(e){var c;const t=gt(),n=$e(e,t);let o=await Le(n);if(o&&!Ue(o))return l("INFO",`Using cached data for ${B(e,o.profile)} (${o.messages.length} msgs)`,"System"),o;l("INFO",`Scraping profile for ${e}...`,"System");const s=Ye();l("INFO",`Syncing full history for ${e}...`,"System");const a=await St(e),r=a[a.length-1],i={leadId:n,leadName:e,profileUrl:t,profile:s,messages:a,metadata:{firstContact:((c=a[0])==null?void 0:c.timestamp)||Date.now(),lastActivity:(r==null?void 0:r.timestamp)||Date.now(),lastMessageFrom:(r==null?void 0:r.type)==="received"?"lead":"me",totalMessages:a.length,lastSyncedAt:Date.now()}};return await ae(i),l("SUCCESS",`Saved ${a.length} messages + profile for ${B(e,s)}`,"System"),i}function Te(e){const t=e.toLowerCase();return at.some(n=>t.includes(n))}function me(e){const t=e.toLowerCase().trim();return t.split(/\s+/).length>10?!1:rt.some(n=>t.includes(n))}function vt(e){const t=e.toLowerCase().trim();return t.split(/\s+/).length>3?!1:it.some(n=>t===n||t.startsWith(n+" "))}function Me(e){return ot.some(t=>e.toLowerCase().includes(t))}function Tt(e){const t=e.toLowerCase();return st.some(n=>t.includes(n))&&Me(e)}function Mt(e){for(let t=e.length-1;t>=1;t--){const n=e[t],o=e[t-1];if(o.type==="sent"&&n.type==="received"&&Te(o.content)&&me(n.content))return n.timestamp;if(t>=2){const s=e[t-2];if(s.type==="received"&&o.type==="sent"&&n.type==="received"){const a=s.content.toLowerCase();if((a.includes("schedule")||a.includes("after")||a.includes("next week")||a.includes("vacation")||a.includes("holiday"))&&me(n.content))return n.timestamp}}}return null}function At(e){for(let t=e.length-1;t>=0;t--){const n=e[t];if(n.type==="sent"){const o=n.content.toLowerCase();if(Me(n.content)||Tt(n.content))continue;if(nt.some(s=>o.includes(s)))return n.timestamp}}return null}function Ct(e){const t=Mt(e);if(t)return{isClosed:!0,closeType:"pending_meeting",closeTimestamp:t,reason:"Meeting scheduled"};const n=At(e);return n?{isClosed:!0,closeType:"my_close",closeTimestamp:n,reason:"I closed the conversation"}:{isClosed:!1,closeType:"none",closeTimestamp:null,reason:""}}async function Et(e,t,n,o){if(!e.isClosed||!e.closeTimestamp)return{shouldSkip:!1,reason:""};const s=Date.now()-e.closeTimestamp,a=Math.round(s/(1e3*60*60*24));l("INFO",`Checking engagement with AI (${a} days since close)...`,"System");const r=await Ne(n,t,e.closeType,a,o);return{shouldSkip:!r.shouldEngage,reason:r.reason}}function Pt(e){return e==="Unknown"?!0:tt.some(t=>e.toLowerCase().includes(t))}function Dt(e){const t=Date.now(),n=e[e.length-1],o=(n==null?void 0:n.timestamp)||t,s=Math.floor((t-o)/(1e3*60*60*24));let a=!1,r=null,i=!1,c=!1,p=null,h=!1;for(const m of e){const g=m.content.toLowerCase();if(m.type==="sent"&&Te(m.content)&&(a=!0,r=m.timestamp),m.type==="received"){me(m.content)&&(i=!0),["tell me more","interested","sounds interesting","would be great","please","yes please","walkthrough","demo","show me"].some(k=>g.includes(k))&&(h=!0);for(const{pattern:k,reason:E}of lt)if(g.includes(k)){c=!0,p=E;break}}}return{schedulingLinkSent:a,schedulingLinkTimestamp:r,leadConfirmedInterest:i,reschedulingRequested:c,reschedulingReason:p,daysSinceLastActivity:s,lastMessageIsShortPing:n?vt(n.content):!1,iSentLastMessage:(n==null?void 0:n.type)==="sent",leadShowedStrongInterest:h}}function It(e,t,n){const o=Dt(e),s=e.length;let a="active",r="",i="",c="";return s<4?(a="new",r="New conversation - still building rapport",i="This is a fresh conversation.",c="Be friendly and conversational. Don't push too hard - build rapport first."):t.closeType==="pending_meeting"?(a="pending_meeting",o.reschedulingRequested&&o.reschedulingReason?(r=`Pending meeting - they asked to reschedule due to ${o.reschedulingReason}`,i="You sent a scheduling link. They asked to reschedule. Now they're back.",c=o.lastMessageIsShortPing?"Be warm and welcoming. Reference their break. Ask if they're ready to schedule.":"Answer their questions and offer to schedule."):(r="Pending meeting - scheduling link sent",i="You already sent a scheduling link and they showed interest.",c="Be helpful. Acknowledge warmly and offer to help schedule.")):t.closeType==="my_close"?(a="closed",r="Conversation was closed/declined",i="You previously closed this conversation politely.",c="Be polite but brief. Don't re-pitch aggressively."):o.daysSinceLastActivity>14?(a="re_engaging",r=`Re-engaging after ${o.daysSinceLastActivity} days`,i=`It's been ${o.daysSinceLastActivity} days since the last message.`,c="Acknowledge the time gap briefly. Don't be pushy."):(a="active",r=o.leadShowedStrongInterest?"Active - lead has shown strong interest":"Active conversation",i="Ongoing conversation.",c="Be helpful and natural. Match their energy."),o.lastMessageIsShortPing&&a!=="pending_meeting"&&(c+=" Their last message was a short greeting - respond warmly first."),{state:a,stateDescription:r,keyContextSummary:i,responseGuidance:c}}async function Rt(e,t,n,o,s,a,r=!1,i="llama-3.3-70b-versatile",c){var d,x;const p=n.slice(-30),h=p.map(v=>`${v.speaker}: ${v.content}`).join(`
`),m=It(n,c||{closeType:"none"}),g=a?`
LEAD PROFILE:
${We(a)}
`:"",k=t.replace("{extracted_text}",h).replace("{user_name}",o).replace("{lead_headline}",(a==null?void 0:a.headline)||"Unknown"),E=`You are a real professional messaging on LinkedIn (NOT an AI assistant).
${g}
=== CONVERSATION STATE ===
STATE: ${m.stateDescription}
CONTEXT: ${m.keyContextSummary}

=== RESPONSE GUIDANCE ===
${m.responseGuidance}

=== CONVERSATION HISTORY ===
${h}

USER'S INSTRUCTIONS:
${k}

CRITICAL RULES:
1. LENGTH: 15-30 words. Be concise.
2. TONE: Match their energy.
3. NATURAL: Use contractions. Be conversational.
4. If they say "hi" or "how are you", respond warmly FIRST, then ask how you can help.
5. Don't immediately send links after a greeting.
6. Reference shared context naturally.

Respond as ${s}.`,L=r?"https://api.groq.com/openai/v1/chat/completions":"https://api.openai.com/v1/chat/completions",I=r?i:"gpt-4o-mini",N=r?250:150,T=await ut(()=>fetch(L,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:I,messages:[{role:"system",content:E},...p.map(v=>({role:v.type==="received"?"user":"assistant",content:v.content}))],max_tokens:N,temperature:.7})}),3,1e3);if(!T.ok){const v=await T.text();throw new Error(`API Error ${T.status}: ${v.slice(0,500)}`)}const P=await T.json(),_=(((d=P.usage)==null?void 0:d.prompt_tokens)||0)+(((x=P.usage)==null?void 0:x.completion_tokens)||0);return{reply:P.choices[0].message.content.trim(),tokensUsed:_}}function Nt(){var t;const e=document.querySelector(".global-nav__me-content span");return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||"You"}function he(e){return{"llama-3.3-70b-versatile":"Llama-3.3-70B","gpt-4o-mini":"GPT-4o-mini","gpt-4o":"GPT-4o"}[e]||e}function _t(e){return e==="groq"?"Groq":"OpenAI"}function xt(e,t){var o,s;const n=[e.toLowerCase(),((o=t==null?void 0:t.company)==null?void 0:o.toLowerCase())||"",((s=t==null?void 0:t.jobTitle)==null?void 0:s.toLowerCase())||""];for(const a of ce){const r=a.toLowerCase();for(const i of n)if(i&&i.includes(r))return!0}return!1}async function Ot(e,t){return new Promise(n=>{D=n,chrome.storage.local.set({pendingReply:{leadName:e,reply:t,timestamp:Date.now()}}),l("INFO",`Waiting for approval to reply to ${e}...`,"System"),setTimeout(()=>{D&&(l("WARNING",`Reply approval timed out for ${e}`,"System"),D({approved:!1,reply:""}),D=null,chrome.storage.local.remove(["pendingReply"]))},5*60*1e3)})}async function Ae(e,t=6,n=400){for(let o=0;o<t;o++){const s=document.querySelector(e);if(s)return s;await y(n)}return null}function Ce(e,t){return y(Math.floor(Math.random()*(t-e+1))+e)}function fe(e){return typeof e=="string"?e:e&&typeof e=="object"&&"message"in e?e.message:"Unknown error"}async function ge(e){var d,x,v,ye,K,J;l("INFO",`Starting batch of ${e} chats...`,"System");const{apiKey:t,groqApiKey:n,chatMin:o,chatMax:s,loopMin:a,loopMax:r,prompt:i,leadPrompt:c,webhookUrl:p,startHour:h,endHour:m,replyProvider:g,decisionProvider:k,leadDetectionProvider:E}=await ht(),L=pe(g,t,n),I=pe(k,t,n),N=pe(E,t,n),T=g==="groq"?ie:"gpt-4o-mini";if($("currentModel",he(T)),ce=(await chrome.storage.local.get(["blacklist"])).blacklist||[],re&&!dt(h,m)){l("WARNING",`Outside working hours (${h}-${m}). Pausing.`,"System"),A&&!C&&(z=window.setTimeout(()=>ge(e),15*60*1e3));return}const P=Nt();await mt(5);let _=Array.from(document.querySelectorAll("ul.msg-conversations-container__conversations-list li")).slice(0,e).sort(()=>Math.random()-.2);l("INFO",`Found ${_.length} conversations to check.`,"Bot");for(let Y=0;Y<_.length&&A;Y++){for(;C&&A;)await y(1e3);if(!A)break;await pt(),await Ce(o,s);const we=_[Y].querySelector("a, .msg-conversation-listitem__link, [tabindex='0']");we==null||we.click(),await y(2e3);const f=ft();if(!f)continue;const Q=yt(f);if(!Q||!Q.fromLead){l("INFO",`Skipping ${f}: Last message was from me.`,"Bot");continue}const $t=wt(f,5),u=await bt(f),X=Ct(u.messages);if(X.isClosed){const w=await Et(X,$t,I,k);if(w.shouldSkip){l("INFO",`Skipping ${f}: ${w.reason} [AI/${X.closeType}]`,"Bot");continue}l("INFO",`Engaging ${f}: ${w.reason} [AI]`,"Bot")}const Lt=((d=u.profile)==null?void 0:d.headline)||"Unknown";if(Pt(Lt)&&!Q.content.includes("?")&&Q.content.split(" ").length<12){l("INFO",`Skipping ${f}: Irrelevant headline`,"Bot");continue}if(xt(f,u.profile)){l("WARNING",`Skipping ${f}: Blacklisted`,"Bot");continue}if(l("INFO",`Checking chat with ${B(f,u.profile)}...`,"Bot"),$("chatsProcessed",1),u.messages.length===0){l("WARNING",`No messages found for ${f}`,"System");continue}const Ut=u.messages.slice(-8).map(w=>({speaker:w.speaker,message:w.content}));let Z;try{Z=await Re(I,Ut,f,k),l("ACTION",`AI Decision: ${Z.shouldReply?"REPLY":"SKIP"} (${Z.reason}) [${_t(k)}]`,"Bot")}catch(w){l("ERROR",`AI Decision Failed: ${fe(w)}`,"System");continue}if(!Z.shouldReply)continue;if(p)try{const w=u.messages.slice(-2).map(M=>M.content);if(await _e(N,c,w,E)){const M={leadName:f,profileUrl:u.profileUrl,company:((x=u.profile)==null?void 0:x.company)||"Unknown",jobTitle:((v=u.profile)==null?void 0:v.jobTitle)||"Unknown",headline:((ye=u.profile)==null?void 0:ye.headline)||"Unknown",conversationHistory:u.messages.map(R=>`${R.speaker}: ${R.content}`).join(`
`),messageCount:u.messages.length,detectedAt:new Date().toISOString()};await xe(M),$("leadsFound",1),l("SUCCESS",`ðŸ”¥ HOT LEAD: ${f} sent to webhook!`,"Bot")}}catch(w){l("ERROR",`Lead webhook failed: ${fe(w)}`,"System")}let ee;try{ee=await Rt(L,i,u.messages,f,P,u.profile,g==="groq",ie,X),$("tokensUsed",ee.tokensUsed)}catch(w){l("ERROR",`Reply Generation Failed: ${fe(w)}`,"System");continue}let U=ee.reply;if(le){const w=await Ot(f,ee.reply);if(!w.approved){l("INFO",`Reply to ${f} skipped by user`,"User");continue}U=w.reply}const W=await Ae("div.msg-form__contenteditable[role='textbox']",6,400),O=await Ae("button.msg-form__send-button",6,400);if(W&&O){const w={messageCount:u.messages.length,lastMessageQuestions:(((K=u.messages[u.messages.length-1])==null?void 0:K.content.match(/\?/g))||[]).length},M=Ve(U,w)?ze(U):null;if(M){if(l("ACTION",`Double-texting ${f} (${M.pattern})...`,"Bot"),await y(ue(M.firstMessage)),await de(W,M.firstMessage),await y(800),!O.hasAttribute("disabled")){O.click(),await y(500);const R=et(M.pattern);l("INFO",`Waiting ${Math.round(R/1e3)}s before second message...`,"Bot"),await y(R),await y(ue(M.secondMessage)),await de(W,M.secondMessage),await y(800),O.hasAttribute("disabled")||(O.click(),await y(500),$("repliesSent",1),u.messages.push({speaker:P,content:M.firstMessage,timestamp:Date.now()-R,type:"sent"},{speaker:P,content:M.secondMessage,timestamp:Date.now(),type:"sent"}),u.metadata.lastActivity=Date.now(),u.metadata.lastMessageFrom="me",u.metadata.totalMessages+=2,u.metadata.lastSyncedAt=Date.now(),await ae(u),l("SUCCESS",`Double-texted ${B(f,u.profile)} (${he(T)})`,"Bot"))}}else{const R=ue(U);l("ACTION",`Typing reply to ${f} (waiting ${Math.round(R/1e3)}s)...`,"Bot"),await y(R),await de(W,U),await y(800),O.hasAttribute("disabled")?l("ERROR",`Send button disabled for ${f}`,"System"):(O.click(),await y(500),(((J=W.textContent)==null?void 0:J.trim())||"").length===0?($("repliesSent",1),u.messages.push({speaker:P,content:U,timestamp:Date.now(),type:"sent"}),u.metadata.lastActivity=Date.now(),u.metadata.lastMessageFrom="me",u.metadata.totalMessages++,u.metadata.lastSyncedAt=Date.now(),await ae(u),l("SUCCESS",`Sent reply to ${B(f,u.profile)} (${he(T)})`,"Bot")):l("WARNING",`Message may not have sent to ${f}`,"System"))}}else l("ERROR","Could not find chat input or send button","System");await Ce(o,s)}l("INFO","Batch finished. Sleeping...","System"),A&&!C&&(z=window.setTimeout(()=>ge(e),Math.floor(Math.random()*(r-a+1))+a))}chrome.runtime.onMessage.addListener((e,t,n)=>{var o,s,a,r,i;if(e.type==="PING_TEST"){n("âœ… Content script active!");return}if(e.type==="GET_STATUS"){n({running:A,paused:C,stats:H,logs:G});return}if(e.type==="START_BOT"){A?n({status:"error",error:"Already running"}):(A=!0,C=!1,H={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:Date.now(),tokensUsed:0,currentModel:""},re=((o=e.config)==null?void 0:o.strictHours)??!0,ie=((s=e.config)==null?void 0:s.groqModel)??"llama-3.3-70b-versatile",le=((a=e.config)==null?void 0:a.replyPreviewEnabled)??!1,ce=((r=e.config)==null?void 0:r.blacklist)??[],l("INFO",`Bot started (Strict Hours: ${re?"ON":"OFF"}, Preview: ${le?"ON":"OFF"})`,"User"),ge(((i=e.config)==null?void 0:i.nChats)??10),n({status:"ok"}));return}if(e.type==="STOP_BOT"){A=!1,C=!1,z!==null&&clearTimeout(z),l("INFO","Bot stopped by user","User"),n({status:"stopped"});return}if(e.type==="PAUSE_BOT"){A&&!C?(C=!0,l("INFO","Bot paused by user","User"),n({status:"paused"})):n({status:"error",error:"Not running or already paused"});return}if(e.type==="RESUME_BOT"){A&&C?(C=!1,l("INFO","Bot resumed by user","User"),n({status:"running"})):n({status:"error",error:"Not paused"});return}if(e.type==="APPROVE_REPLY"){D&&(l("SUCCESS",`Reply to ${e.leadName} approved`,"User"),D({approved:!0,reply:e.reply}),D=null,chrome.storage.local.remove(["pendingReply"])),n({status:"ok"});return}if(e.type==="REJECT_REPLY"){D&&(l("INFO",`Reply to ${e.leadName} rejected`,"User"),D({approved:!1,reply:""}),D=null,chrome.storage.local.remove(["pendingReply"])),n({status:"ok"});return}if(e.type==="CHECK_UNREAD"){A&&!C&&l("INFO","Check unread triggered by background","System"),n({status:"ok"});return}})})();
