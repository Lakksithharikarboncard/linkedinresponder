(function(){"use strict";const b={openaiApiKey:"openaiApiKey",groqApiKey:"groqApiKey",groqApiKey2:"groqApiKey2",routewayApiKey:"routewayApiKey",webhookUrl:"webhookUrl",replyPrompt:"replyPrompt",leadPrompt:"leadPrompt",chatMinDelay:"chatMinDelay",chatMaxDelay:"chatMaxDelay",loopMinDelay:"loopMinDelay",loopMaxDelay:"loopMaxDelay",startHour:"startHour",endHour:"endHour",replyProvider:"replyProvider",leadDetectionProvider:"leadDetectionProvider",groqModel:"groqModel",openaiModel:"openaiModel",routewayModel:"routewayModel"},T={openaiApiKey:"",groqApiKey:"",groqApiKey2:"",routewayApiKey:"",webhookUrl:"",replyPrompt:`You are {user_name}'s assistant. Reply to this lead based on context:
{extracted_text}
Reply briefly and professionally.`,leadPrompt:"Does this conversation indicate strong buying intent or interest? Reply YES or NO.",chatMinDelay:2e3,chatMaxDelay:5e3,loopMinDelay:1e4,loopMaxDelay:3e4,startHour:9,endHour:18,replyProvider:"routeway",leadDetectionProvider:"routeway",groqModel:"openai/gpt-oss-120b",openaiModel:"gpt-5.1",routewayModel:"devstral-2512:free"},Fe=["openai","groq","routeway"],qe=["openai/gpt-oss-20b","openai/gpt-oss-120b","llama-3.3-70b-versatile","llama-3.1-8b-instant","moonshotai/kimi-k2-instruct-0905"],je=["gpt-5.1","gpt-5","gpt-5-mini","gpt-5-nano","gpt-5.1-chat-latest"],Be=["devstral-2512:free","kimi-k2-0905:free","minimax-m2:free","deepseek-r1t2-chimera:free"];function ge(e,t,o,n){const s=typeof e=="number"?e:Number(e);if(!Number.isFinite(s))return n;const a=Math.round(s);return Math.min(o,Math.max(t,a))}function ee(e,t,o,n){const s=typeof e=="number"?e:Number(e);return Number.isFinite(s)?Math.min(o,Math.max(t,Math.floor(s))):n}function F(e,t){return typeof e!="string"?t:e}function we(e,t){return typeof e=="string"&&Fe.includes(e)?e:t}function Ge(e,t){return typeof e=="string"&&qe.includes(e)?e:t}function He(e,t){return typeof e=="string"&&je.includes(e)?e:t}function Ke(e,t){return typeof e=="string"&&Be.includes(e)?e:t}function to(e){return e}function Ye(e){return e.trim()}async function ae(){return new Promise(e=>{chrome.storage.local.get(Object.values(b),t=>{const o=ee(t[b.chatMinDelay],250,6e4,T.chatMinDelay),n=ee(t[b.chatMaxDelay],250,12e4,T.chatMaxDelay),s=ee(t[b.loopMinDelay],500,6e5,T.loopMinDelay),a=ee(t[b.loopMaxDelay],500,6e5,T.loopMaxDelay),r=Math.min(o,n),l=Math.max(o,n),c=Math.min(s,a),d=Math.max(s,a),m=ge(t[b.startHour],0,23,T.startHour),f=ge(t[b.endHour],0,23,T.endHour),v={openaiApiKey:F(t[b.openaiApiKey],T.openaiApiKey).trim(),groqApiKey:F(t[b.groqApiKey],T.groqApiKey).trim(),groqApiKey2:F(t[b.groqApiKey2],T.groqApiKey2).trim(),routewayApiKey:F(t[b.routewayApiKey],T.routewayApiKey).trim(),webhookUrl:Ye(F(t[b.webhookUrl],T.webhookUrl)),replyPrompt:F(t[b.replyPrompt],T.replyPrompt),leadPrompt:F(t[b.leadPrompt],T.leadPrompt),chatMinDelay:r,chatMaxDelay:l,loopMinDelay:c,loopMaxDelay:d,startHour:m,endHour:f,replyProvider:we(t[b.replyProvider],T.replyProvider),leadDetectionProvider:we(t[b.leadDetectionProvider],T.leadDetectionProvider),groqModel:Ge(t[b.groqModel],T.groqModel),openaiModel:He(t[b.openaiModel],T.openaiModel),routewayModel:Ke(t[b.routewayModel],T.routewayModel)};e(v)})})}async function We(e){const t=await ae();return e==="groq"?t.groqModel:e==="routeway"?t.routewayModel:t.openaiModel}async function ke(e,t,o,n=60){var a,r,l,c,d,m,f,v;const s=await We(o);if(o==="groq"){const y=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,messages:[{role:"user",content:t}],max_tokens:n,temperature:.2})});if(!y.ok)throw new Error(`Groq API error: ${y.status}`);return((c=(l=(r=(a=(await y.json()).choices)==null?void 0:a[0])==null?void 0:r.message)==null?void 0:l.content)==null?void 0:c.trim())||""}else if(o==="routeway"){const y=await fetch("https://api.routeway.ai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,messages:[{role:"user",content:t}],max_tokens:n,temperature:.2})});if(!y.ok)throw new Error(`Routeway API error: ${y.status}`);return((v=(f=(m=(d=(await y.json()).choices)==null?void 0:d[0])==null?void 0:m.message)==null?void 0:f.content)==null?void 0:v.trim())||""}else{const y=await fetch("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,input:t})});if(!y.ok)throw new Error(`OpenAI API error: ${y.status}`);const A=await y.json();if(A.output_text)return A.output_text.trim();if(A.output&&Array.isArray(A.output)){for(const O of A.output)if(O.type==="message"&&O.content){for(const D of O.content)if(D.type==="output_text"&&D.text)return D.text.trim()}}return""}}async function Je(e,t,o,n,s="openai"){var r;if(t.length===0)return{shouldEngage:!1,reason:"No messages to evaluate"};const a=t.join(" ").toLowerCase();if(a.includes("?"))return{shouldEngage:!0,reason:"Message contains a question"};if(a.split(/\s+/).length>15)return{shouldEngage:!0,reason:"Substantial message content"};if(o==="pending_meeting"&&n<=7){const l=`You are analyzing LinkedIn messages to decide if we should RESPOND.

CONTEXT: 
- We sent a scheduling link previously
- They confirmed interest and we have a pending meeting
- It's been ${n} day(s) since they confirmed
- They just sent these messages:

${t.map((c,d)=>`${d+1}. "${c}"`).join(`
`)}

QUESTION: Are they following up to schedule, asking a question, or showing engagement?

Consider:
- Casual questions like "how about you?" or "and you?" = ENGAGE
- Greetings followed by "hope you're doing well" type messages = ENGAGE
- Simple "hi" or "hey" with nothing else = might be SKIP
- Any question, even casual = ENGAGE

Reply with ONLY:
ENGAGE: [brief reason]
OR
SKIP: [brief reason]`;try{const c=await ke(e,l,s,50),d=c.toUpperCase().startsWith("ENGAGE"),m=((r=c.split(":")[1])==null?void 0:r.trim())||"AI decision";return{shouldEngage:d,reason:m}}catch(c){return console.error("âŒ Engagement check failed:",c),{shouldEngage:!0,reason:"AI error - defaulting to engage"}}}return(o==="my_close"||n>7)&&a.split(/\s+/).length<=5?{shouldEngage:!1,reason:`Short message during cooldown (${n} days)`}:{shouldEngage:!0,reason:"Default to engage"}}async function ze(e,t,o,n="openai"){const s=`You are an AI assistant helping identify qualified leads.
Rule: ${t}
Analyze the following two LinkedIn messages: ${o.join(`
`)}
Respond with only one word: "yes" or "no".`;try{return(await ke(e,s,n,10)).toLowerCase()==="yes"}catch(a){return console.error("âŒ GPT lead check failed:",a),!1}}async function Se(e){const{webhookUrl:t}=await ae();if(!t||t.trim().length===0)throw new Error("Webhook URL is not configured. Please set it in Options.");const o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok){const n=await o.text().catch(()=>"Unknown error");throw console.error("âŒ Webhook error:",n),new Error(`Webhook error: ${o.status}`)}console.log("âœ… Lead sent to webhook successfully")}const re="conversation_histories",be=500,Ve=6e4;function Qe(e,t){const o=`${e}_${t}`;return btoa(unescape(encodeURIComponent(o))).substring(0,32)}async function Ae(){return new Promise(e=>{chrome.storage.local.get([re],t=>{e(t[re]||{})})})}async function Xe(e){return(await Ae())[e]||null}async function ie(e){const t=await Ae();return e.messages.length>be&&(e.messages=e.messages.slice(-be)),t[e.leadId]=e,new Promise(o=>{chrome.storage.local.set({[re]:t},()=>{o()})})}function Ze(e){return e?Date.now()-e.metadata.lastSyncedAt>Ve:!0}const J={headline:[".pv-text-details__left-panel h2",".text-body-medium.break-words",'div[data-view-name="profile-headline"]',".pv-top-card--list-bullet .text-body-small"],jobTitle:[".pv-text-details__left-panel .text-body-small:first-of-type",".pv-top-card--list-bullet .text-body-small:first-child"],company:[".pv-text-details__left-panel .text-body-small.inline a",'a[data-field="experience_company_logo"]',".experience-item__company"],location:[".pv-text-details__left-panel .text-body-small:last-of-type","span.text-body-small.inline.t-black--light.break-words",".pv-top-card--list-bullet .text-body-small:last-child"],connectionDegree:[".dist-value","span.dist-value",".pv-top-card--list-bullet span.dist-value"]},et=/(status is (online|offline|reachable|active now))/i;function z(e){var t;for(const o of e){const n=document.querySelector(o);if((t=n==null?void 0:n.textContent)!=null&&t.trim())return n.textContent.trim()}return""}function tt(e){if(!e)return"";const t=e.split(`
`).map(n=>n.trim()).filter(n=>n&&!et.test(n.toLowerCase())).join(" ").replace(/\s+/g," ").trim();return t.split(" ").filter(Boolean).length<3?"Unknown":t}function ot(){var t,o;let e=z(J.headline);if(!e){const n=(o=(t=document.querySelector(".msg-thread__link-to-profile"))==null?void 0:t.textContent)==null?void 0:o.trim();n&&(e=n)}return tt(e)}function nt(){return z(J.jobTitle).replace(/^at\s+/i,"").trim()||"Unknown"}function st(){let e=z(J.company);return e=e.replace(/^at\s+/i,"").trim(),e||"Unknown"}function at(){return z(J.location)||"Unknown"}function rt(){let e=z(J.connectionDegree);const t=e.match(/(\d+(?:st|nd|rd|th))/);return t?t[1]:e||"Unknown"}function it(){return{headline:ot(),jobTitle:nt(),company:st(),location:at(),connectionDegree:rt(),lastScraped:Date.now()}}function V(e,t){if(!t)return e;const o=[];t.jobTitle&&t.jobTitle!=="Unknown"&&o.push(t.jobTitle),t.company&&t.company!=="Unknown"&&o.push(`@ ${t.company}`),t.location&&t.location!=="Unknown"&&o.push(t.location);const n=o.length>0?` (${o.join(", ")})`:"";return`${e}${n}`}function lt(e){if(!e)return"Profile: Not available";const t=[];return e.headline&&e.headline!=="Unknown"&&t.push(`Headline: ${e.headline}`),e.jobTitle&&e.jobTitle!=="Unknown"&&t.push(`Job Title: ${e.jobTitle}`),e.company&&e.company!=="Unknown"&&t.push(`Company: ${e.company}`),e.location&&e.location!=="Unknown"&&t.push(`Location: ${e.location}`),e.connectionDegree&&e.connectionDegree!=="Unknown"&&t.push(`Connection: ${e.connectionDegree}`),t.length?t.join(" | "):"Profile: Not available"}function ct(e,t){const o=e.split(" ").length>40,n=t.lastMessageQuestions>0;return o||n}function ut(e,t){const o=[dt,pt,mt,ht];for(const n of o){const s=n(e);if(s)return s}return null}function dt(e){const t=e.split(/[.!?]/).filter(a=>a.trim());if(t.length<3)return null;const o=Math.floor(t.length/2),n=t.slice(0,o).join(". ").trim(),s=t.slice(o).join(". ").trim();return n.length<20||s.length<10?null:{firstMessage:n,secondMessage:s,delayMs:3e3+Math.random()*4e3,pattern:"price_breakdown"}}function pt(e){const t=e.split(/[.!?]/).filter(r=>r.trim());if(t.length<2)return null;const o=t[0].trim(),n=t.slice(1).join(". ").trim(),s=["Quick note:","Also,","One more thing:"],a=s[Math.floor(Math.random()*s.length)];return{firstMessage:o,secondMessage:`${a} ${n.charAt(0).toLowerCase()}${n.slice(1)}`,delayMs:5e3+Math.random()*3e3,pattern:"afterthought"}}function mt(e){if(!e.includes("?")||!e.trim().endsWith("?"))return null;const t=["No rushâ€”ballpark is fine.","Roughly is okay.","Just an estimate works."];return{firstMessage:e.trim(),secondMessage:t[Math.floor(Math.random()*t.length)],delayMs:1800+Math.random()*1200,pattern:"question_refinement"}}function ht(e){if(e.split(" ").length>15||/[.!?]$/.test(e.trim())||![/^(yeah|yes|yep|sure|sounds good|makes sense|got it|perfect)/i].some(s=>s.test(e)))return null;const n=["ðŸ‘","ðŸ‘Œ","âœ…"];return{firstMessage:e.trim(),secondMessage:n[Math.floor(Math.random()*n.length)],delayMs:1500+Math.random()*1500,pattern:"emoji_followup"}}function ft(e){const o={price_breakdown:3e3,afterthought:5e3,question_refinement:1800,emoji_followup:1500}[e]??3e3,n=o*.4;return o+(Math.random()-.5)*2*n}let P=!1,$=!1,te=null,Q={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:null,tokensUsed:0,currentModel:""},X=[],le=!1,R=null,ce=[];const yt=["student","intern","seeking","open to work","looking for","hiring"],gt=["no overlap","not a fit","reach out if","feel free to reach out","thanks for letting me know","happy to stay connected","best of luck","good luck with","wishing you","take care","all the best","not what you're looking for","doesn't seem like a match","maybe in the future","keep in touch"],wt=["schedule","reschedule","next week","after jan","after january","after the","let's","lets","call","meet","demo","walkthrough","chat soon","talk soon","talk then","sounds good","works for me","perfect","great","book","calendar","calendly","outlook"],kt=["no problem","no worries","sure thing","of course","absolutely","definitely"],St=["calendly.com","cal.com","outlook.office.com/book","hubspot.com/meetings","savvycal.com","tidycal.com","book a time","grab time","schedule a call","schedule a chat","book a call","here's a link","here is a link","whenever works","pick a time","find a time"],bt=["sounds good","sounds great","perfect","will do","see you then","looking forward","look forward","talk soon","talk then","catch you","thanks for sharing","thank you for sharing","i'll check","i will check","let me check","booked","scheduled","confirmed","done","great","thanks","awesome","cool","ok great","okay great","works for me"],At=["hi","hey","hello","hii","hiii","heyy","heyyy","yo","sup","morning","good morning","good afternoon","good evening","gm"],Mt=[{pattern:"vacation",reason:"vacation"},{pattern:"holiday",reason:"holiday"},{pattern:"traveling",reason:"traveling"},{pattern:"travel",reason:"travel"},{pattern:"out of office",reason:"out of office"},{pattern:"out of town",reason:"out of town"},{pattern:"busy",reason:"busy schedule"},{pattern:"swamped",reason:"busy schedule"},{pattern:"hectic",reason:"busy schedule"},{pattern:"next week",reason:"timing"},{pattern:"after the",reason:"timing"},{pattern:"after jan",reason:"new year"},{pattern:"after january",reason:"new year"},{pattern:"new year",reason:"new year"}],Tt={"openai/gpt-o-ss-20b":"GPT-OSS 20B","openai/gpt-o-ss-120b":"GPT-OSS 120B","llama-3.3-70b-versatile":"Llama 3.3 70B","llama-3.1-8b-instant":"Llama 3.1 8B","moonshot/ai/kimi-k2-instruct-0905":"Kimi K2","gpt-5.1":"GPT-5.1","gpt-5":"GPT-5","gpt-5-mini":"GPT-5 mini","gpt-5-nano":"GPT-5 nano","gpt-5.1-chat-latest":"GPT-5.1 Chat","devstral-2512/free":"Devstral 2512","kimi-k2-0905/free":"Kimi K2","minimax-m2/free":"Minimax M2","deepseek-r1t2-chimera/free":"DeepSeek R1T2"};function g(e){return new Promise(t=>setTimeout(t,e))}async function B(e,t=3,o=1e3){let n=0;for(;;){const s=await e();if(s.ok)return s;if((s.status===429||s.status>=500)&&n<t){const a=o*2**n+Math.random()*400;await g(a),n++;continue}return s}}function i(e,t,o){const n={time:Date.now(),type:e,message:t,actor:o};X.unshift(n),X.length>100&&X.pop(),chrome.storage.local.set({botLog:X.slice(0,50)})}function G(e,t){e==="startTime"?Q.startTime=t:e==="currentModel"?Q.currentModel=t:Q[e]+=t}function ue(e){return 2e3+e.split(" ").length/300*Math.random()*2e3}function vt(e=9,t=18){const o=new Date().getHours();return o>=e&&o<=t}async function de(e,t){e.focus(),await g(50),document.execCommand("selectAll",!1),document.execCommand("delete",!1);for(const o of t)document.execCommand("insertText",!1,o),await g(Math.random()<.9?150+30*Math.random():50)}async function Et(){const e=document.querySelector(".msg-s-message-list__content");e&&(e.scrollBy(0,Math.random()*80+20),await g(300+Math.random()*500),e.scrollBy(0,-Math.random()*50+10),await g(300+Math.random()*500))}async function It(e=5){const t=document.querySelector(".msg-conversations-container--inbox-shortcuts");if(t)for(let o=0;o<e;o++)t.scrollBy({top:Math.random()*200+100,behavior:"smooth"}),await g(500+Math.random()*800),t.scrollBy({top:-Math.random()*50,behavior:"smooth"}),await g(400+Math.random()*500)}let pe=0;function Ct(e,t){return t!=null&&t.trim()?e!=null&&e.trim()?(pe=(pe+1)%2,pe===0?e:t):t:e}function Me(e,t,o,n,s){return e==="groq"?Ct(o,n):e==="routeway"?s:t}function Ot(e,t,o,n){return e==="groq"?t:e==="routeway"?n:o}async function xt(){const e=await ae();return{apiKey:e.openaiApiKey,groqApiKey:e.groqApiKey,groqApiKey2:e.groqApiKey2,routewayApiKey:e.routewayApiKey,chatMin:e.chatMinDelay,chatMax:e.chatMaxDelay,loopMin:e.loopMinDelay,loopMax:e.loopMaxDelay,prompt:e.replyPrompt,leadPrompt:e.leadPrompt,webhookUrl:e.webhookUrl,startHour:e.startHour,endHour:e.endHour,replyProvider:e.replyProvider,leadDetectionProvider:e.leadDetectionProvider,groqModel:e.groqModel,openaiModel:e.openaiModel,routewayModel:e.routewayModel}}function Nt(){var t;const e=document.evaluate("id('thread-detail-jump-target')/div/a/div/dl/dt/h2",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())??null}function Pt(){const e=document.querySelector("a[href*='in/']");return(e==null?void 0:e.href)??window.location.href}function Dt(e){var a,r;const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));let o=null;const n=[];for(const l of t){const c=l.querySelector("span.msg-s-message-group__name"),d=l.querySelector("p.msg-s-event-listitem__body");if(c&&(o=((a=c.textContent)==null?void 0:a.trim())??null),d&&o){const m=(r=d.textContent)==null?void 0:r.trim();m&&n.push({sender:o,content:m})}}if(n.length===0)return null;const s=n[n.length-1];return{fromLead:s.sender.includes(e),content:s.content}}function _t(e,t=5){var a,r;const o=Array.from(document.querySelectorAll("li.msg-s-message-list__event"));let n=null;const s=[];for(const l of o){const c=l.querySelector("span.msg-s-message-group__name"),d=l.querySelector("p.msg-s-event-listitem__body");if(c&&(n=((a=c.textContent)==null?void 0:a.trim())??null),d&&n&&n.includes(e)){const m=(r=d.textContent)==null?void 0:r.trim();m&&s.push(m)}}return s.slice(-t)}async function $t(){const e=document.querySelector(".msg-s-message-list__content");if(!e)return;let t=0,o=e.scrollHeight,n=0;for(i("INFO","Loading full conversation history...","System");o>t&&n<50;)t=o,e.scrollTo({top:0,behavior:"smooth"}),await g(800+Math.random()*400),o=e.scrollHeight,n++;i("INFO",`Loaded ${n} message batches`,"System")}async function Lt(e){var s,a;await $t();const t=Array.from(document.querySelectorAll("li.msg-s-message-list__event")),o=[];let n=null;for(const r of t){const l=r.querySelector("span.msg-s-message-group__name"),c=r.querySelector("p.msg-s-event-listitem__body"),d=r.querySelector("time");if(l&&(n=((s=l.textContent)==null?void 0:s.trim())??null),c&&n){const m=(a=c.textContent)==null?void 0:a.trim();let f=Date.now();if(d){const v=d.getAttribute("datetime");v&&(f=new Date(v).getTime())}m&&o.push({speaker:n,content:m,timestamp:f,type:n.includes(e)?"received":"sent"})}}return o}async function Rt(e){var c;const t=Pt(),o=Qe(e,t);let n=await Xe(o);if(n&&!Ze(n))return i("INFO",`Using cached data for ${V(e,n.profile)} (${n.messages.length} msgs)`,"System"),n;i("INFO",`Scraping profile for ${e}...`,"System");const s=it();i("INFO",`Syncing full history for ${e}...`,"System");const a=await Lt(e),r=a[a.length-1],l={leadId:o,leadName:e,profileUrl:t,profile:s,messages:a,metadata:{firstContact:((c=a[0])==null?void 0:c.timestamp)??Date.now(),lastActivity:(r==null?void 0:r.timestamp)??Date.now(),lastMessageFrom:(r==null?void 0:r.type)==="received"?"lead":"me",totalMessages:a.length,lastSyncedAt:Date.now()}};return await ie(l),i("SUCCESS",`Saved ${a.length} messages & profile for ${V(e,s)}`,"System"),l}function Te(e){const t=e.toLowerCase();return St.some(o=>t.includes(o))}function me(e){const t=e.toLowerCase().trim();return t.split(" ").length>10?!1:bt.some(o=>t.includes(o))}function Ut(e){const t=e.toLowerCase().trim();return t.split(" ").length>3?!1:At.some(o=>t===o||t.startsWith(o))}function ve(e){return wt.some(t=>e.toLowerCase().includes(t))}function Ft(e){const t=e.toLowerCase();return kt.some(o=>t.includes(o))&&ve(e)}function qt(e){for(let t=e.length-1;t>=1;t--){const o=e[t],n=e[t-1];if(n.type==="sent"&&o.type==="received"&&Te(n.content)&&me(o.content))return o.timestamp;if(t>=2){const s=e[t-2];if(s.type==="received"&&n.type==="sent"&&o.type==="received"){const a=s.content.toLowerCase();if((a.includes("schedule")||a.includes("after")||a.includes("next week")||a.includes("vacation")||a.includes("holiday"))&&me(o.content))return o.timestamp}}}return null}function jt(e){for(let t=e.length-1;t>=0;t--){const o=e[t];if(o.type==="sent"){const n=o.content.toLowerCase();if(ve(o.content)||Ft(o.content))continue;if(gt.some(s=>n.includes(s)))return o.timestamp}}return null}function Bt(e){const t=qt(e);if(t)return{isClosed:!0,closeType:"pending_meeting",closeTimestamp:t,reason:"Meeting scheduled"};const o=jt(e);return o?{isClosed:!0,closeType:"my_close",closeTimestamp:o,reason:"I closed the conversation"}:{isClosed:!1,closeType:"none",closeTimestamp:null,reason:""}}async function Gt(e,t,o,n){if(!e.isClosed||!e.closeTimestamp)return{shouldSkip:!1,reason:""};const s=Date.now()-e.closeTimestamp,a=Math.round(s/(1e3*60*60*24));i("INFO",`Checking engagement with AI (${a} days since close)...`,"System");const r=await Je(o,t,e.closeType,a,n);return{shouldSkip:!r.shouldEngage,reason:r.reason}}function Ht(e){return!e||e==="Unknown"?!0:yt.some(t=>e.toLowerCase().includes(t))}function Ee(e){const t=Date.now(),o=e[e.length-1],n=(o==null?void 0:o.timestamp)??t,s=Math.floor((t-n)/(1e3*60*60*24));let a=!1,r=null,l=!1,c=!1,d=null,m=!1;for(const f of e){const v=f.content.toLowerCase();if(f.type==="sent"&&Te(f.content)&&(a=!0,r=f.timestamp),f.type==="received"){me(f.content)&&(l=!0),["tell me more","interested","sounds interesting","would be great","please","yes please","walkthrough","demo","show me"].some(y=>v.includes(y))&&(m=!0);for(const{pattern:y,reason:A}of Mt)if(v.includes(y)){c=!0,d=A;break}}}return{schedulingLinkSent:a,schedulingLinkTimestamp:r,leadConfirmedInterest:l,reschedulingRequested:c,reschedulingReason:d,daysSinceLastActivity:s,lastMessageIsShortPing:o?Ut(o.content):!1,iSentLastMessage:(o==null?void 0:o.type)==="sent",leadShowedStrongInterest:m}}function Kt(e,t,o){const n=Ee(e),s=e.length;let a="active",r,l,c;return s<=4?(a="new",r="New conversation - still building rapport",l="This is a fresh conversation.",c="Be friendly and conversational. Don't push too hard - build rapport first."):t.closeType==="pending_meeting"?(a="pendingmeeting",n.reschedulingRequested&&n.reschedulingReason?(r=`Pending meeting - they asked to reschedule due to ${n.reschedulingReason}`,l="You sent a scheduling link. They asked to reschedule. Now they're back.",c=n.lastMessageIsShortPing?"Be warm and welcoming. Reference their break. Ask if they're ready to schedule.":"Answer their questions and offer to schedule."):(r="Pending meeting - scheduling link sent",l="You already sent a scheduling link and they showed interest.",c="Be helpful. Acknowledge warmly and offer to help schedule.")):t.closeType==="my_close"?(a="closed",r="Conversation was closed/declined",l="You previously closed this conversation politely.",c="Be polite but brief. Don't re-pitch aggressively."):n.daysSinceLastActivity>14?(a="reengaging",r=`Re-engaging after ${n.daysSinceLastActivity} days`,l=`It's been ${n.daysSinceLastActivity} days since the last message.`,c="Acknowledge the time gap briefly. Don't be pushy."):(a="active",r=n.leadShowedStrongInterest?"Active - lead has shown strong interest":"Active conversation",l="Ongoing conversation.",c="Be helpful and natural. Match their energy."),n.lastMessageIsShortPing&&a!=="pendingmeeting"&&(c="Their last message was a short greeting - respond warmly first."),{state:a,stateDescription:r,keyContextSummary:l,responseGuidance:c}}async function Yt(e,t,o,n,s,a,r,l,c){var O,D,I,H,K,E;const d=o.slice(-50),m=d.map(h=>`${h.speaker}: ${h.content}`).join(`
`),f=Kt(o,c??{closeType:"none"}),v=a?`

PROFILE:
${lt(a)}`:"",y=t.replace("{extractedtext}",m).replace("{username}",n).replace("{leadheadline}",(a==null?void 0:a.headline)??"Unknown"),A=`You are a real professional messaging on LinkedIn (NOT an AI assistant).${v}

CONVERSATION STATE:
STATE: ${f.stateDescription}
CONTEXT: ${f.keyContextSummary}

YOUR TASK:
1. DECIDE: Should I reply to this conversation?
   Consider:
   - Is the lead genuinely interested or just being polite?
   - Are they asking a real question or making small talk?
   - Would a reply add value or seem pushy?

2. IF YES: Craft a natural, human-like reply (15-30 words)
3. IF NO: Explain why briefly

${f.responseGuidance}

CONVERSATION HISTORY:
${m}

USER'S INSTRUCTIONS:
${y}

OUTPUT FORMAT (JSON ONLY):
Respond with ONLY valid JSON in this exact format:
{
  "shouldreply": true,
  "reason": "brief explanation of decision",
  "reply": "your message here or empty string if shouldreply is false"
}

CRITICAL WRITING RULES (if replying):
1. LENGTH: 15-30 words max. Be concise.
2. NATURAL VOICE: You're a real person, not AI. Sound spontaneous and varied.
3. NO AI PATTERNS:
   - Avoid formal transitions ("However", "Thus", "Moreover")
   - Use casual alternatives ("Honestly", "Well", "actually", "You know")
   - Break perfect grammar occasionally - use contractions naturally
   - Vary sentence length - mix short punchy ones with longer thoughts
4. BANNED PHRASES (never use these):
   - "I'd love to"
   - "I'd be happy to"
   - "I wanted to reach out"
   - "I hope this finds you well"
5. TONE & STYLE:
   - Active voice only (not "It is believed" but "People believe")
   - Match their energy level
   - Be opinionated when appropriate, not neutral
   - Use natural hesitations or informal phrasing
6. PUNCTUATION:
   - Don't overuse commas or semicolons
   - Keep it simple and conversational
7. CONTEXT AWARENESS:
   - If they say "hi" or "hey", respond warmly FIRST
   - Don't immediately pitch or send links after a greeting
   - Reference shared context naturally
   - Show you're paying attention to their situation

Remember: You're ${s}. Write like a real human having a genuine conversation - imperfect, dynamic, uniquely expressive.`;if(r==="groq"){const h=await B(()=>fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:l,messages:[{role:"system",content:A},...d.map(S=>({role:S.type==="received"?"user":"assistant",content:S.content}))],max_tokens:250,temperature:.7})}),3,1e3);if(!h.ok){const S=await h.text();throw new Error(`Groq API Error: ${h.status} ${S.slice(0,500)}`)}const w=await h.json(),M=(((O=w.usage)==null?void 0:O.prompt_tokens)??0)+(((D=w.usage)==null?void 0:D.completion_tokens)??0),k=w.choices[0].message.content.trim();let C;try{C=JSON.parse(k)}catch{C={shouldreply:!0,reason:"AI response parsing failed",reply:k}}return{shouldReply:C.shouldreply??!0,reason:C.reason??"No reason provided",reply:C.reply??k,tokensUsed:M}}else if(r==="routeway"){const h=await B(()=>fetch("https://api.routeway.ai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:l,messages:[{role:"system",content:A},...d.map(S=>({role:S.type==="received"?"user":"assistant",content:S.content}))],max_tokens:250,temperature:.7})}),3,1e3);if(!h.ok){const S=await h.text();throw new Error(`Routeway API Error: ${h.status} ${S.slice(0,500)}`)}const w=await h.json(),M=(((I=w.usage)==null?void 0:I.prompt_tokens)??0)+(((H=w.usage)==null?void 0:H.completion_tokens)??0),k=w.choices[0].message.content.trim();let C;try{C=JSON.parse(k)}catch{C={shouldreply:!0,reason:"AI response parsing failed",reply:k}}return{shouldReply:C.shouldreply??!0,reason:C.reason??"No reason provided",reply:C.reply??k,tokensUsed:M}}else{const h=[{role:"developer",content:A},...d.map(_=>({role:_.type==="received"?"user":"assistant",content:_.content}))],w=await B(()=>fetch("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:l,input:h})}),3,1e3);if(!w.ok){const _=await w.text();throw new Error(`OpenAI API Error: ${w.status} ${_.slice(0,500)}`)}const M=await w.json();let k="";const C=(((K=M.usage)==null?void 0:K.input_tokens)??0)+(((E=M.usage)==null?void 0:E.output_tokens)??0);if(M.output_text)k=M.output_text;else if(M.output&&Array.isArray(M.output))for(const _ of M.output){if(_.type==="message"&&_.content){for(const Y of _.content)if(Y.type==="output_text"&&Y.text){k=Y.text;break}}if(k)break}if(!k)throw new Error("OpenAI returned empty response - no text content found");let S;try{S=JSON.parse(k.trim())}catch{S={shouldreply:!0,reason:"AI response parsing failed",reply:k.trim()}}return{shouldReply:S.shouldreply??!0,reason:S.reason??"No reason provided",reply:S.reply??k.trim(),tokensUsed:C}}}function Wt(){var t;const e=document.querySelector(".global-nav__me-content span");return((t=e==null?void 0:e.textContent)==null?void 0:t.trim())??"You"}function Jt(e){return Tt[e]??e}function zt(e){return e==="groq"?"Groq":e==="routeway"?"Routeway":"OpenAI"}function Vt(e,t){var n,s;const o=[e.toLowerCase(),(n=t==null?void 0:t.company)==null?void 0:n.toLowerCase(),(s=t==null?void 0:t.jobTitle)==null?void 0:s.toLowerCase()];for(const a of ce){const r=a.toLowerCase();for(const l of o)if(l&&l.includes(r))return!0}return!1}async function Qt(e,t){return new Promise(o=>{R=o,chrome.storage.local.set({pendingReply:{leadName:e,reply:t,timestamp:Date.now()}}),i("INFO",`Waiting for approval to reply to ${e}...`,"System"),setTimeout(()=>{R&&(i("WARNING",`Reply approval timed out for ${e}`,"System"),R({approved:!1,reply:""}),R=null,chrome.storage.local.remove("pendingReply"))},5*60*1e3)})}async function Ie(e,t=6,o=400){for(let n=0;n<t;n++){const s=document.querySelector(e);if(s)return s;await g(o)}return null}function Ce(e,t){return g(Math.floor(Math.random()*(t-e+1)+e))}function oe(e){return typeof e=="string"?e:e&&typeof e=="object"&&"message"in e?e.message:"Unknown error"}async function Xt(e,t,o,n,s){var c,d,m,f,v,y,A,O,D;const l=`You are analyzing a LinkedIn conversation to detect if contact information was shared.

LAST 10 MESSAGES:
${t.slice(-10).map(I=>`${I.speaker}: ${I.content}`).join(`
`)}

QUESTION: Has ${o} (the lead) shared ANY of the following in these messages:
1. A scheduling/calendar link (Calendly, Cal.com, Outlook booking, HubSpot meetings, etc.)
2. An email address (for direct contact)
3. A phone number (for direct contact)

RULES:
- ONLY count contact info if ${o} (the lead) shared it, NOT if you shared it
- Ignore email/phone in automatic signatures
- Focus on INTENTIONAL sharing (e.g., "here's my calendar", "email me at", "call me at")
- Even soft signals like "let's schedule" WITH a way to reach them directly counts

Respond with ONLY ONE LINE in this exact format:
YES: [specific reason - e.g., "Shared Calendly link", "Gave email address", "Provided phone number"]
OR
NO: [brief reason why no contact info was shared]`;try{let I="";if(n==="groq"){const E=await B(()=>fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,messages:[{role:"user",content:l}],max_tokens:50,temperature:.2})}),3,1e3);if(!E.ok)throw new Error(`Groq API error: ${E.status}`);I=((f=(m=(d=(c=(await E.json()).choices)==null?void 0:c[0])==null?void 0:d.message)==null?void 0:m.content)==null?void 0:f.trim())||""}else if(n==="routeway"){const E=await B(()=>fetch("https://api.routeway.ai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,messages:[{role:"user",content:l}],max_tokens:50,temperature:.2})}),3,1e3);if(!E.ok)throw new Error(`Routeway API error: ${E.status}`);I=((O=(A=(y=(v=(await E.json()).choices)==null?void 0:v[0])==null?void 0:y.message)==null?void 0:A.content)==null?void 0:O.trim())||""}else{const E=await B(()=>fetch("https://api.openai.com/v1/responses",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:s,input:l})}),3,1e3);if(!E.ok)throw new Error(`OpenAI API error: ${E.status}`);const h=await E.json();if(h.output_text)I=h.output_text.trim();else if(h.output&&Array.isArray(h.output))for(const w of h.output){if(w.type==="message"&&w.content){for(const M of w.content)if(M.type==="output_text"&&M.text){I=M.text.trim();break}}if(I)break}}const H=I.toUpperCase().startsWith("YES"),K=((D=I.split(":")[1])==null?void 0:D.trim())||"AI webhook decision";return{shouldFire:H,reason:K}}catch(I){return i("ERROR",`Webhook AI check failed: ${oe(I)}`,"System"),{shouldFire:!1,reason:"AI error - skipping webhook"}}}async function Oe(e){return new Promise(t=>{chrome.storage.local.get(["webhookFiredLeads"],o=>{const n=o.webhookFiredLeads||{};t(!!n[e])})})}async function xe(e,t){return new Promise(o=>{chrome.storage.local.get(["webhookFiredLeads"],n=>{const s=n.webhookFiredLeads||{};s[e]={firedAt:Date.now(),reason:t},chrome.storage.local.set({webhookFiredLeads:s},()=>{o()})})})}async function he(e){var S,_,Y,Ne,Pe,De,_e,$e,Le,Re;i("INFO",`Starting batch of ${e} chats...`,"System");const t=await xt(),{apiKey:o,groqApiKey:n,groqApiKey2:s,routewayApiKey:a,chatMin:r,chatMax:l,loopMin:c,loopMax:d,prompt:m,leadPrompt:f,webhookUrl:v,startHour:y,endHour:A,replyProvider:O,leadDetectionProvider:D,groqModel:I,openaiModel:H,routewayModel:K}=t,E=Me(O,o,n,s,a),h=Me(D,o,n,s,a),w=Ot(O,I,H,K),M=Jt(w);if(G("currentModel",M),ce=(await chrome.storage.local.get("blacklist")).blacklist??[],!vt(y,A)){i("WARNING",`Outside working hours (${y}-${A}). Pausing.`,"System"),P&&!$&&(te=window.setTimeout(()=>he(e),15*60*1e3));return}const k=Wt();await It(5);let C=Array.from(document.querySelectorAll("ul.msg-conversations-container__conversations-list > li")).slice(0,e).sort(()=>Math.random()-.2);i("INFO",`Found ${C.length} conversations to check.`,"Bot");for(let fe=0;fe<C.length&&P;fe++){for(;$&&P;)await g(1e3);if(!P)break;await Et(),await Ce(r,l);const ye=C[fe].querySelector("a, .msg-conversation-listitem__link, [tabindex='0']");ye==null||ye.click(),await g(2e3);const p=Nt();if(!p)continue;const ne=Dt(p);if(!ne||!ne.fromLead){i("INFO",`Skipping ${p}: Last message was from me.`,"Bot");continue}const Zt=_t(p,5),u=await Rt(p),se=Bt(u.messages);if(Ee(u.messages),v)if(await Oe(u.leadId))i("INFO",`Webhook already sent for ${p}, skipping duplicate`,"System");else try{const j=await Xt(E,u.messages,p,O,w);if(j.shouldFire){const N={leadName:p,profileUrl:u.profileUrl,company:((S=u.profile)==null?void 0:S.company)??"Unknown",jobTitle:((_=u.profile)==null?void 0:_.jobTitle)??"Unknown",headline:((Y=u.profile)==null?void 0:Y.headline)??"Unknown",conversationHistory:u.messages.map(L=>`${L.speaker}: ${L.content}`).join(`
`),messageCount:u.messages.length,detectedAt:new Date().toISOString()};await Se(N),await xe(u.leadId,j.reason),i("SUCCESS",`ðŸ”¥ LEAD CAPTURED: ${p} (${j.reason})`,"Bot")}}catch(j){i("ERROR",`Webhook check failed: ${oe(j)}`,"System")}if(se.isClosed){const x=await Gt(se,Zt,E,O);if(x.shouldSkip){i("INFO",`Skipping ${p}: ${x.reason} (AI/${se.closeType})`,"Bot");continue}i("INFO",`Engaging ${p}: ${x.reason} (AI)`,"Bot")}const eo=((Ne=u.profile)==null?void 0:Ne.headline)??"Unknown";if(Ht(eo)&&!ne.content.includes("?")&&ne.content.split(" ").length<12){i("INFO",`Skipping ${p}: Irrelevant headline`,"Bot");continue}if(Vt(p,u.profile)){i("WARNING",`Skipping ${p}: Blacklisted`,"Bot");continue}if(i("INFO",`Checking chat with ${V(p,u.profile)}...`,"Bot"),G("chatsProcessed",1),u.messages.length===0){i("WARNING",`No messages found for ${p}`,"System");continue}if(v)try{const x=u.messages.slice(-2).map(N=>N.content);if(await ze(h,f,x,D)&&!await Oe(u.leadId)){const L={leadName:p,profileUrl:u.profileUrl,company:((Pe=u.profile)==null?void 0:Pe.company)??"Unknown",jobTitle:((De=u.profile)==null?void 0:De.jobTitle)??"Unknown",headline:((_e=u.profile)==null?void 0:_e.headline)??"Unknown",conversationHistory:u.messages.map(Ue=>`${Ue.speaker}: ${Ue.content}`).join(`
`),messageCount:u.messages.length,detectedAt:new Date().toISOString()};await Se(L),await xe(u.leadId,"AI positive lead detection"),G("leadsFound",1),i("SUCCESS",`ðŸ”¥ HOT LEAD: ${p} (AI detected)`,"Bot")}}catch(x){i("ERROR",`Lead webhook failed: ${oe(x)}`,"System")}let U;try{if(U=await Yt(E,m,u.messages,p,k,u.profile,O,w,se),G("tokensUsed",U.tokensUsed),i("ACTION",`AI Decision: ${U.shouldReply?"REPLY":"SKIP"} - ${U.reason} (${zt(O)})`,"Bot"),!U.shouldReply){i("INFO",`Skipping ${p}: ${U.reason}`,"Bot");continue}}catch(x){i("ERROR",`Reply Generation Failed: ${oe(x)}`,"System");continue}let W=U.reply;if(le){const x=await Qt(p,U.reply);if(!x.approved){i("INFO",`Reply to ${p} skipped by user`,"User");continue}W=x.reply}const Z=await Ie("div.msg-form__contenteditable[role='textbox']",6,400),q=await Ie("button.msg-form__send-button",6,400);if(Z&&q){const x={messageCount:u.messages.length,lastMessageQuestions:((Le=($e=u.messages[u.messages.length-1])==null?void 0:$e.content.match(/\?/g))==null?void 0:Le.length)??0},N=ct(W,x)?ut(W):null;if(N){i("ACTION",`Double-texting ${p} (${N.pattern})...`,"Bot"),await g(ue(N.firstMessage)),await de(Z,N.firstMessage),await g(800),q.hasAttribute("disabled")||(q.click(),await g(500));const L=ft(N.pattern);i("INFO",`Waiting ${Math.round(L/1e3)}s before second message...`,"Bot"),await g(L),await g(ue(N.secondMessage)),await de(Z,N.secondMessage),await g(800),q.hasAttribute("disabled")||(q.click(),await g(500)),G("repliesSent",1),u.messages.push({speaker:k,content:N.firstMessage,timestamp:Date.now()-L,type:"sent"},{speaker:k,content:N.secondMessage,timestamp:Date.now(),type:"sent"}),u.metadata.lastActivity=Date.now(),u.metadata.lastMessageFrom="me",u.metadata.totalMessages+=2,u.metadata.lastSyncedAt=Date.now(),await ie(u),i("SUCCESS",`Double-texted ${V(p,u.profile)} (${M})`,"Bot")}else{const L=ue(W);i("ACTION",`Typing reply to ${p} (waiting ${Math.round(L/1e3)}s)...`,"Bot"),await g(L),await de(Z,W),await g(800),q.hasAttribute("disabled")||(q.click(),await g(500)),(((Re=Z.textContent)==null?void 0:Re.trim().length)??0)===0?(G("repliesSent",1),u.messages.push({speaker:k,content:W,timestamp:Date.now(),type:"sent"}),u.metadata.lastActivity=Date.now(),u.metadata.lastMessageFrom="me",u.metadata.totalMessages++,u.metadata.lastSyncedAt=Date.now(),await ie(u),i("SUCCESS",`Sent reply to ${V(p,u.profile)} (${M})`,"Bot")):i("WARNING",`Message may not have sent to ${p}`,"System")}}else i("ERROR","Could not find chat input or send button","System");await Ce(r,l)}i("INFO","Batch finished. Sleeping...","System"),P&&!$&&(te=window.setTimeout(()=>he(e),Math.floor(Math.random()*(d-c+1)+c)))}chrome.runtime.onMessage.addListener((e,t,o)=>{var n,s,a;if(e.type==="PINGTEST"){o("Content script active!");return}if(e.type==="GET_STATUS"){o({running:P,paused:$,stats:Q,logs:X});return}if(e.type==="START_BOT"){if(P)o({status:"error",error:"Already running"});else{P=!0,$=!1,Q={chatsProcessed:0,repliesSent:0,leadsFound:0,startTime:Date.now(),tokensUsed:0,currentModel:""},le=((n=e.config)==null?void 0:n.replyPreviewEnabled)??!1,ce=((s=e.config)==null?void 0:s.blacklist)??[];const r=((a=e.config)==null?void 0:a.nChats)??10;i("INFO",`Bot started (Preview: ${le?"ON":"OFF"})`,"User"),he(r),o({status:"ok"})}return}if(e.type==="STOP_BOT"){P=!1,$=!1,te!==null&&clearTimeout(te),i("INFO","Bot stopped by user","User"),o({status:"stopped"});return}if(e.type==="PAUSEBOT"){P&&!$?($=!0,i("INFO","Bot paused by user","User"),o({status:"paused"})):o({status:"error",error:"Not running or already paused"});return}if(e.type==="RESUMEBOT"){P&&$?($=!1,i("INFO","Bot resumed by user","User"),o({status:"running"})):o({status:"error",error:"Not paused"});return}if(e.type==="APPROVEREPLY"){R&&(i("SUCCESS",`Reply to ${e.leadName} approved`,"User"),R({approved:!0,reply:e.reply}),R=null,chrome.storage.local.remove("pendingReply")),o({status:"ok"});return}if(e.type==="REJECTREPLY"){R&&(i("INFO",`Reply to ${e.leadName} rejected`,"User"),R({approved:!1,reply:""}),R=null,chrome.storage.local.remove("pendingReply")),o({status:"ok"});return}if(e.type==="CHECKUNREAD"){P&&!$&&i("INFO","Check unread triggered by background","System"),o({status:"ok"});return}})})();
